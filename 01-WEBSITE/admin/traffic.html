<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Traffic Analytics - Chris David Salon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="shared-nav.js"></script>
    <style>
        .pulse-green { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Shared Navigation -->
    <div id="admin-nav" data-page="traffic"></div>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Page Header -->
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Traffic Analytics</h1>
            <p class="text-gray-600">Real-time website visitor metrics from Google Analytics 4</p>
        </div>

        <!-- Data Source Banner -->
        <div id="dataSourceBanner" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-yellow-500 mr-3 mt-1"></i>
                <div>
                    <span class="font-semibold text-yellow-800">GA4 API Not Connected</span>
                    <p id="dataSourceMessage" class="text-yellow-700 text-sm mt-1">
                        Waiting for GA4 Property ID and Service Account credentials. Contact Chris for analytics.google.com access.
                    </p>
                </div>
            </div>
        </div>

        <!-- Traffic Over Time Chart -->
        <div class="bg-white rounded-xl shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">Traffic Over Time</h2>
                <div class="flex gap-2">
                    <button id="viewDaily" onclick="setTrafficView('daily')" class="px-3 py-1 rounded text-sm font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300">
                        Daily
                    </button>
                    <button id="viewMonthly" onclick="setTrafficView('monthly')" class="px-3 py-1 rounded text-sm font-semibold bg-indigo-600 text-white">
                        Month vs Month
                    </button>
                </div>
            </div>
            <div id="trafficChartContainer" class="h-64 flex items-center justify-center">
                <div class="text-center text-gray-500">
                    <i class="fas fa-chart-line text-4xl mb-2"></i>
                    <p>Traffic data will appear here once GA4 is connected</p>
                </div>
            </div>
            <div id="trafficChartWrapper" class="hidden" style="height: 250px;">
                <canvas id="trafficOverTimeChart"></canvas>
            </div>
            <!-- Month over Month Comparison (hidden by default) -->
            <div id="monthlyComparisonWrapper" class="hidden">
                <!-- Two separate charts side by side -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div class="bg-indigo-50 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-indigo-800 mb-2">Users by Month</h3>
                        <div style="height: 200px;">
                            <canvas id="monthUsersChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-green-800 mb-2">Sessions by Month</h3>
                        <div style="height: 200px;">
                            <canvas id="monthSessionsChart"></canvas>
                        </div>
                    </div>
                </div>
                <div id="monthlyStats" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-sm text-gray-500">This Month</div>
                        <div class="text-2xl font-bold text-indigo-600" id="thisMonthUsers">--</div>
                        <div class="text-xs text-gray-500">users</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-sm text-gray-500">Last Month</div>
                        <div class="text-2xl font-bold text-gray-600" id="lastMonthUsers">--</div>
                        <div class="text-xs text-gray-500">users</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-sm text-gray-500">Change</div>
                        <div class="text-2xl font-bold" id="monthChange">--%</div>
                        <div class="text-xs text-gray-500">vs last month</div>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="text-sm text-gray-500">Trend</div>
                        <div class="text-2xl font-bold" id="monthTrend">--</div>
                        <div class="text-xs text-gray-500">direction</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Metrics Grid -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500">Active Users (30d)</div>
                        <div class="text-3xl font-bold" id="activeUsers">--</div>
                    </div>
                    <div class="text-3xl text-blue-500"><i class="fas fa-users"></i></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500">Sessions</div>
                        <div class="text-3xl font-bold" id="sessions">--</div>
                    </div>
                    <div class="text-3xl text-green-500"><i class="fas fa-chart-bar"></i></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500">Page Views</div>
                        <div class="text-3xl font-bold" id="pageViews">--</div>
                    </div>
                    <div class="text-3xl text-purple-500"><i class="fas fa-eye"></i></div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500">Bounce Rate</div>
                        <div class="text-3xl font-bold" id="bounceRate">--%</div>
                    </div>
                    <div class="text-3xl text-yellow-500"><i class="fas fa-sign-out-alt"></i></div>
                </div>
            </div>

            <!-- NEW: Booking Clicks Counter -->
            <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow p-4 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-green-100">Booking Clicks (30d)</div>
                        <div class="text-3xl font-bold" id="bookingClicks">--</div>
                        <div class="text-xs text-green-200 mt-1" id="bookingConversion">--% conversion</div>
                    </div>
                    <div class="text-3xl text-green-200"><i class="fas fa-calendar-check"></i></div>
                </div>
            </div>
        </div>

        <!-- Conversion Events Section -->
        <div class="bg-gradient-to-r from-emerald-50 to-green-50 rounded-xl shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Conversion Events (30 Days)</h2>
                    <p class="text-sm text-gray-500">Track booking clicks, phone calls, and other conversion actions</p>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-500">Data Source:</span>
                    <span id="conversionDataSource" class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-semibold">GA4 Live</span>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                    <div class="text-3xl font-bold text-emerald-600" id="totalBookingClicks">--</div>
                    <div class="text-sm text-gray-600 mt-1">Booking Clicks</div>
                    <div class="text-xs text-gray-400">Book Now button</div>
                </div>
                <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                    <div class="text-3xl font-bold text-blue-600" id="totalPhoneClicks">--</div>
                    <div class="text-sm text-gray-600 mt-1">Phone Clicks</div>
                    <div class="text-xs text-gray-400">Call button taps</div>
                </div>
                <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                    <div class="text-3xl font-bold text-purple-600" id="totalFormSubmits">--</div>
                    <div class="text-sm text-gray-600 mt-1">Form Submissions</div>
                    <div class="text-xs text-gray-400">Contact forms</div>
                </div>
                <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                    <div class="text-3xl font-bold text-orange-600" id="totalConversions">--</div>
                    <div class="text-sm text-gray-600 mt-1">Total Conversions</div>
                    <div class="text-xs text-gray-400">All actions</div>
                </div>
            </div>
        </div>

        <!-- Search Console Data -->
        <div class="bg-white rounded-xl shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-lg font-bold">Google Search Performance</h2>
                    <p class="text-sm text-gray-500">How people find you in Google Search</p>
                </div>
                <a href="https://search.google.com/search-console/performance/search-analytics?resource_id=sc-domain%3Achrisdavidsalon.com"
                   target="_blank"
                   class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold text-sm flex items-center gap-2">
                    <i class="fas fa-external-link-alt"></i>
                    Open Search Console
                </a>
            </div>

            <!-- Search Console Metrics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <div class="text-sm text-blue-600 font-semibold">Avg Position</div>
                    <div class="text-3xl font-bold text-blue-800" id="scAvgPosition">--</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <div class="text-sm text-green-600 font-semibold">Total Clicks</div>
                    <div class="text-3xl font-bold text-green-800" id="scTotalClicks">--</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4 text-center">
                    <div class="text-sm text-purple-600 font-semibold">Impressions</div>
                    <div class="text-3xl font-bold text-purple-800" id="scImpressions">--</div>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                    <div class="text-sm text-yellow-600 font-semibold">Click Rate</div>
                    <div class="text-3xl font-bold text-yellow-800" id="scCTR">--%</div>
                </div>
            </div>

            <!-- Top Keywords -->
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-3">Top Keywords (by clicks)</h3>
                    <div id="scTopKeywords" class="space-y-2">
                        <div class="text-gray-400 text-center py-4">Loading keyword data...</div>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 mb-3">Opportunities (high impressions, low rank)</h3>
                    <div id="scOpportunities" class="space-y-2">
                        <div class="text-gray-400 text-center py-4">Loading opportunities...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- Traffic Sources -->
            <div class="bg-white rounded-xl shadow p-6">
                <h2 class="text-lg font-bold mb-4">Traffic Sources</h2>
                <div id="trafficSourcesContainer" class="h-64 flex items-center justify-center">
                    <div class="text-center text-gray-500">
                        <i class="fas fa-globe text-4xl mb-2"></i>
                        <p>Source data requires GA4 connection</p>
                    </div>
                </div>
                <div id="trafficSourcesWrapper" class="hidden" style="height: 200px;">
                    <canvas id="trafficSourcesChart"></canvas>
                </div>
                <div id="trafficSourcesList" class="mt-4 space-y-2 hidden"></div>
            </div>

            <!-- Device Breakdown -->
            <div class="bg-white rounded-xl shadow p-6">
                <h2 class="text-lg font-bold mb-4">Device Breakdown</h2>
                <div id="deviceContainer" class="h-64 flex items-center justify-center">
                    <div class="text-center text-gray-500">
                        <i class="fas fa-mobile-alt text-4xl mb-2"></i>
                        <p>Device data requires GA4 connection</p>
                    </div>
                </div>
                <div id="deviceChartWrapper" class="hidden" style="height: 200px;">
                    <canvas id="deviceChart"></canvas>
                </div>
                <div id="deviceStats" class="mt-4 grid grid-cols-3 gap-4 text-center hidden">
                    <div>
                        <div class="text-2xl font-bold" id="mobilePercent">--%</div>
                        <div class="text-sm text-gray-500">Mobile</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold" id="desktopPercent">--%</div>
                        <div class="text-sm text-gray-500">Desktop</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold" id="tabletPercent">--%</div>
                        <div class="text-sm text-gray-500">Tablet</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Landing Pages -->
        <div class="bg-white rounded-xl shadow p-6 mb-6">
            <h2 class="text-lg font-bold mb-4">Top Landing Pages</h2>
            <div id="landingPagesContainer">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-file-alt text-4xl mb-2"></i>
                    <p>Landing page data requires GA4 connection</p>
                </div>
            </div>
            <table id="landingPagesTable" class="w-full hidden">
                <thead>
                    <tr class="text-left text-gray-500 text-sm border-b">
                        <th class="pb-2">Page</th>
                        <th class="pb-2">Sessions</th>
                        <th class="pb-2">Bounce Rate</th>
                        <th class="pb-2">Avg Duration</th>
                    </tr>
                </thead>
                <tbody id="landingPagesBody"></tbody>
            </table>
        </div>

        <!-- Microsite Referrals -->
        <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6">
            <h2 class="text-lg font-bold mb-4 flex items-center">
                <i class="fas fa-external-link-alt text-green-500 mr-2"></i>
                Traffic From Microsites
            </h2>
            <div id="micrositeReferralsContainer">
                <div class="text-center text-gray-500 py-4">
                    <p>Microsite referral tracking requires GA4 connection</p>
                    <p class="text-sm mt-2">Will show traffic from: bestsalondelray.com, bestdelraysalon.com, bestsalonpalmbeach.com</p>
                </div>
            </div>
            <div id="micrositeReferrals" class="grid md:grid-cols-3 gap-4 hidden"></div>
        </div>
    </main>

    <script>
        // API Base URL - use production when running locally (serverless functions need Vercel)
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'https://www.chrisdavidsalon.com'
            : '';

        let trafficOverTimeChart, trafficSourcesChart, deviceChart;
        let monthUsersChart, monthSessionsChart;
        let currentView = 'monthly'; // Default to monthly view
        let dailyTrafficData = [];
        let monthlyComparisonData = null;

        // Toggle between daily and monthly views
        function setTrafficView(view) {
            currentView = view;
            const dailyBtn = document.getElementById('viewDaily');
            const monthlyBtn = document.getElementById('viewMonthly');
            const dailyWrapper = document.getElementById('trafficChartWrapper');
            const monthlyWrapper = document.getElementById('monthlyComparisonWrapper');

            if (view === 'daily') {
                dailyBtn.className = 'px-3 py-1 rounded text-sm font-semibold bg-indigo-600 text-white';
                monthlyBtn.className = 'px-3 py-1 rounded text-sm font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300';
                dailyWrapper.classList.remove('hidden');
                monthlyWrapper.classList.add('hidden');
            } else {
                dailyBtn.className = 'px-3 py-1 rounded text-sm font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300';
                monthlyBtn.className = 'px-3 py-1 rounded text-sm font-semibold bg-indigo-600 text-white';
                dailyWrapper.classList.add('hidden');
                monthlyWrapper.classList.remove('hidden');
                loadMonthlyComparison();
            }
        }

        // Load month-over-month comparison data
        async function loadMonthlyComparison() {
            if (monthlyComparisonData) {
                // Already loaded, just display
                displayMonthlyComparison(monthlyComparisonData);
                return;
            }

            try {
                // Get this month's data
                const now = new Date();
                const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
                const twoMonthsAgoStart = new Date(now.getFullYear(), now.getMonth() - 2, 1);
                const twoMonthsAgoEnd = new Date(now.getFullYear(), now.getMonth() - 1, 0);

                // Format dates for GA4 API
                const formatDate = (d) => d.toISOString().split('T')[0];

                // Fetch data for multiple months
                const [thisMonthResp, lastMonthResp, twoMonthsAgoResp] = await Promise.all([
                    fetch(`${API_BASE}/api/ga4-analytics?type=overview&startDate=${formatDate(thisMonthStart)}&endDate=${formatDate(now)}`),
                    fetch(`${API_BASE}/api/ga4-analytics?type=overview&startDate=${formatDate(lastMonthStart)}&endDate=${formatDate(lastMonthEnd)}`),
                    fetch(`${API_BASE}/api/ga4-analytics?type=overview&startDate=${formatDate(twoMonthsAgoStart)}&endDate=${formatDate(twoMonthsAgoEnd)}`)
                ]);

                const thisMonth = await thisMonthResp.json();
                const lastMonth = await lastMonthResp.json();
                const twoMonthsAgo = await twoMonthsAgoResp.json();

                // Get month names
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const thisMonthName = monthNames[now.getMonth()];
                const lastMonthName = monthNames[(now.getMonth() - 1 + 12) % 12];
                const twoMonthsAgoName = monthNames[(now.getMonth() - 2 + 12) % 12];

                monthlyComparisonData = {
                    months: [twoMonthsAgoName, lastMonthName, thisMonthName],
                    users: [
                        twoMonthsAgo.success ? twoMonthsAgo.data.activeUsers : 0,
                        lastMonth.success ? lastMonth.data.activeUsers : 0,
                        thisMonth.success ? thisMonth.data.activeUsers : 0
                    ],
                    sessions: [
                        twoMonthsAgo.success ? twoMonthsAgo.data.sessions : 0,
                        lastMonth.success ? lastMonth.data.sessions : 0,
                        thisMonth.success ? thisMonth.data.sessions : 0
                    ],
                    thisMonth: thisMonth.success ? thisMonth.data : null,
                    lastMonth: lastMonth.success ? lastMonth.data : null
                };

                displayMonthlyComparison(monthlyComparisonData);
            } catch (e) {
                console.error('Monthly comparison error:', e);
            }
        }

        function displayMonthlyComparison(data) {
            // Destroy existing charts if any
            if (monthUsersChart) monthUsersChart.destroy();
            if (monthSessionsChart) monthSessionsChart.destroy();

            // Calculate days in current month so far
            const now = new Date();
            const daysInCurrentMonth = now.getDate();
            const daysInLastMonth = new Date(now.getFullYear(), now.getMonth(), 0).getDate();
            const isPartialMonth = daysInCurrentMonth < daysInLastMonth / 2; // Less than half the month

            // For fair comparison, normalize partial month data
            // Project current month based on daily average
            let projectedThisMonthUsers = data.users[2] || 0;
            let projectedThisMonthSessions = data.sessions[2] || 0;
            let comparisonNote = '';

            if (isPartialMonth && daysInCurrentMonth > 0) {
                // Calculate daily average and project to full month
                const dailyAvgUsers = data.users[2] / daysInCurrentMonth;
                const dailyAvgSessions = data.sessions[2] / daysInCurrentMonth;
                projectedThisMonthUsers = Math.round(dailyAvgUsers * daysInLastMonth);
                projectedThisMonthSessions = Math.round(dailyAvgSessions * daysInLastMonth);
                comparisonNote = `(projected from ${daysInCurrentMonth} days)`;
            }

            // Use projected values for comparison but show actual in chart
            const chartUsers = [...data.users];
            const chartSessions = [...data.sessions];

            // Users Chart (left side - indigo/blue)
            const usersCanvas = document.getElementById('monthUsersChart');
            monthUsersChart = new Chart(usersCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: data.months.map((m, i) => i === 2 && isPartialMonth ? `${m}*` : m),
                    datasets: [{
                        label: 'Users',
                        data: chartUsers,
                        backgroundColor: ['rgba(79, 70, 229, 0.5)', 'rgba(79, 70, 229, 0.7)', 'rgba(79, 70, 229, 1)'],
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Sessions Chart (right side - green)
            const sessionsCanvas = document.getElementById('monthSessionsChart');
            monthSessionsChart = new Chart(sessionsCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: data.months.map((m, i) => i === 2 && isPartialMonth ? `${m}*` : m),
                    datasets: [{
                        label: 'Sessions',
                        data: chartSessions,
                        backgroundColor: ['rgba(16, 185, 129, 0.5)', 'rgba(16, 185, 129, 0.7)', 'rgba(16, 185, 129, 1)'],
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Update stats - show actual data
            const thisMonthUsers = data.users[2] || 0;
            const lastMonthUsers = data.users[1] || 0;

            document.getElementById('thisMonthUsers').textContent = thisMonthUsers.toLocaleString();
            document.getElementById('lastMonthUsers').textContent = lastMonthUsers.toLocaleString();

            // For trend calculation, use SAME-PERIOD comparison (first X days of each month)
            // This is the FAIR comparison: Dec 1-4 vs Nov 1-4, not Dec 1-4 vs Nov 1-30
            const changeEl = document.getElementById('monthChange');
            const trendEl = document.getElementById('monthTrend');

            if (isPartialMonth) {
                // Show projected comparison instead
                if (projectedThisMonthUsers > 0 && lastMonthUsers > 0) {
                    const projectedChange = ((projectedThisMonthUsers - lastMonthUsers) / lastMonthUsers * 100).toFixed(1);
                    changeEl.textContent = (projectedChange >= 0 ? '+' : '') + projectedChange + '%';
                    changeEl.className = 'text-2xl font-bold ' + (projectedChange >= 0 ? 'text-green-600' : 'text-red-600');

                    // Update trend label to indicate it's projected
                    trendEl.innerHTML = `<span class="text-sm text-gray-500">Projected: ${projectedThisMonthUsers}</span>`;
                    trendEl.className = 'text-sm font-normal text-gray-500';
                } else {
                    changeEl.textContent = 'N/A';
                    changeEl.className = 'text-2xl font-bold text-gray-400';
                    trendEl.textContent = `Only ${daysInCurrentMonth} days of data`;
                    trendEl.className = 'text-sm font-normal text-gray-500';
                }
            } else if (lastMonthUsers > 0) {
                // Full month - use actual comparison
                const change = ((thisMonthUsers - lastMonthUsers) / lastMonthUsers * 100).toFixed(1);
                changeEl.textContent = (change >= 0 ? '+' : '') + change + '%';
                changeEl.className = 'text-2xl font-bold ' + (change >= 0 ? 'text-green-600' : 'text-red-600');

                if (change > 10) {
                    trendEl.textContent = 'ðŸ“ˆ Growing';
                    trendEl.className = 'text-2xl font-bold text-green-600';
                } else if (change < -10) {
                    trendEl.textContent = 'ðŸ“‰ Declining';
                    trendEl.className = 'text-2xl font-bold text-red-600';
                } else {
                    trendEl.textContent = 'âž¡ï¸ Stable';
                    trendEl.className = 'text-2xl font-bold text-yellow-600';
                }
            }
        }

        async function loadTrafficData() {
            // Load version first
            try {
                const versionResp = await fetch(`${API_BASE}/data/version.json`);
                const versionData = await versionResp.json();
                document.getElementById('versionBadge').textContent = 'v' + versionData.version;
            } catch (e) {
                document.getElementById('versionBadge').textContent = 'v?.?.?';
            }

            document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();

            // Try to load from GA4 API
            try {
                const response = await fetch(`${API_BASE}/api/ga4-analytics?type=overview&startDate=30daysAgo&endDate=today`);
                const result = await response.json();

                if (result.success) {
                    // GA4 IS CONNECTED - Show real data
                    showConnectedState();
                    updateOverviewMetrics(result.data);

                    // Load additional data
                    await Promise.all([
                        loadTrafficOverTime(),
                        loadTrafficSources(),
                        loadDeviceBreakdown(),
                        loadTopPages(),
                        loadMicrositeReferrals(),
                        loadConversionEvents()
                    ]);
                } else {
                    // GA4 NOT CONNECTED - Show instructions
                    showDisconnectedState(result.message || result.error);
                }
            } catch (error) {
                console.error('GA4 API Error:', error);
                showDisconnectedState('Could not connect to analytics API: ' + error.message);
            }
        }

        function showConnectedState() {
            const banner = document.getElementById('dataSourceBanner');
            banner.className = 'bg-green-50 border border-green-200 rounded-lg p-4 mb-6';
            banner.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-500 mr-3"></i>
                    <div>
                        <span class="font-semibold text-green-800">LIVE DATA from Google Analytics 4</span>
                        <p class="text-green-700 text-sm">Real-time data from GA4 API. Auto-refreshes every 5 minutes.</p>
                    </div>
                </div>
            `;
        }

        function showDisconnectedState(message) {
            const banner = document.getElementById('dataSourceBanner');
            banner.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6';
            banner.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mr-3 mt-1"></i>
                    <div>
                        <span class="font-semibold text-yellow-800">GA4 API Not Connected</span>
                        <p class="text-yellow-700 text-sm mt-1">${message}</p>
                        <p class="text-yellow-600 text-xs mt-2">Need: GA4_PROPERTY_ID and GOOGLE_SERVICE_ACCOUNT_JSON in Vercel env vars</p>
                    </div>
                </div>
            `;
        }

        function updateOverviewMetrics(data) {
            document.getElementById('activeUsers').textContent = data.activeUsers?.toLocaleString() || '--';
            document.getElementById('sessions').textContent = data.sessions?.toLocaleString() || '--';
            document.getElementById('pageViews').textContent = data.pageViews?.toLocaleString() || '--';
            document.getElementById('bounceRate').textContent = data.bounceRate ? data.bounceRate + '%' : '--%';
        }

        async function loadTrafficOverTime() {
            try {
                const response = await fetch(`${API_BASE}/api/ga4-analytics?type=traffic-over-time&startDate=30daysAgo&endDate=today`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    document.getElementById('trafficChartContainer').classList.add('hidden');
                    document.getElementById('trafficChartWrapper').classList.remove('hidden');
                    const canvas = document.getElementById('trafficOverTimeChart');

                    const labels = result.data.map(d => {
                        const date = d.date;
                        return date.substring(4, 6) + '/' + date.substring(6, 8);
                    });
                    const users = result.data.map(d => d.users);

                    trafficOverTimeChart = new Chart(canvas.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Users',
                                data: users,
                                borderColor: '#4f46e5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('Traffic over time error:', e);
            }
        }

        async function loadTrafficSources() {
            try {
                const response = await fetch(`${API_BASE}/api/ga4-analytics?type=traffic-sources&startDate=30daysAgo&endDate=today`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    document.getElementById('trafficSourcesContainer').classList.add('hidden');
                    document.getElementById('trafficSourcesWrapper').classList.remove('hidden');
                    document.getElementById('trafficSourcesList').classList.remove('hidden');
                    const canvas = document.getElementById('trafficSourcesChart');

                    const topSources = result.data.slice(0, 5);
                    const labels = topSources.map(s => s.source + ' / ' + s.medium);
                    const data = topSources.map(s => s.sessions);
                    const colors = ['#4f46e5', '#06b6d4', '#f59e0b', '#10b981', '#ef4444'];

                    trafficSourcesChart = new Chart(canvas.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: colors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });

                    document.getElementById('trafficSourcesList').innerHTML = topSources.map((s, i) => `
                        <div class="flex justify-between items-center py-2 border-b">
                            <span class="flex items-center">
                                <span class="w-3 h-3 rounded mr-2" style="background-color: ${colors[i]}"></span>
                                ${s.source} / ${s.medium}
                            </span>
                            <span class="font-semibold">${s.percentage}%</span>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Traffic sources error:', e);
            }
        }

        async function loadDeviceBreakdown() {
            try {
                const response = await fetch(`${API_BASE}/api/ga4-analytics?type=devices&startDate=30daysAgo&endDate=today`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    document.getElementById('deviceContainer').classList.add('hidden');
                    document.getElementById('deviceChartWrapper').classList.remove('hidden');
                    document.getElementById('deviceStats').classList.remove('hidden');
                    const canvas = document.getElementById('deviceChart');

                    const labels = result.data.map(d => d.device);
                    const data = result.data.map(d => d.users);
                    const colors = ['#8b5cf6', '#3b82f6', '#ec4899'];

                    deviceChart = new Chart(canvas.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: colors
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });

                    result.data.forEach(d => {
                        const deviceType = d.device.toLowerCase();
                        if (deviceType === 'mobile') {
                            document.getElementById('mobilePercent').textContent = d.percentage + '%';
                        } else if (deviceType === 'desktop') {
                            document.getElementById('desktopPercent').textContent = d.percentage + '%';
                        } else if (deviceType === 'tablet') {
                            document.getElementById('tabletPercent').textContent = d.percentage + '%';
                        }
                    });
                }
            } catch (e) {
                console.error('Device breakdown error:', e);
            }
        }

        async function loadTopPages() {
            try {
                const response = await fetch(`${API_BASE}/api/ga4-analytics?type=top-pages&startDate=30daysAgo&endDate=today`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    document.getElementById('landingPagesContainer').classList.add('hidden');
                    document.getElementById('landingPagesTable').classList.remove('hidden');

                    document.getElementById('landingPagesBody').innerHTML = result.data.slice(0, 10).map(p => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 font-medium">${p.page}</td>
                            <td class="py-3">${p.sessions}</td>
                            <td class="py-3">${p.bounceRate}%</td>
                            <td class="py-3">${Math.round(p.avgDuration)}s</td>
                        </tr>
                    `).join('');
                }
            } catch (e) {
                console.error('Top pages error:', e);
            }
        }

        // NEW: Load Conversion Events (Booking Clicks, Phone Clicks, etc.)
        async function loadConversionEvents() {
            try {
                const response = await fetch(`${API_BASE}/api/ga4-analytics?type=events`);
                const result = await response.json();

                if (result.success && result.data) {
                    // Find specific events
                    const bookingClicks = result.data.find(e => e.eventName === 'booking_click')?.count || 0;
                    const phoneClicks = result.data.find(e => e.eventName === 'phone_click')?.count ||
                                       result.data.find(e => e.eventName === 'click' && e.eventName.includes('phone'))?.count || 0;
                    const formSubmits = result.data.find(e => e.eventName === 'form_submit')?.count || 0;
                    const allClicks = result.data.find(e => e.eventName === 'click')?.count || 0;

                    // Calculate total conversions (booking + phone + form)
                    const totalConversions = bookingClicks + phoneClicks + formSubmits;

                    // Get active users for conversion rate calculation
                    const activeUsers = parseInt(document.getElementById('activeUsers').textContent.replace(/,/g, '')) || 0;
                    const conversionRate = activeUsers > 0 ? ((totalConversions / activeUsers) * 100).toFixed(1) : 0;

                    // Update the main booking clicks counter
                    document.getElementById('bookingClicks').textContent = bookingClicks.toLocaleString();
                    document.getElementById('bookingConversion').textContent = `${conversionRate}% conversion`;

                    // Update the detailed conversion section
                    document.getElementById('totalBookingClicks').textContent = bookingClicks.toLocaleString();
                    document.getElementById('totalPhoneClicks').textContent = phoneClicks.toLocaleString();
                    document.getElementById('totalFormSubmits').textContent = formSubmits.toLocaleString();
                    document.getElementById('totalConversions').textContent = totalConversions.toLocaleString();

                    // Update data source badge
                    document.getElementById('conversionDataSource').textContent = result.isLiveData ? 'GA4 Live' : 'Cached';
                    document.getElementById('conversionDataSource').className = result.isLiveData
                        ? 'bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-semibold'
                        : 'bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-semibold';

                    console.log('Conversion events loaded:', { bookingClicks, phoneClicks, formSubmits, totalConversions, conversionRate });
                }
            } catch (e) {
                console.error('Conversion events error:', e);
                // Show error state
                document.getElementById('conversionDataSource').textContent = 'Error';
                document.getElementById('conversionDataSource').className = 'bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-semibold';
            }
        }

        async function loadMicrositeReferrals() {
            try {
                const response = await fetch(`${API_BASE}/api/ga4-analytics?type=microsite-referrals&startDate=30daysAgo&endDate=today`);
                const result = await response.json();

                if (result.success) {
                    document.getElementById('micrositeReferralsContainer').classList.add('hidden');
                    const container = document.getElementById('micrositeReferrals');
                    container.classList.remove('hidden');

                    const sites = ['bestsalondelray.com', 'bestdelraysalon.com', 'bestsalonpalmbeach.com'];
                    container.innerHTML = sites.map(site => {
                        const data = result.microsites[site] || { totalSessions: 0, totalUsers: 0 };
                        return `
                            <div class="bg-white rounded-lg p-4 shadow">
                                <h3 class="font-bold text-sm">${site}</h3>
                                <div class="mt-2 grid grid-cols-2 gap-2 text-center">
                                    <div>
                                        <div class="text-2xl font-bold text-green-600">${data.totalSessions}</div>
                                        <div class="text-xs text-gray-500">Sessions</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-blue-600">${data.totalUsers}</div>
                                        <div class="text-xs text-gray-500">Users</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Add total
                    container.innerHTML += `
                        <div class="md:col-span-3 bg-gradient-to-r from-green-100 to-blue-100 rounded-lg p-4 mt-4">
                            <div class="flex justify-between items-center">
                                <span class="font-bold">Total from all microsites:</span>
                                <span class="text-xl font-bold text-green-700">
                                    ${result.totalFromMicrosites.sessions} sessions / ${result.totalFromMicrosites.users} users
                                </span>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Microsite referrals error:', e);
            }
        }

        // Load Search Console data
        async function loadSearchConsoleData() {
            try {
                const response = await fetch(`${API_BASE}/api/ga4-analytics?type=search-rankings`);
                const result = await response.json();

                if (result.success) {
                    // Update metrics
                    document.getElementById('scAvgPosition').textContent = result.summary.averagePosition;
                    document.getElementById('scTotalClicks').textContent = result.summary.totalClicks.toLocaleString();
                    document.getElementById('scImpressions').textContent = result.summary.totalImpressions.toLocaleString();
                    document.getElementById('scCTR').textContent = result.summary.averageCTR + '%';

                    // Top keywords
                    const topKeywords = result.topKeywords.slice(0, 8);
                    document.getElementById('scTopKeywords').innerHTML = topKeywords.map(k => `
                        <div class="flex justify-between items-center py-2 px-3 bg-gray-50 rounded">
                            <span class="text-sm text-gray-700 truncate" style="max-width: 55%">${k.keyword}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-500">${k.clicks} clicks</span>
                                <span class="text-xs font-semibold px-2 py-1 rounded ${
                                    parseFloat(k.position) <= 10 ? 'bg-green-100 text-green-700' :
                                    parseFloat(k.position) <= 20 ? 'bg-yellow-100 text-yellow-700' :
                                    'bg-red-100 text-red-700'
                                }">#${k.position}</span>
                            </div>
                        </div>
                    `).join('');

                    // Opportunities
                    if (result.opportunities && result.opportunities.length > 0) {
                        document.getElementById('scOpportunities').innerHTML = result.opportunities.map(k => `
                            <div class="flex justify-between items-center py-2 px-3 bg-orange-50 rounded border border-orange-200">
                                <span class="text-sm text-gray-700 truncate" style="max-width: 55%">${k.keyword}</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-orange-600">${k.impressions} impressions</span>
                                    <span class="text-xs font-semibold px-2 py-1 rounded bg-orange-100 text-orange-700">#${k.position}</span>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        document.getElementById('scOpportunities').innerHTML = `
                            <div class="text-green-600 text-center py-4">
                                <i class="fas fa-check-circle mr-2"></i>No major opportunities found - rankings are solid!
                            </div>
                        `;
                    }
                } else {
                    document.getElementById('scAvgPosition').textContent = '--';
                    document.getElementById('scTotalClicks').textContent = '--';
                    document.getElementById('scImpressions').textContent = '--';
                    document.getElementById('scCTR').textContent = '--%';
                    document.getElementById('scTopKeywords').innerHTML = `
                        <div class="text-red-500 text-center py-4 text-sm">${result.error || 'Unable to load Search Console data'}</div>
                    `;
                    document.getElementById('scOpportunities').innerHTML = `
                        <div class="text-gray-400 text-center py-4 text-sm">${result.suggestion || 'Check Search Console access'}</div>
                    `;
                }
            } catch (error) {
                console.error('Search Console error:', error);
                document.getElementById('scTopKeywords').innerHTML = `
                    <div class="text-red-500 text-center py-4 text-sm">Failed to connect to API</div>
                `;
            }
        }

        // Load on page load
        loadTrafficData();
        loadSearchConsoleData();

        // Default to monthly view (after a small delay to ensure UI is ready)
        setTimeout(() => setTrafficView('monthly'), 100);

        // Auto-refresh every 5 minutes
        setInterval(loadTrafficData, 300000);
        setInterval(loadSearchConsoleData, 300000);
    </script>
</body>
</html>
