<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SEO Dashboard - Chris David Salon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="ai-config.js"></script>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-purple-900 to-indigo-900 text-white p-4 shadow-lg">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-2xl font-bold">SEO Dashboard</h1>
                    <p class="text-sm text-purple-200">Composite SEO Score - All 7 Ranking Factors</p>
                </div>
                <div class="flex items-center gap-4">
                    <span id="versionBadge" class="bg-green-600 px-3 py-1 rounded text-sm font-bold">v2.6.12</span>
                    <a href="../index.html" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded text-sm font-semibold">
                        ‚Üê Back to Main Site
                    </a>
                    <a href="login.html" onclick="localStorage.clear(); return true;" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded text-sm font-semibold">
                        Logout
                    </a>
                </div>
            </div>
            
            <!-- Navigation Menu -->
            <div class="flex space-x-1 pb-2 overflow-x-auto">
                <a href="index.html" class="px-4 py-2 bg-white/20 rounded-t font-semibold">Dashboard</a>
                <a href="improvement-planner.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Improvement Plan</a>
                <a href="traffic.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Traffic</a>
                <a href="authority.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Authority</a>
                <a href="microsites.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Microsites</a>
                <a href="rankings.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Rankings</a>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6">
        
        <!-- Master Control Panel -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg shadow-xl p-6 mb-6">
            <h2 class="text-3xl font-bold mb-4">üéØ SEO Command Center</h2>
            <p class="text-blue-100 mb-6">
                Analyze your site with AI to get a comprehensive SEO score (0-100) with detailed breakdown and actionable improvements.
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Your Site Analysis -->
                <div class="bg-white/20 backdrop-blur-sm p-6 rounded-lg">
                    <h3 class="font-bold text-xl mb-4">Your Site Score</h3>
                    <div class="flex items-center gap-6">
                        <div id="yourScore" class="text-6xl font-bold">--</div>
                        <button type="button" onclick="toggleScoreBreakdown()" class="bg-yellow-400 hover:bg-yellow-300 text-blue-900 px-6 py-3 rounded-lg font-bold text-lg shadow-lg transform hover:scale-105 transition-all">
                            <i class="fas fa-list-ul mr-2"></i>See Details
                        </button>
                    </div>
                    <button type="button" onclick="analyzeMySite()" class="bg-white text-blue-600 px-6 py-3 rounded-lg hover:bg-blue-50 w-full font-bold transition-all mt-4">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh Score
                    </button>
                    <p class="text-xs mt-2 text-blue-100">Uses Google PageSpeed + Places APIs</p>
                </div>

                <!-- Last Analysis -->
                <div class="bg-white/20 backdrop-blur-sm p-6 rounded-lg">
                    <h3 class="font-bold text-xl mb-4">Last Updated</h3>
                    <div id="lastAnalysis" class="text-lg mb-4">Never</div>
                    <div id="scoreChange" class="text-3xl font-bold">--</div>
                    <p class="text-sm mt-2">Change from previous</p>
                </div>
            </div>
        </div>

        <!-- 7-Category SEO Breakdown - COLLAPSED BY DEFAULT -->
        <div id="scoreBreakdownSection" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">üìä SEO Score Breakdown (7 Categories)</h3>
                <button type="button" onclick="toggleScoreBreakdown()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i> Close
                </button>
            </div>
            
            <div id="loadingIndicator" class="hidden text-center py-12">
                <i class="fas fa-spinner fa-spin text-5xl text-blue-600 mb-4"></i>
                <p class="text-xl text-gray-600">Analyzing your site with AI...</p>
                <p class="text-sm text-gray-500 mt-2">This comprehensive analysis takes 15-30 seconds</p>
            </div>
            
            <!-- SUMMARY BOX - FIRST AND PROMINENT -->
            <div class="bg-gradient-to-br from-indigo-600 to-purple-700 text-white p-8 rounded-xl shadow-xl mb-6 border-4 border-indigo-400">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="font-bold text-2xl">üìä Overall SEO Score</h4>
                            <span class="relative group cursor-help">
                                <i class="fas fa-info-circle text-indigo-300 hover:text-white"></i>
                                <div class="absolute left-0 bottom-full mb-2 hidden group-hover:block w-72 p-3 bg-gray-900 text-white text-sm rounded-lg shadow-xl z-50">
                                    <strong>What is this score?</strong><br>
                                    This is your <em>combined website health score</em> - a weighted average of 7 different factors:<br><br>
                                    ‚Ä¢ Performance, Technical, Mobile, Content, Local SEO, UX, and Authority<br><br>
                                    <strong>Why is it different from Local SEO?</strong><br>
                                    Your Local SEO score (91) measures just Google reviews & rating. The Overall score (73) averages ALL areas, including weaker ones like Authority (29).
                                </div>
                            </span>
                        </div>
                        <div class="text-xs text-indigo-200 font-semibold mb-4">Weighted average of all 7 categories below</div>
                        <div id="totalScore" class="text-7xl font-bold text-white mb-4">--</div>
                        <button type="button" onclick="analyzeMySite()" class="bg-yellow-400 hover:bg-yellow-300 text-indigo-900 px-6 py-3 rounded-lg font-bold text-lg shadow-lg transform hover:scale-105 transition-all mb-4">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Score
                        </button>
                        <div class="text-sm text-indigo-200 space-y-1">
                            <div>Performance (20%) + Technical (15%) + Mobile (15%)</div>
                            <div>+ Content (15%) + Local (15%) + UX (10%) + Authority (10%)</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-center">
                        <canvas id="scoreChart" width="280" height="280"></canvas>
                    </div>
                </div>
            </div>

            <!-- EXPLANATION BANNER -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-start gap-3">
                    <i class="fas fa-lightbulb text-blue-500 text-xl mt-1"></i>
                    <div class="text-sm text-blue-800">
                        <strong>Understanding Your Scores:</strong> The large number above (Overall Score) is your combined website health.
                        The 7 colored boxes below show individual category scores. Your <strong>Local SEO</strong> score (91) is high because you have great Google reviews,
                        but your <strong>Overall</strong> score (73) is pulled down by areas like Authority (29) that need work.
                    </div>
                </div>
            </div>

            <div id="scoreBreakdown" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- SORTED BY WEIGHT: Performance 20%, Technical 15%, Mobile 15%, Content 15%, Local 15%, UX 10%, Authority 10% -->

                <!-- Performance - 20% weight -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg border-2 border-blue-200">
                    <div class="flex items-center justify-between mb-1">
                        <h4 class="font-bold text-lg text-blue-800">‚ö° Performance</h4>
                        <span id="performanceScore" class="text-3xl font-bold text-blue-600">--</span>
                    </div>
                    <div class="text-xs text-blue-500 font-semibold mb-3">20% of total score</div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Page Speed:</span>
                            <span id="pageSpeed" class="font-semibold">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Load Time:</span>
                            <span id="loadTime" class="font-semibold">--</span>
                        </div>
                        <div id="performanceIssues" class="mt-3 text-xs text-gray-600"></div>
                    </div>
                </div>

                <!-- Technical SEO - 15% weight -->
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-lg border-2 border-purple-200">
                    <div class="flex items-center justify-between mb-1">
                        <h4 class="font-bold text-lg text-purple-800">üîß Technical</h4>
                        <span id="technicalScore" class="text-3xl font-bold text-purple-600">--</span>
                    </div>
                    <div class="text-xs text-purple-500 font-semibold mb-3">15% of total score</div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Meta Tags:</span>
                            <span id="metaTags" class="font-semibold">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Schema:</span>
                            <span id="schema" class="font-semibold">--</span>
                        </div>
                        <div id="technicalIssues" class="mt-3 text-xs text-gray-600"></div>
                    </div>
                </div>

                <!-- Mobile Optimization - 15% weight -->
                <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-lg border-2 border-orange-200">
                    <div class="flex items-center justify-between mb-1">
                        <h4 class="font-bold text-lg text-orange-800">üì± Mobile</h4>
                        <span id="mobileScore" class="text-3xl font-bold text-orange-600">--</span>
                    </div>
                    <div class="text-xs text-orange-500 font-semibold mb-3">15% of total score</div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Responsive:</span>
                            <span id="responsive" class="font-semibold">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Usability:</span>
                            <span id="mobileUsability" class="font-semibold">--</span>
                        </div>
                        <div id="mobileIssues" class="mt-3 text-xs text-gray-600"></div>
                    </div>
                </div>

                <!-- Content Quality - 15% weight -->
                <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-lg border-2 border-green-200">
                    <div class="flex items-center justify-between mb-1">
                        <h4 class="font-bold text-lg text-green-800">üìù Content</h4>
                        <span id="contentScore" class="text-3xl font-bold text-green-600">--</span>
                    </div>
                    <div class="text-xs text-green-500 font-semibold mb-3">15% of total score</div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Keywords:</span>
                            <span id="keywordUsage" class="font-semibold">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Quality:</span>
                            <span id="contentQuality" class="font-semibold">--</span>
                        </div>
                        <div id="contentIssues" class="mt-3 text-xs text-gray-600"></div>
                    </div>
                </div>

                <!-- Local SEO - 15% weight -->
                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-lg border-2 border-yellow-200">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-1">
                            <h4 class="font-bold text-lg text-yellow-800">üìç Local</h4>
                            <span class="relative group cursor-help">
                                <i class="fas fa-info-circle text-yellow-500 text-sm"></i>
                                <div class="absolute left-0 bottom-full mb-2 hidden group-hover:block w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    <strong>Local SEO Score</strong><br>
                                    Based on your Google Business Profile:<br>
                                    ‚Ä¢ Rating (4.9‚òÖ) + Review count (140+)<br><br>
                                    This is one of your strongest areas! It only counts for 15% of the Overall score.
                                </div>
                            </span>
                        </div>
                        <span id="localScore" class="text-3xl font-bold text-yellow-600">--</span>
                    </div>
                    <div class="text-xs text-yellow-600 font-semibold mb-3">15% of total score</div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>GMB:</span>
                            <span id="gmb" class="font-semibold">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Citations:</span>
                            <span id="citations" class="font-semibold">--</span>
                        </div>
                        <div id="localIssues" class="mt-3 text-xs text-gray-600"></div>
                    </div>
                </div>

                <!-- User Experience - 10% weight -->
                <div class="bg-gradient-to-br from-pink-50 to-pink-100 p-6 rounded-lg border-2 border-pink-200">
                    <div class="flex items-center justify-between mb-1">
                        <h4 class="font-bold text-lg text-pink-800">üé® UX</h4>
                        <span id="uxScore" class="text-3xl font-bold text-pink-600">--</span>
                    </div>
                    <div class="text-xs text-pink-500 font-semibold mb-3">10% of total score</div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Navigation:</span>
                            <span id="navigation" class="font-semibold">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Design:</span>
                            <span id="design" class="font-semibold">--</span>
                        </div>
                        <div id="uxIssues" class="mt-3 text-xs text-gray-600"></div>
                    </div>
                </div>

                <!-- Authority - 10% weight -->
                <div class="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-lg border-2 border-red-200">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-1">
                            <h4 class="font-bold text-lg text-red-800">üèÜ Authority</h4>
                            <span class="relative group cursor-help">
                                <i class="fas fa-info-circle text-red-400 text-sm"></i>
                                <div class="absolute right-0 bottom-full mb-2 hidden group-hover:block w-64 p-3 bg-gray-900 text-white text-xs rounded-lg shadow-xl z-50">
                                    <strong>Domain Authority Score</strong><br>
                                    Based on backlinks and PageRank - how trusted your site is by other websites.<br><br>
                                    <strong>Why is this low?</strong><br>
                                    Most local salons score 20-40 here. Building authority takes years. Focus on getting quality backlinks from local press.
                                </div>
                            </span>
                        </div>
                        <span id="authorityScore" class="text-3xl font-bold text-red-600">--</span>
                    </div>
                    <div class="text-xs text-red-500 font-semibold mb-3">10% of total score</div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>Backlinks:</span>
                            <span id="backlinks" class="font-semibold">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Trust:</span>
                            <span id="trust" class="font-semibold">--</span>
                        </div>
                        <div id="authorityIssues" class="mt-3 text-xs text-gray-600"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TWO TYPES OF RANKINGS -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

            <!-- LOCAL RANKINGS (Google Maps) -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center gap-2 mb-2">
                    <h3 class="text-xl font-bold">üìç Local Rankings</h3>
                    <span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded font-semibold">Google Maps</span>
                </div>
                <p class="text-sm text-gray-600 mb-4">
                    "Hair salon near me" searches. <strong>Reviews dominate</strong> - hard to win as solo practitioner.
                </p>

                <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-orange-100">Your Position</div>
                            <div class="text-4xl font-bold">#<span id="competitorRank">--</span></div>
                            <div class="text-sm text-orange-100">of <span id="totalCompetitorCount">--</span> salons</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-orange-100">Gap to #1</div>
                            <div class="text-xl font-bold"><span id="reviewGap">--</span> reviews</div>
                            <div class="text-xs text-orange-100">behind <span id="leaderName">--</span></div>
                        </div>
                    </div>
                </div>

                <div class="text-sm text-gray-600 bg-orange-50 p-3 rounded">
                    <strong>Reality check:</strong> Rov√© has 1,514 reviews. As a solo practitioner, Chris can't match their volume. <strong>Focus on organic rankings instead.</strong>
                </div>
            </div>

            <!-- ORGANIC RANKINGS (Website SEO) -->
            <div class="bg-white rounded-lg shadow-lg p-6 border-2 border-green-300">
                <div class="flex items-center gap-2 mb-2">
                    <h3 class="text-xl font-bold">üéØ Organic Rankings</h3>
                    <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded font-semibold">YOUR OPPORTUNITY</span>
                </div>
                <p class="text-sm text-gray-600 mb-4">
                    Specific service searches. <strong>SEO & content matter</strong> - winnable for specialists.
                </p>

                <div class="bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-lg p-4 mb-4">
                    <div class="text-sm text-green-100 mb-1">Target Keywords to Dominate</div>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center">
                            <span>"color correction delray beach"</span>
                            <span class="bg-white/20 px-2 py-0.5 rounded text-xs">Check rank ‚Üí</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>"balayage specialist palm beach"</span>
                            <span class="bg-white/20 px-2 py-0.5 rounded text-xs">Check rank ‚Üí</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>"davines salon florida"</span>
                            <span class="bg-white/20 px-2 py-0.5 rounded text-xs">Check rank ‚Üí</span>
                        </div>
                    </div>
                </div>

                <a href="rankings.html" class="block w-full bg-green-600 hover:bg-green-700 text-white text-center px-4 py-3 rounded font-semibold">
                    View Keyword Rankings ‚Üí
                </a>
            </div>
        </div>

        <!-- COMPETITOR TABLE (Collapsed by default) -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2 cursor-pointer" onclick="toggleCompetitorTable()">
                    <h3 class="text-xl font-bold">üìä Full Competitor Comparison</h3>
                    <span id="competitorToggleIcon" class="text-gray-400">‚ñº</span>
                </div>
                <a href="improvement-planner.html" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold text-sm">
                    View Improvement Plan ‚Üí
                </a>
            </div>

            <!-- Competitor Table (toggleable) -->
            <div id="competitorTableSection">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-100 text-left">
                                <th class="px-3 py-2">Rank</th>
                                <th class="px-3 py-2">Salon</th>
                                <th class="px-3 py-2 text-center">Reviews</th>
                                <th class="px-3 py-2 text-center">Local SEO</th>
                                <th class="px-3 py-2 text-center">PageRank</th>
                            </tr>
                        </thead>
                        <tbody id="competitorTableBody">
                            <tr><td colspan="5" class="text-center py-4 text-gray-500">Loading competitor data...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 text-xs text-gray-500">
                    <strong>All data is REAL:</strong> Reviews from Google Places API | PageRank from OpenPageRank API
                </div>
            </div>
        </div>

        <!-- Action Items -->
        <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-2xl font-bold mb-4">üéØ Priority Action Items</h3>
            <div id="actionItems" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-lg shadow">
                    <p class="text-gray-500 text-center py-8">Run analysis to get personalized action items</p>
                </div>
            </div>
        </div>

        <!-- AI Prompts Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-2xl font-bold mb-4">ü§ñ AI Enhancement Prompts</h3>
            <p class="text-gray-600 mb-4">Copy these prompts to Claude or ChatGPT to get specific improvements for your site:</p>
            
            <div id="aiPrompts" class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">Prompts will appear here after analysis</p>
                </div>
            </div>
        </div>
    </div>

    <script>
    // API Base URL - use production when running locally (serverless functions need Vercel)
    const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'https://www.chrisdavidsalon.com'
        : '';

    // Load AI Config (optional - dashboard works without it)
    try {
        if (window.AIConfig && window.AIConfig.loadApiKeys) {
            window.AIConfig.loadApiKeys();
        }
    } catch (e) {
        console.warn('AIConfig not available, dashboard will use direct API calls');
    }

    // ============================================
    // CACHED DATA SYSTEM - Load instantly on arrival
    // ============================================
    const CACHE_KEY = 'seoCommandCenterData';

    // Load cached data immediately - no API calls on page load
    function loadCachedData() {
        try {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                const data = JSON.parse(cached);
                console.log('Loading cached data from:', data.timestamp);

                // Restore all scores from cache
                if (data.scoreData) {
                    Object.assign(scoreData, data.scoreData);
                }

                // Display the cached data
                displayCachedScores(data);

                // Show when it was last updated
                const lastUpdate = new Date(data.timestamp);
                const timeAgo = getTimeAgo(lastUpdate);
                document.getElementById('lastAnalysis').innerHTML = `
                    <div class="text-lg font-bold">${lastUpdate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
                    <div class="text-sm mt-1">Updated ${timeAgo}</div>
                `;

                return true;
            }
        } catch (e) {
            console.warn('Could not load cached data:', e);
        }
        return false;
    }

    // Display scores from cached data
    function displayCachedScores(data) {
        const scores = data?.scoreData;

        // If we have cached scores, update global scoreData and display them
        if (scores && typeof scores === 'object') {
            // Update global scoreData from cache
            Object.assign(scoreData, scores);

            // Update all score displays
            document.getElementById('performanceScore').textContent = scores.performance || '--';
            document.getElementById('pageSpeed').textContent = scores.performance ? scores.performance + '%' : '--';
            document.getElementById('technicalScore').textContent = scores.technical || '--';
            document.getElementById('mobileScore').textContent = scores.mobile || '--';
            document.getElementById('contentScore').textContent = scores.content || '--';
            document.getElementById('localScore').textContent = scores.local || '--';
            document.getElementById('uxScore').textContent = scores.ux || '--';
            document.getElementById('authorityScore').textContent = scores.authority || '--';

            // Update sub-metrics from cached details
            if (data.details) {
                document.getElementById('metaTags').textContent = scores.technical > 70 ? 'Optimized' : 'Needs Work';
                document.getElementById('schema').textContent = scores.technical > 70 ? 'Present' : 'Missing';
                document.getElementById('responsive').textContent = scores.mobile > 70 ? 'Yes' : 'Partial';
                document.getElementById('mobileUsability').textContent = scores.mobile > 70 ? 'Good' : 'Issues';
                document.getElementById('keywordUsage').textContent = scores.content > 70 ? 'Good' : 'Needs Work';
                document.getElementById('contentQuality').textContent = scores.content > 70 ? 'High' : 'Medium';
                document.getElementById('navigation').textContent = scores.ux > 70 ? 'Clear' : 'Confusing';
                document.getElementById('design').textContent = scores.ux > 70 ? 'Modern' : 'Dated';

                if (data.details.gmb) document.getElementById('gmb').textContent = data.details.gmb;
                if (data.details.citations) document.getElementById('citations').textContent = data.details.citations;
                if (data.details.backlinks) document.getElementById('backlinks').textContent = data.details.backlinks;
                if (data.details.trust) document.getElementById('trust').textContent = data.details.trust;
                if (data.details.loadTime) document.getElementById('loadTime').textContent = data.details.loadTime;
            }
        }

        // ALWAYS calculate and display total score (uses global scoreData)
        recalculateTotalScore();
    }

    // Save analysis results to cache
    function saveToCache(analysisData) {
        try {
            const cacheData = {
                timestamp: new Date().toISOString(),
                scoreData: { ...scoreData },
                details: {
                    gmb: document.getElementById('gmb')?.textContent,
                    citations: document.getElementById('citations')?.textContent,
                    backlinks: document.getElementById('backlinks')?.textContent,
                    trust: document.getElementById('trust')?.textContent,
                    loadTime: document.getElementById('loadTime')?.textContent
                },
                rawAnalysis: analysisData
            };
            localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
            console.log('Saved analysis to cache');
        } catch (e) {
            console.warn('Could not save to cache:', e);
        }
    }

    // Helper to show time ago
    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'just now';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
    }

    // Load historical data (legacy support)
    let historicalScores = [];

    function loadHistory() {
        try {
            if (window.AIConfig && window.AIConfig.getHistory) {
                historicalScores = window.AIConfig.getHistory('seo', 30);
            } else {
                // Fallback: get from localStorage directly
                const history = JSON.parse(localStorage.getItem('seoHistory') || '[]');
                historicalScores = history.slice(-30);
            }
        } catch (e) {
            console.warn('Could not load history:', e);
            historicalScores = [];
        }
    }

    // Main analysis function
    async function analyzeMySite() {
        const url = 'https://www.chrisdavidsalon.com';

        // Show loading
        document.getElementById('loadingIndicator').classList.remove('hidden');
        document.getElementById('scoreBreakdown').style.opacity = '0.3';

        try {
            // Fetch SEO analysis AND AI recommendations in parallel
            const [seoResponse, aiResponse] = await Promise.all([
                fetch(`${API_BASE}/api/admin-data?type=seo-analysis`),
                fetch(`${API_BASE}/api/admin-data?type=ai-recommendations`)
            ]);

            const seoResult = await seoResponse.json();
            const aiResult = await aiResponse.json();

            if (!seoResult.success) {
                throw new Error('SEO Analysis failed');
            }

            const fullAnalysis = seoResult.data;
            const timestamp = new Date();
            fullAnalysis.timestamp = timestamp.toISOString();
            fullAnalysis.live = seoResult.live;
            fullAnalysis.aiRecommendations = aiResult.data?.recommendations || [];
            fullAnalysis.aiLive = aiResult.live;

            // Save results to localStorage directly
            try {
                const history = JSON.parse(localStorage.getItem('seoHistory') || '[]');
                history.push({ type: 'seo', data: fullAnalysis, timestamp: fullAnalysis.timestamp });
                localStorage.setItem('seoHistory', JSON.stringify(history.slice(-30)));
            } catch (e) {
                console.warn('Could not save to history:', e);
            }

            // Display results
            displayScoreBreakdown(fullAnalysis);
            generateActionItems(fullAnalysis);
            generateAIPrompts(fullAnalysis);

            // Update history display
            loadHistory();

            // Update last analysis timestamp with detailed info
            const timeStr = timestamp.toLocaleString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric',
                hour: 'numeric', minute: '2-digit', hour12: true
            });
            const liveStatus = seoResult.live ? 'üü¢ LIVE PageSpeed' : (seoResult.success === false ? 'üî¥ API Unavailable' : 'üü° API Limited');
            const aiStatus = aiResult.live ? 'üü¢ Claude AI' : (aiResult.success === false ? 'üî¥ AI Unavailable' : 'üü° AI Limited');
            document.getElementById('lastAnalysis').innerHTML = `
                <div class="text-lg font-bold">${timeStr}</div>
                <div class="text-sm mt-1">${liveStatus} ‚Ä¢ ${aiStatus}</div>
            `;

            // Show success notification
            const statusMsg = seoResult.live ? 'Live PageSpeed data retrieved!' : (seoResult.success === false ? 'PageSpeed API unavailable - try again later' : 'PageSpeed API rate limited');
            const aiMsg = aiResult.live ? 'Claude AI recommendations generated!' : (aiResult.success === false ? 'AI API unavailable' : 'AI rate limited');
            console.log(`Analysis complete: ${statusMsg} ${aiMsg}`);

            // IMPORTANT: Save to cache IMMEDIATELY with PageSpeed data
            // This ensures instant load even if other APIs are slow/failing
            saveToCache(fullAnalysis);
            console.log('Initial cache saved with PageSpeed data');

            // Fetch additional scores in parallel (don't wait for each)
            // Use Promise.allSettled so one failure doesn't block others
            console.log('Fetching Content, Local, Authority scores in parallel...');
            const additionalResults = await Promise.allSettled([
                fetchContentScore(),
                fetchLocalSEOScore(),
                fetchAuthorityScore()
            ]);

            // Log which APIs succeeded/failed
            const apiNames = ['Content', 'Local', 'Authority'];
            additionalResults.forEach((result, i) => {
                if (result.status === 'fulfilled') {
                    console.log(`${apiNames[i]} score: ${result.value}`);
                } else {
                    console.warn(`${apiNames[i]} API failed:`, result.reason);
                }
            });

            // Recalculate total with all available scores
            recalculateTotalScore();

            // Save AGAIN with all scores (updates the initial cache)
            saveToCache(fullAnalysis);
            console.log('Final cache saved with all scores');

        } catch (error) {
            console.error('Analysis error:', error);
            document.getElementById('lastAnalysis').innerHTML = `
                <div class="text-lg font-bold text-red-400">${new Date().toLocaleString()}</div>
                <div class="text-sm mt-1">üî¥ Error - No data available</div>
            `;
        } finally {
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('scoreBreakdown').style.opacity = '1';
        }
    }

    // Display score breakdown - stores scores in scoreData for final calculation
    function displayScoreBreakdown(data) {
        // Update category scores and store in scoreData
        if (data.categories) {
            // Performance - store in scoreData
            const perfScore = Math.round(data.categories.performance?.score || 0);
            scoreData.performance = perfScore;
            document.getElementById('performanceScore').textContent = perfScore;
            document.getElementById('pageSpeed').textContent = perfScore ? perfScore + '%' : '--';
            document.getElementById('loadTime').textContent = data.pageSpeed?.lighthouseResult?.audits?.['speed-index']?.displayValue || '--';

            // Technical - store in scoreData
            const techScore = Math.round(data.categories.technical?.score || 0);
            scoreData.technical = techScore;
            document.getElementById('technicalScore').textContent = techScore;
            document.getElementById('metaTags').textContent = techScore > 70 ? 'Optimized' : 'Needs Work';
            document.getElementById('schema').textContent = techScore > 70 ? 'Present' : 'Missing';

            // Mobile - store in scoreData
            const mobileScore = Math.round(data.categories.mobile?.score || 0);
            scoreData.mobile = mobileScore;
            document.getElementById('mobileScore').textContent = mobileScore;
            document.getElementById('responsive').textContent = mobileScore > 70 ? 'Yes' : 'Partial';
            document.getElementById('mobileUsability').textContent = mobileScore > 70 ? 'Good' : 'Issues';

            // UX - store in scoreData
            const uxScore = Math.round(data.categories.userExperience?.score || 0);
            scoreData.ux = uxScore;
            document.getElementById('uxScore').textContent = uxScore;
            document.getElementById('navigation').textContent = uxScore > 70 ? 'Clear' : 'Confusing';
            document.getElementById('design').textContent = uxScore > 70 ? 'Modern' : 'Dated';

            console.log('displayScoreBreakdown: Set scoreData:', {
                performance: scoreData.performance,
                technical: scoreData.technical,
                mobile: scoreData.mobile,
                ux: scoreData.ux
            });

            // Content, Local, Authority are set by their dedicated fetch functions
        }
    }

    // Generate action items
    function generateActionItems(data) {
        const container = document.getElementById('actionItems');
        container.innerHTML = '';
        
        const priorities = [];
        
        // Check each category for issues
        Object.entries(data.categories || {}).forEach(([category, info]) => {
            if (info.score < 70 && info.issues) {
                info.issues.forEach(issue => {
                    priorities.push({
                        category: category,
                        issue: issue,
                        score: info.score,
                        priority: info.score < 50 ? 'high' : 'medium'
                    });
                });
            }
        });
        
        // Sort by priority
        priorities.sort((a, b) => a.score - b.score);
        
        // Display top 6
        priorities.slice(0, 6).forEach(item => {
            const div = document.createElement('div');
            div.className = 'bg-white p-4 rounded-lg shadow border-l-4 ' + 
                           (item.priority === 'high' ? 'border-red-500' : 'border-yellow-500');
            div.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-exclamation-triangle text-${item.priority === 'high' ? 'red' : 'yellow'}-500 mr-3 mt-1"></i>
                    <div>
                        <h4 class="font-semibold capitalize">${item.category.replace(/([A-Z])/g, ' $1').trim()}</h4>
                        <p class="text-sm text-gray-600 mt-1">${item.issue}</p>
                        <p class="text-xs text-gray-500 mt-2">Current score: ${Math.round(item.score)}/100</p>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // Generate AI prompts
    function generateAIPrompts(data) {
        const container = document.getElementById('aiPrompts');
        container.innerHTML = '';
        
        const prompts = [
            {
                title: 'Performance Optimization',
                prompt: `I have a salon website at chrisdavidsalon.com with a current PageSpeed score of ${Math.round(data.categories?.performance?.score || 0)}. Please provide specific code changes to improve load time, optimize images, and enhance Core Web Vitals.`
            },
            {
                title: 'Content Enhancement',
                prompt: `My salon website needs better SEO content. We're a luxury salon in Delray Beach specializing in color and cuts. Current content score is ${Math.round(data.categories?.content?.score || 0)}. Please write optimized title tags, meta descriptions, and suggest content improvements for better local SEO.`
            },
            {
                title: 'Technical SEO Fixes',
                prompt: `Review the technical SEO for chrisdavidsalon.com. Current score is ${Math.round(data.categories?.technical?.score || 0)}. Provide schema markup for a hair salon, optimize robots.txt, and suggest technical improvements.`
            }
        ];
        
        prompts.forEach(item => {
            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-4 rounded-lg';
            div.innerHTML = `
                <h4 class="font-semibold mb-2">${item.title}</h4>
                <div class="bg-white p-3 rounded border border-gray-200">
                    <p class="text-sm font-mono">${item.prompt}</p>
                </div>
                <button onclick="copyPrompt(this, '${item.prompt.replace(/'/g, "\\'")}')" 
                        class="mt-2 text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                    <i class="fas fa-copy mr-1"></i>Copy Prompt
                </button>
            `;
            container.appendChild(div);
        });
    }

    // Copy prompt to clipboard
    function copyPrompt(button, prompt) {
        navigator.clipboard.writeText(prompt);
        button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
        setTimeout(() => {
            button.innerHTML = '<i class="fas fa-copy mr-1"></i>Copy Prompt';
        }, 2000);
    }

    // Toggle score breakdown section
    function toggleScoreBreakdown() {
        const section = document.getElementById('scoreBreakdownSection');
        if (section) {
            section.classList.toggle('hidden');
            // Scroll to section when opening
            if (!section.classList.contains('hidden')) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    }

    // Toggle competitor table
    function toggleCompetitorTable() {
        const section = document.getElementById('competitorTableSection');
        const icon = document.getElementById('competitorToggleIcon');
        if (section) {
            section.classList.toggle('hidden');
            if (icon) {
                icon.textContent = section.classList.contains('hidden') ? '‚ñ∂' : '‚ñº';
            }
        }
    }

    // Draw score chart
    function drawScoreChart(categories) {
        const canvas = document.getElementById('scoreChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['Performance', 'Content', 'Technical', 'Mobile', 'UX', 'Local', 'Authority'],
                datasets: [{
                    label: 'Your Score',
                    data: [
                        categories?.performance?.score || 0,
                        categories?.content?.score || 0,
                        categories?.technical?.score || 0,
                        categories?.mobile?.score || 0,
                        categories?.userExperience?.score || 0,
                        categories?.localSEO?.score || 0,
                        categories?.authority?.score || 0
                    ],
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }

    // Load dashboard data dynamically from API
    async function loadDashboardData() {
        try {
            // Fetch dashboard data from API
            const response = await fetch(`${API_BASE}/api/admin-data?type=dashboard`);
            if (!response.ok) throw new Error('Dashboard API failed');
            const result = await response.json();
            const data = result.data;

            // Update score display - NO HARDCODED FALLBACK
            const yourScoreEl = document.getElementById('yourScore');
            const totalScoreEl = document.getElementById('totalScore');
            if (yourScoreEl) yourScoreEl.textContent = data.seoScore !== null ? data.seoScore : '--';
            if (totalScoreEl) totalScoreEl.textContent = data.seoScore !== null ? data.seoScore + '/100' : '--';

            // Display action items
            const actionContainer = document.getElementById('actionItems');
            if (actionContainer && data.actionItems) {
                actionContainer.innerHTML = '';
                data.actionItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-4 rounded-lg shadow border-l-4 ' +
                                   (item.priority === 'high' ? 'border-red-500' : 'border-yellow-500');
                    div.innerHTML = `
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-${item.priority === 'high' ? 'red' : 'yellow'}-500 mr-3 mt-1"></i>
                            <div>
                                <h4 class="font-semibold">${item.task}</h4>
                                <p class="text-sm text-gray-600 mt-1">Impact: ${item.impact}</p>
                            </div>
                        </div>
                    `;
                    actionContainer.appendChild(div);
                });
            }

            // Fetch SEO analysis data
            const seoResponse = await fetch(`${API_BASE}/api/admin-data?type=seo-analysis`);
            if (seoResponse.ok) {
                const seoResult = await seoResponse.json();
                if (seoResult.data) displayScoreBreakdown(seoResult.data);
            }

        } catch (error) {
            console.error('Failed to load dashboard:', error);
            // NO HARDCODED FALLBACK - show error state
            const yourScoreEl = document.getElementById('yourScore');
            if (yourScoreEl) yourScoreEl.textContent = '--';
        }
    }
    
    // Load and display version from version.json
    async function loadVersion() {
        try {
            const response = await fetch(`${API_BASE}/data/version.json`);
            const data = await response.json();
            const versionBadge = document.getElementById('versionBadge');
            if (versionBadge && data.version) {
                versionBadge.textContent = `v${data.version}`;
                versionBadge.title = `Last updated: ${new Date(data.lastUpdated).toLocaleString()}`;
            }
        } catch (e) {
            console.warn('Could not load version:', e);
            const versionBadge = document.getElementById('versionBadge');
            if (versionBadge) versionBadge.textContent = 'v?.?.?';
        }
    }

    // Fetch Authority Score from OpenPageRank API
    async function fetchAuthorityScore() {
        try {
            const response = await fetch(`${API_BASE}/api/authority-score?competitors=true`);
            const result = await response.json();

            if (result.success && result.data) {
                const authScore = result.data.authority_score; // No fallback - must be real data
                const pagerank = result.data.pagerank_decimal;
                const position = result.data.comparison?.chris_david_position;
                const total = result.data.comparison?.total_compared;

                // Store in scoreData for final calculation
                scoreData.authority = authScore;
                console.log('fetchAuthorityScore: Set authority to', authScore);

                document.getElementById('authorityScore').textContent = authScore;
                document.getElementById('backlinks').textContent = pagerank ? `PR ${pagerank.toFixed(2)}` : '--';
                document.getElementById('trust').textContent = position && total ? `#${position} of ${total}` : '--';

                // Update the authority issues area
                const issuesDiv = document.getElementById('authorityIssues');
                if (issuesDiv && result.live) {
                    issuesDiv.innerHTML = `<span class="text-green-600">üü¢ LIVE OpenPageRank</span>`;
                }
            }
        } catch (error) {
            console.error('Authority score error:', error);
        }
    }

    // Fetch Local SEO Score from Google Places API
    async function fetchLocalSEOScore() {
        console.log('fetchLocalSEOScore: Starting...');
        try {
            const response = await fetch(`${API_BASE}/api/admin-data?type=competitors`);
            const result = await response.json();
            console.log('fetchLocalSEOScore: Got response', result.success, result.live, 'competitors:', result.data?.competitors?.length);

            if (result.success && result.data?.competitors && result.data.competitors.length > 0) {
                // Find Chris David Salon in the results - check multiple variations
                const chrisDavid = result.data.competitors.find(c => {
                    const name = (c.name || '').toLowerCase();
                    return name.includes('chris david') || name.includes('chrisdavid');
                });
                console.log('fetchLocalSEOScore: Found Chris David:', chrisDavid ? chrisDavid.name : 'NOT FOUND');

                if (chrisDavid) {
                    // Calculate Local SEO score based on rating and reviews
                    // UNIFIED FORMULA (same as competitors.html):
                    // Rating: (rating * 10) = 0-50 points
                    // Reviews: min(log10(reviews) * 15, 40) = 0-40 points (logarithmic scale)
                    // Presence: 10 points for Google Places listing
                    const rating = chrisDavid.rating || 0;
                    const reviews = chrisDavid.reviews || 0;
                    const ratingScore = rating * 10;
                    const reviewScore = reviews > 0 ? Math.min(Math.log10(reviews) * 15, 40) : 0;
                    // Presence bonus only if they have a Place ID (consistent with competitors.html)
                    const presenceBonus = chrisDavid.placeId ? 10 : 0;
                    const localScore = Math.round(ratingScore + reviewScore + presenceBonus);
                    console.log('fetchLocalSEOScore: Score calculation:', { ratingScore, reviewScore, presenceBonus, localScore });

                    // Store in scoreData for final calculation
                    scoreData.local = localScore;
                    console.log('fetchLocalSEOScore: Stored in scoreData.local =', localScore);

                    const localScoreEl = document.getElementById('localScore');
                    const gmbEl = document.getElementById('gmb');
                    const citationsEl = document.getElementById('citations');

                    if (localScoreEl) localScoreEl.textContent = localScore;
                    if (gmbEl) gmbEl.textContent = chrisDavid.rating ? `${chrisDavid.rating} ‚òÖ` : '--';
                    if (citationsEl) citationsEl.textContent = chrisDavid.reviews ? `${chrisDavid.reviews} reviews` : '--';

                    const issuesDiv = document.getElementById('localIssues');
                    if (issuesDiv) {
                        issuesDiv.innerHTML = `<span class="text-green-600">üü¢ LIVE Google Places</span>`;
                    }
                    return localScore;
                } else {
                    // Chris David not found in API - show unavailable
                    console.log('fetchLocalSEOScore: Chris David not found in results');
                    scoreData.local = null;
                    document.getElementById('localScore').textContent = '--';
                    document.getElementById('gmb').textContent = '--';
                    document.getElementById('citations').textContent = '--';
                    document.getElementById('localIssues').innerHTML = `<span class="text-red-600">üî¥ Not found in API</span>`;
                    return null;
                }
            } else {
                console.log('fetchLocalSEOScore: No competitors in response');
                // No data available - show unavailable
                scoreData.local = null;
                document.getElementById('localScore').textContent = '--';
                document.getElementById('gmb').textContent = '--';
                document.getElementById('citations').textContent = '--';
                document.getElementById('localIssues').innerHTML = `<span class="text-red-600">üî¥ API unavailable</span>`;
                return null;
            }
        } catch (error) {
            console.error('Local SEO score error:', error);
            // On error, show unavailable - NO FAKE DATA
            scoreData.local = null;
            document.getElementById('localScore').textContent = '--';
            document.getElementById('gmb').textContent = '--';
            document.getElementById('citations').textContent = '--';
        }
        return scoreData.local;
    }

    // Fetch Content Score using Claude AI analysis
    async function fetchContentScore() {
        console.log('fetchContentScore: Starting...');
        try {
            const response = await fetch(`${API_BASE}/api/admin-data?type=ai-recommendations`);
            const result = await response.json();
            console.log('fetchContentScore: Got response', result.success, result.live);

            if (result.success && result.live) {
                // Content score based on presence of AI recommendations
                const recommendations = result.data?.recommendations || [];
                const highPriority = recommendations.filter(r => r.priority === 'high').length;
                console.log('fetchContentScore: High priority count:', highPriority);

                // Score: Start at 85, subtract 10 for each high-priority issue
                const contentScore = Math.max(60, 85 - (highPriority * 10));
                console.log('fetchContentScore: Calculated score:', contentScore);

                // Store in scoreData for final calculation
                scoreData.content = contentScore;
                console.log('fetchContentScore: Stored in scoreData.content =', contentScore);

                const contentScoreEl = document.getElementById('contentScore');
                const keywordEl = document.getElementById('keywordUsage');
                const qualityEl = document.getElementById('contentQuality');

                if (contentScoreEl) contentScoreEl.textContent = contentScore;
                if (keywordEl) keywordEl.textContent = contentScore > 70 ? 'Good' : 'Needs Work';
                if (qualityEl) qualityEl.textContent = contentScore > 70 ? 'High' : 'Medium';

                const issuesDiv = document.getElementById('contentIssues');
                if (issuesDiv) {
                    issuesDiv.innerHTML = `<span class="text-green-600">üü¢ Claude AI Analysis</span>`;
                }
            } else {
                // API not live - show unavailable, NO FAKE DATA
                console.log('fetchContentScore: API not live');
                scoreData.content = null;
                document.getElementById('contentScore').textContent = '--';
                document.getElementById('keywordUsage').textContent = '--';
                document.getElementById('contentQuality').textContent = '--';
                document.getElementById('contentIssues').innerHTML = `<span class="text-red-600">üî¥ API unavailable</span>`;
            }
        } catch (error) {
            console.error('Content score error:', error);
            // On error, show unavailable - NO FAKE DATA
            scoreData.content = null;
            document.getElementById('contentScore').textContent = '--';
        }
        return scoreData.content;
    }

    // Store scores in JavaScript variables (NOT from DOM)
    // This ensures we have accurate values for the final calculation
    const scoreData = {
        performance: 0,
        content: 0,
        technical: 0,
        mobile: 0,
        ux: 0,
        local: 0,
        authority: 0
    };

    let summaryChart = null; // Track chart instance

    // Recalculate total score from all 7 category scores AND redraw chart
    // Weighted average: Performance 20%, Technical 15%, Mobile 15%, Content 15%, Local 15%, UX 10%, Authority 10%
    function recalculateTotalScore() {
        const { performance, content, technical, mobile, ux, local, authority } = scoreData;

        // Weighted scoring
        const totalScore = Math.round(
            performance * 0.20 +
            content * 0.15 +
            technical * 0.15 +
            mobile * 0.15 +
            ux * 0.10 +
            local * 0.15 +
            authority * 0.10
        );

        console.log('=== FINAL SCORE CALCULATION ===');
        console.log('Performance (20%):', performance, '‚Üí', (performance * 0.20).toFixed(1));
        console.log('Technical (15%):', technical, '‚Üí', (technical * 0.15).toFixed(1));
        console.log('Mobile (15%):', mobile, '‚Üí', (mobile * 0.15).toFixed(1));
        console.log('Content (15%):', content, '‚Üí', (content * 0.15).toFixed(1));
        console.log('Local (15%):', local, '‚Üí', (local * 0.15).toFixed(1));
        console.log('UX (10%):', ux, '‚Üí', (ux * 0.10).toFixed(1));
        console.log('Authority (10%):', authority, '‚Üí', (authority * 0.10).toFixed(1));
        console.log('TOTAL:', totalScore);

        // Update both displays
        document.getElementById('yourScore').textContent = totalScore;
        document.getElementById('totalScore').textContent = totalScore + '/100';

        // Redraw the radar chart with actual scores from scoreData
        const canvas = document.getElementById('scoreChart');
        if (canvas) {
            const ctx = canvas.getContext('2d');

            // Destroy old chart if exists
            if (summaryChart) {
                summaryChart.destroy();
            }

            summaryChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Performance', 'Content', 'Technical', 'Mobile', 'UX', 'Local', 'Authority'],
                    datasets: [{
                        label: 'Your Score',
                        data: [performance, content, technical, mobile, ux, local, authority],
                        backgroundColor: 'rgba(255, 255, 255, 0.15)',
                        borderColor: 'rgba(255, 255, 255, 0.9)',
                        borderWidth: 3,
                        pointBackgroundColor: '#fbbf24',
                        pointBorderColor: '#fff',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 25,
                                display: true,
                                color: 'rgba(255,255,255,0.6)',
                                backdropColor: 'transparent',
                                font: { size: 10 }
                            },
                            pointLabels: {
                                color: '#fff',
                                font: { size: 12, weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.2)'
                            },
                            angleLines: {
                                color: 'rgba(255,255,255,0.2)'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.raw + '/100';
                                }
                            }
                        }
                    }
                }
            });
            console.log('Radar chart redrawn with data:', [performance, content, technical, mobile, ux, local, authority]);
        }

        return totalScore;
    }

    // Load and display competitor comparison
    async function loadCompetitorComparison() {
        try {
            // Fetch both data sources in parallel
            const [authorityResponse, placesResponse] = await Promise.all([
                fetch(`${API_BASE}/api/authority-score?competitors=true`),
                fetch(`${API_BASE}/api/admin-data?type=competitors`)
            ]);

            const authorityData = await authorityResponse.json();
            const placesData = await placesResponse.json();

            // Build PageRank lookup
            const pageRankMap = {};
            if (authorityData.success && authorityData.data?.all_results) {
                authorityData.data.all_results.forEach(item => {
                    pageRankMap[item.domain.toLowerCase()] = {
                        pagerank: item.pagerank || 0,
                        pagerank_decimal: item.pagerank_decimal || 0
                    };
                });
            }

            // Domain mapping - expanded to all 26 competitors
            const domainMap = {
                'rov√© hair salon': 'rovesalon.com',
                'rove hair': 'rovesalon.com',
                'studio 34': 'studio34delray.com',
                'kaan hair': 'kaanhairdesign.com',
                'salon south flow': 'salonsouthflow.com',
                'flow by resta': 'salonsouthflow.com',
                'one aveda': 'onesalondelray.com',
                'bond street': 'bondstreetsalon.com',
                'shearluck': 'slshair.com',
                'amanda major': 'amandamajor.com',
                'chris david': 'chrisdavidsalon.com',
                'imbue': 'imbuesalon.com',
                'lmbue': 'imbuesalon.com',
                'cloud 10': 'cloud10usa.com',
                'studio 10': 'studio10bocaraton.com',
                'aura hair': 'aurahairco.com',
                'moxie salon': 'moxiesalon.com',
                'perk salon': 'perksalondelray.com',
                'odeon': 'odeonsalon.com',
                'chloe & co': 'chloeandcosalon.com',
                'tyler presley': 'tylerpresleysalon.com',
                'conte salon': 'contesalon.com',
                'salon sora': 'salonsora.com',
                'pyure': 'pyuresalon.com',
                'dapper and divine': 'dapperanddivinestudio.com',
                'hair mess': 'hairmesssalon.com',
                'salon trace': 'salontrace.com',
                'arielle settel': 'ariellesettel.com',
                'christopher stoo': 'christopherstoosalon.com'
            };

            const competitors = [];

            if (placesData.success && placesData.data?.competitors) {
                placesData.data.competitors.forEach(salon => {
                    const name = salon.name || '';
                    const rating = salon.rating || 0;
                    const reviews = salon.reviews || 0;

                    // Local SEO score (REAL - from Google Places)
                    const ratingScore = rating * 10;
                    const reviewScore = reviews > 0 ? Math.min(Math.log10(reviews) * 15, 40) : 0;
                    const presenceBonus = salon.placeId ? 10 : 0;
                    const localSEO = Math.round(ratingScore + reviewScore + presenceBonus);

                    // Find PageRank (REAL - from OpenPageRank API)
                    let pageRankDecimal = 0;
                    const nameLower = name.toLowerCase();

                    for (const [key, dom] of Object.entries(domainMap)) {
                        if (nameLower.includes(key) && pageRankMap[dom]) {
                            pageRankDecimal = pageRankMap[dom].pagerank_decimal || 0;
                            break;
                        }
                    }

                    const isChrisDavid = salon.isOurSalon || nameLower.includes('chris david');

                    competitors.push({
                        name,
                        rating,
                        reviews,
                        localSEO,
                        pageRank: pageRankDecimal,
                        isUs: isChrisDavid
                    });
                });
            }

            // Sort by Local SEO score (reviews + rating) - this is what matters for Google local rankings
            competitors.sort((a, b) => b.localSEO - a.localSEO);

            // Find Chris David and leader
            const chrisDavid = competitors.find(c => c.isUs);
            const chrisDavidIndex = competitors.findIndex(c => c.isUs);
            const leader = competitors[0];

            // Update summary
            document.getElementById('competitorRank').textContent = chrisDavidIndex + 1;
            document.getElementById('totalCompetitorCount').textContent = competitors.length;
            document.getElementById('reviewGap').textContent = leader ? (leader.reviews - (chrisDavid?.reviews || 0)).toLocaleString() : '--';
            document.getElementById('leaderName').textContent = leader ? leader.name.substring(0, 20) : '--';

            // Build table - ONLY REAL DATA (no estimates)
            const tbody = document.getElementById('competitorTableBody');
            tbody.innerHTML = competitors.slice(0, 20).map((c, i) => {
                const rowClass = c.isUs ? 'bg-green-50 font-semibold border-l-4 border-green-500' : '';
                const marker = c.isUs ? ' ‚Üê YOU' : '';
                const pageRankDisplay = c.pageRank ? c.pageRank.toFixed(2) : '--';
                return `
                    <tr class="${rowClass}">
                        <td class="px-3 py-2 font-bold">#${i + 1}</td>
                        <td class="px-3 py-2">${c.name.substring(0, 30)}${marker}</td>
                        <td class="px-3 py-2 text-center">${c.reviews.toLocaleString()}</td>
                        <td class="px-3 py-2 text-center font-bold">${c.localSEO}</td>
                        <td class="px-3 py-2 text-center">${pageRankDisplay}</td>
                    </tr>
                `;
            }).join('');

        } catch (error) {
            console.error('Failed to load competitor comparison:', error);
            document.getElementById('competitorTableBody').innerHTML =
                '<tr><td colspan="5" class="text-center py-4 text-red-500">Failed to load competitor data</td></tr>';
        }
    }

    // Initialize on load - Load from cache OR fetch fresh data automatically
    window.addEventListener('DOMContentLoaded', async () => {
        console.log('=== DASHBOARD INIT START ===');
        loadVersion();
        loadHistory();

        // Check for stale cache - clear it
        const cached = localStorage.getItem(CACHE_KEY);
        if (cached) {
            try {
                const data = JSON.parse(cached);
                // If cache is older than 24 hours, we'll refresh it
                const cacheAge = Date.now() - new Date(data.timestamp).getTime();
                const maxAge = 24 * 60 * 60 * 1000; // 24 hours
                if (cacheAge > maxAge) {
                    console.log('Cache is stale (older than 24h), will refresh');
                    localStorage.removeItem(CACHE_KEY);
                }
            } catch (e) {
                localStorage.removeItem(CACHE_KEY);
            }
        }

        // STEP 1: Try to load cached data FIRST (instant)
        const hasCachedData = loadCachedData();

        if (hasCachedData) {
            console.log('Loaded cached data - dashboard ready instantly!');
        } else {
            // No cached data - AUTO-FETCH fresh data immediately
            console.log('No cached data found - fetching fresh data automatically...');
            document.getElementById('lastAnalysis').innerHTML = `
                <div class="text-lg font-bold">Loading...</div>
                <div class="text-sm mt-1">Fetching live data from APIs</div>
            `;

            // Auto-trigger the analysis
            await analyzeMySite();
        }

        // ALWAYS load competitor comparison (separate from cached SEO data)
        loadCompetitorComparison();

        console.log('=== DASHBOARD INIT COMPLETE ===');
    });
    </script>
</body>
</html>