<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Engagement & Conversions - Chris David Salon Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .metric-card { transition: all 0.3s; }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .data-live { background-color: #dcfce7; color: #166534; }
        .data-error { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="index.html" class="text-gray-600 hover:text-gray-900"><i class="fas fa-arrow-left"></i></a>
                <h1 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-chart-bar text-purple-600 mr-2"></i>Engagement & Conversions
                </h1>
                <span id="versionBadge" class="bg-purple-100 text-purple-800 text-xs font-semibold px-2.5 py-0.5 rounded">Loading...</span>
            </div>
            <div class="flex items-center space-x-4">
                <span id="dataSourceBadge" class="text-xs font-semibold px-2.5 py-0.5 rounded data-live">Checking...</span>
                <span id="lastUpdated" class="text-sm text-gray-500">Loading...</span>
                <button onclick="refreshData()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
            </div>
        </div>
    </header>

    <nav class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex space-x-4 overflow-x-auto py-2">
                <a href="index.html" class="px-4 py-2 text-gray-600 hover:text-purple-600 whitespace-nowrap">SEO Score</a>
                <a href="visitor-metrics.html" class="px-4 py-2 text-gray-600 hover:text-purple-600 whitespace-nowrap">Traffic</a>
                <a href="engagement-tracker.html" class="px-4 py-2 text-purple-600 border-b-2 border-purple-600 font-semibold whitespace-nowrap">Conversions</a>
                <a href="competitors.html" class="px-4 py-2 text-gray-600 hover:text-purple-600 whitespace-nowrap">Competitors</a>
                <a href="rankings.html" class="px-4 py-2 text-gray-600 hover:text-purple-600 whitespace-nowrap">Rankings</a>
                <a href="seo-action-plan.html" class="px-4 py-2 text-gray-600 hover:text-purple-600 whitespace-nowrap">Action Plan</a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- KPI Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 metric-card border-t-4 border-green-500">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <i class="fas fa-calendar-check text-green-600 text-xl"></i>
                    </div>
                </div>
                <h3 class="text-gray-500 text-sm font-medium">Booking Clicks</h3>
                <p class="text-3xl font-bold text-gray-900" id="bookingClicks">--</p>
                <p class="text-sm text-gray-500 mt-1">This month</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 metric-card border-t-4 border-blue-500">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <i class="fas fa-phone text-blue-600 text-xl"></i>
                    </div>
                </div>
                <h3 class="text-gray-500 text-sm font-medium">Phone Clicks</h3>
                <p class="text-3xl font-bold text-gray-900" id="phoneClicks">--</p>
                <p class="text-sm text-gray-500 mt-1">This month</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 metric-card border-t-4 border-yellow-500">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-yellow-100 rounded-lg">
                        <i class="fas fa-hand-pointer text-yellow-600 text-xl"></i>
                    </div>
                </div>
                <h3 class="text-gray-500 text-sm font-medium">Total Actions</h3>
                <p class="text-3xl font-bold text-gray-900" id="totalActions">--</p>
                <p class="text-sm text-gray-500 mt-1">Bookings + Calls</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 metric-card border-t-4 border-purple-500">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <i class="fas fa-users text-purple-600 text-xl"></i>
                    </div>
                </div>
                <h3 class="text-gray-500 text-sm font-medium">Total Visitors</h3>
                <p class="text-3xl font-bold text-gray-900" id="totalVisitors">--</p>
                <p class="text-sm text-gray-500 mt-1">This month</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 metric-card border-t-4 border-red-500">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-red-100 rounded-lg">
                        <i class="fas fa-percentage text-red-600 text-xl"></i>
                    </div>
                </div>
                <h3 class="text-gray-500 text-sm font-medium">Conversion Rate</h3>
                <p class="text-3xl font-bold text-gray-900" id="conversionRate">--</p>
                <p class="text-sm text-gray-500 mt-1">Visitor â†’ Action</p>
            </div>
        </div>

        <!-- Conversion Funnel -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-lg font-bold text-gray-900 mb-6">
                <i class="fas fa-filter text-blue-600 mr-2"></i>Conversion Funnel
            </h3>
            <div id="funnelContainer" class="flex items-center justify-center">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading funnel data...</p>
                </div>
            </div>
        </div>

        <!-- Action Breakdown -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">
                    <i class="fas fa-chart-pie text-purple-600 mr-2"></i>Action Breakdown
                </h3>
                <div class="h-80">
                    <canvas id="actionBreakdownChart"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">
                    <i class="fas fa-lightbulb text-yellow-600 mr-2"></i>Opportunities
                </h3>
                <div id="opportunitiesSection" class="space-y-4">
                    <p class="text-gray-500">Loading opportunities...</p>
                </div>
            </div>
        </div>

        <!-- Action Items -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
                <i class="fas fa-tasks text-green-600 mr-2"></i>Priority Actions to Improve Conversions
            </h3>
            <div id="actionItemsSection" class="space-y-3">
                <p class="text-gray-500">Loading action items...</p>
            </div>
        </div>
    </main>

    <script>
        // ALL DATA FROM API - NO HARDCODED VALUES
        let dashboardData = null;
        let actionBreakdownChart = null;

        async function loadVersion() {
            try {
                const response = await fetch('/data/version.json');
                const data = await response.json();
                document.getElementById('versionBadge').textContent = `v${data.version}`;
            } catch (e) {
                document.getElementById('versionBadge').textContent = 'v?.?.?';
            }
        }

        async function fetchDashboardData() {
            try {
                const response = await fetch('/api/admin-data?type=dashboard');
                const result = await response.json();

                if (result.success) {
                    dashboardData = result.data;
                    return result;
                } else {
                    throw new Error(result.error || 'Failed to fetch data');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                return { success: false, error: error.message };
            }
        }

        function updateUI(result) {
            const badge = document.getElementById('dataSourceBadge');

            if (!result.success) {
                badge.className = 'text-xs font-semibold px-2.5 py-0.5 rounded data-error';
                badge.textContent = 'API Error';
                return;
            }

            badge.className = 'text-xs font-semibold px-2.5 py-0.5 rounded data-live';
            badge.textContent = 'Live API Data';

            const data = result.data;
            const totalActions = data.bookingClicks + data.phoneClicks;

            // Update metrics
            document.getElementById('bookingClicks').textContent = data.bookingClicks;
            document.getElementById('phoneClicks').textContent = data.phoneClicks;
            document.getElementById('totalActions').textContent = totalActions;
            document.getElementById('totalVisitors').textContent = data.monthlyVisitors;
            document.getElementById('conversionRate').textContent = data.conversionRate + '%';

            // Update funnel
            updateFunnel(data);

            // Update opportunities
            updateOpportunities(data);

            // Update action items
            updateActionItems(data);

            // Update timestamp
            document.getElementById('lastUpdated').textContent = `Updated: ${new Date().toLocaleString()}`;
        }

        function updateFunnel(data) {
            const visitors = data.monthlyVisitors;
            const bookings = data.bookingClicks;
            const phone = data.phoneClicks;
            const totalActions = bookings + phone;

            document.getElementById('funnelContainer').innerHTML = `
                <div class="w-full max-w-4xl">
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <div class="bg-blue-500 text-white py-4 px-6 rounded-lg text-center" style="width: 100%;">
                                    <span class="font-bold text-xl">${visitors}</span>
                                    <span class="block text-sm">Website Visitors</span>
                                </div>
                            </div>
                            <div class="ml-4 text-gray-500 text-sm w-16">100%</div>
                        </div>
                        <div class="flex items-center">
                            <div class="flex-1">
                                <div class="bg-purple-500 text-white py-4 px-6 rounded-lg text-center mx-auto" style="width: ${Math.round(totalActions/visitors*100)}%;">
                                    <span class="font-bold text-xl">${totalActions}</span>
                                    <span class="block text-sm">Total Actions (Bookings + Calls)</span>
                                </div>
                            </div>
                            <div class="ml-4 text-purple-600 font-bold text-sm w-16">${Math.round(totalActions/visitors*100)}%</div>
                        </div>
                        <div class="flex items-center">
                            <div class="flex-1">
                                <div class="bg-green-500 text-white py-4 px-6 rounded-lg text-center mx-auto" style="width: ${Math.max(10, Math.round(bookings/visitors*100))}%;">
                                    <span class="font-bold text-xl">${bookings}</span>
                                    <span class="block text-sm">Booking Clicks</span>
                                </div>
                            </div>
                            <div class="ml-4 text-green-600 font-bold text-sm w-16">${(bookings/visitors*100).toFixed(1)}%</div>
                        </div>
                        <div class="flex items-center">
                            <div class="flex-1">
                                <div class="bg-blue-400 text-white py-4 px-6 rounded-lg text-center mx-auto" style="width: ${Math.max(10, Math.round(phone/visitors*100))}%;">
                                    <span class="font-bold text-xl">${phone}</span>
                                    <span class="block text-sm">Phone Clicks</span>
                                </div>
                            </div>
                            <div class="ml-4 text-blue-600 font-bold text-sm w-16">${(phone/visitors*100).toFixed(1)}%</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateOpportunities(data) {
            const opp = data.opportunities;
            document.getElementById('opportunitiesSection').innerHTML = `
                <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold text-green-800">Potential Revenue</p>
                            <p class="text-sm text-green-600">From improved conversion</p>
                        </div>
                        <p class="text-2xl font-bold text-green-600">$${opp.missedRevenue.toLocaleString()}</p>
                    </div>
                </div>
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold text-blue-800">Target Visitors</p>
                            <p class="text-sm text-blue-600">To reach revenue goal</p>
                        </div>
                        <p class="text-2xl font-bold text-blue-600">${opp.potentialVisitors.toLocaleString()}</p>
                    </div>
                </div>
                <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold text-yellow-800">Reviews Needed</p>
                            <p class="text-sm text-yellow-600">To improve ranking</p>
                        </div>
                        <p class="text-2xl font-bold text-yellow-600">${opp.reviewsNeeded}</p>
                    </div>
                </div>
            `;
        }

        function updateActionItems(data) {
            const items = data.actionItems;
            document.getElementById('actionItemsSection').innerHTML = items.map(item => {
                const color = item.priority === 'high' ? 'red' : 'yellow';
                return `
                    <div class="flex items-start p-4 bg-${color}-50 rounded-lg border border-${color}-200">
                        <div class="p-2 bg-${color}-100 rounded-lg mr-4">
                            <i class="fas fa-${item.priority === 'high' ? 'fire' : 'clock'} text-${color}-600"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <h4 class="font-semibold text-gray-900">${item.task}</h4>
                                <span class="text-xs px-2 py-1 bg-${color}-100 text-${color}-800 rounded font-semibold">${item.priority.toUpperCase()}</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Expected Impact: ${item.impact}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateActionChart() {
            if (!dashboardData) return;

            const ctx = document.getElementById('actionBreakdownChart').getContext('2d');

            if (actionBreakdownChart) {
                actionBreakdownChart.destroy();
            }

            actionBreakdownChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Booking Clicks', 'Phone Clicks'],
                    datasets: [{
                        data: [dashboardData.bookingClicks, dashboardData.phoneClicks],
                        backgroundColor: ['#10b981', '#3b82f6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        async function refreshData() {
            document.getElementById('lastUpdated').textContent = 'Refreshing...';

            const result = await fetchDashboardData();
            updateUI(result);
            updateActionChart();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadVersion();
            await refreshData();
        });
    </script>
</body>
</html>
