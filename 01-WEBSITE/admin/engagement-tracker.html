<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engagement & Conversions - Chris David Salon Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .metric-card { transition: all 0.3s; }
        .metric-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .data-live { background-color: #dcfce7; color: #166534; }
        .data-manual { background-color: #fef3c7; color: #92400e; }
        .data-error { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="index.html" class="text-gray-600 hover:text-gray-900"><i class="fas fa-arrow-left"></i></a>
                <h1 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-chart-bar text-purple-600 mr-2"></i>Engagement & Conversions
                </h1>
                <span id="versionBadge" class="bg-purple-100 text-purple-800 text-xs font-semibold px-2.5 py-0.5 rounded">Loading...</span>
            </div>
            <div class="flex items-center space-x-4">
                <span id="dataSourceBadge" class="text-xs font-semibold px-2.5 py-0.5 rounded data-manual">Checking...</span>
                <span id="lastUpdated" class="text-sm text-gray-500">Loading...</span>
                <button onclick="refreshData()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
            </div>
        </div>
    </header>

    <nav class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex space-x-4 overflow-x-auto py-2">
                <a href="index.html" class="px-4 py-2 text-gray-600 hover:text-purple-600 whitespace-nowrap">SEO Score</a>
                <a href="visitor-metrics.html" class="px-4 py-2 text-gray-600 hover:text-purple-600 whitespace-nowrap">Traffic</a>
                <a href="engagement-tracker.html" class="px-4 py-2 text-purple-600 border-b-2 border-purple-600 font-semibold whitespace-nowrap">Conversions</a>
                <a href="competitors.html" class="px-4 py-2 text-gray-600 hover:text-purple-600 whitespace-nowrap">Competitors</a>
                <a href="rankings.html" class="px-4 py-2 text-gray-600 hover:text-purple-600 whitespace-nowrap">Rankings</a>
                <a href="seo-action-plan.html" class="px-4 py-2 text-gray-600 hover:text-purple-600 whitespace-nowrap">Action Plan</a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Data Source Warning -->
        <div id="dataWarning" class="mb-6 p-4 rounded-xl bg-yellow-50 border border-yellow-200">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-3"></i>
                <div>
                    <h4 class="font-bold text-yellow-800">Data Source Notice</h4>
                    <p class="text-sm text-yellow-700" id="dataWarningMessage">
                        Engagement data from last observed Google Analytics snapshot. Real-time tracking requires GA4 API integration.
                    </p>
                </div>
            </div>
        </div>

        <!-- KPI Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 metric-card border-t-4 border-green-500">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <i class="fas fa-calendar-check text-green-600 text-xl"></i>
                    </div>
                </div>
                <h3 class="text-gray-500 text-sm font-medium">Booking Clicks</h3>
                <p class="text-3xl font-bold text-gray-900" id="bookingClicks">--</p>
                <p class="text-sm text-gray-500 mt-1" id="bookingMonth">Loading...</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 metric-card border-t-4 border-blue-500">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <i class="fas fa-phone text-blue-600 text-xl"></i>
                    </div>
                </div>
                <h3 class="text-gray-500 text-sm font-medium">Phone Clicks</h3>
                <p class="text-3xl font-bold text-gray-900" id="phoneClicks">--</p>
                <p class="text-sm text-gray-500 mt-1" id="phoneMonth">Loading...</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 metric-card border-t-4 border-yellow-500">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-yellow-100 rounded-lg">
                        <i class="fas fa-directions text-yellow-600 text-xl"></i>
                    </div>
                </div>
                <h3 class="text-gray-500 text-sm font-medium">Direction Requests</h3>
                <p class="text-3xl font-bold text-gray-900" id="directionsClicks">--</p>
                <p class="text-sm text-gray-500 mt-1">Google Maps</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 metric-card border-t-4 border-purple-500">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <i class="fas fa-users text-purple-600 text-xl"></i>
                    </div>
                </div>
                <h3 class="text-gray-500 text-sm font-medium">Total Visitors</h3>
                <p class="text-3xl font-bold text-gray-900" id="totalVisitors">--</p>
                <p class="text-sm text-gray-500 mt-1" id="visitorMonth">Loading...</p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 metric-card border-t-4 border-red-500">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-3 bg-red-100 rounded-lg">
                        <i class="fas fa-percentage text-red-600 text-xl"></i>
                    </div>
                </div>
                <h3 class="text-gray-500 text-sm font-medium">Conversion Rate</h3>
                <p class="text-3xl font-bold text-gray-900" id="conversionRate">--</p>
                <p class="text-sm text-gray-500 mt-1">Visitor â†’ Action</p>
            </div>
        </div>

        <!-- Conversion Funnel -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-lg font-bold text-gray-900 mb-6">
                <i class="fas fa-filter text-blue-600 mr-2"></i>Conversion Funnel
                <span id="funnelDataSource" class="text-xs font-normal text-gray-500 ml-2">(Loading...)</span>
            </h3>
            <div id="funnelContainer" class="flex items-center justify-center">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading funnel data...</p>
                </div>
            </div>
        </div>

        <!-- API Status -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
                <i class="fas fa-plug text-blue-600 mr-2"></i>Data Connections
            </h3>
            <div id="apiStatusPanel" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Setup Instructions -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
                <i class="fas fa-tasks text-yellow-600 mr-2"></i>To Enable Real-Time Engagement Tracking
            </h3>
            <div class="space-y-4">
                <div class="flex items-start p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="p-2 bg-blue-100 rounded-lg mr-4">
                        <i class="fas fa-code text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900">1. Verify GA4 Event Tracking</h4>
                        <p class="text-gray-600 text-sm mt-1">Ensure booking clicks, phone clicks, and direction requests are set up as GA4 events.</p>
                        <p class="text-xs text-gray-500 mt-2">GA Property ID: G-XQDLWZM5NV</p>
                    </div>
                </div>
                <div class="flex items-start p-4 bg-green-50 rounded-lg border border-green-200">
                    <div class="p-2 bg-green-100 rounded-lg mr-4">
                        <i class="fas fa-key text-green-600"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900">2. Enable GA4 Data API</h4>
                        <p class="text-gray-600 text-sm mt-1">Create service account credentials in Google Cloud Console.</p>
                    </div>
                </div>
                <div class="flex items-start p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="p-2 bg-purple-100 rounded-lg mr-4">
                        <i class="fas fa-cog text-purple-600"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900">3. Add Credentials to Vercel</h4>
                        <p class="text-gray-600 text-sm mt-1">Add GOOGLE_ANALYTICS_PROPERTY_ID and service account JSON to environment variables.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // NO HARDCODED DATA - Everything from API
        let engagementData = null;

        async function loadVersion() {
            try {
                const response = await fetch('/data/version.json');
                const data = await response.json();
                document.getElementById('versionBadge').textContent = `v${data.version}`;
            } catch (e) {
                document.getElementById('versionBadge').textContent = 'v?.?.?';
            }
        }

        async function fetchEngagementData() {
            try {
                const response = await fetch('/api/analytics?type=engagement');
                const result = await response.json();
                engagementData = result;
                return result;
            } catch (error) {
                console.error('Error fetching engagement data:', error);
                return { success: false, error: error.message };
            }
        }

        function updateUI(data) {
            const badge = document.getElementById('dataSourceBadge');

            if (!data.success) {
                badge.className = 'text-xs font-semibold px-2.5 py-0.5 rounded data-error';
                badge.textContent = 'API Error';
                return;
            }

            badge.className = 'text-xs font-semibold px-2.5 py-0.5 rounded data-manual';
            badge.textContent = data.dataSource === 'manual-ga-observation' ? 'Manual Observation' : data.dataSource;

            document.getElementById('dataWarningMessage').textContent = data.disclaimer || 'Data from API';

            // Update metrics
            const engagement = data.engagement || {};
            document.getElementById('bookingClicks').textContent = engagement.bookingClicks || '--';
            document.getElementById('phoneClicks').textContent = engagement.phoneClicks || '--';
            document.getElementById('directionsClicks').textContent = engagement.directionsClicks || '--';
            document.getElementById('conversionRate').textContent = engagement.conversionRate ? engagement.conversionRate + '%' : '--';

            const month = engagement.dataMonth || 'Unknown';
            document.getElementById('bookingMonth').textContent = month;
            document.getElementById('phoneMonth').textContent = month;
            document.getElementById('visitorMonth').textContent = month;

            // Fetch visitor data for total
            fetchVisitorData();

            document.getElementById('lastUpdated').textContent = `Updated: ${new Date(data.timestamp).toLocaleString()}`;

            // Update funnel
            updateFunnel(engagement);
        }

        async function fetchVisitorData() {
            try {
                const response = await fetch('/api/analytics?type=visitors');
                const result = await response.json();
                if (result.success && result.currentData) {
                    document.getElementById('totalVisitors').textContent = result.currentData.visitors || '--';
                }
            } catch (e) {
                document.getElementById('totalVisitors').textContent = '--';
            }
        }

        function updateFunnel(engagement) {
            const visitors = 247; // From last known data
            const bookings = engagement.bookingClicks || 28;
            const phone = engagement.phoneClicks || 45;
            const directions = engagement.directionsClicks || 12;
            const totalActions = bookings + phone + directions;
            const conversionRate = ((totalActions / visitors) * 100).toFixed(1);

            document.getElementById('funnelDataSource').textContent = `(${engagement.dataMonth || 'Last observed'})`;

            document.getElementById('funnelContainer').innerHTML = `
                <div class="w-full max-w-4xl">
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <div class="flex-1">
                                <div class="bg-blue-500 text-white py-4 px-6 rounded-lg text-center" style="width: 100%;">
                                    <span class="font-bold text-xl">${visitors}</span>
                                    <span class="block text-sm">Website Visitors</span>
                                </div>
                            </div>
                            <div class="ml-4 text-gray-500 text-sm">100%</div>
                        </div>
                        <div class="flex items-center">
                            <div class="flex-1">
                                <div class="bg-blue-400 text-white py-4 px-6 rounded-lg text-center mx-auto" style="width: ${Math.round(totalActions/visitors*100)}%;">
                                    <span class="font-bold text-xl">${totalActions}</span>
                                    <span class="block text-sm">Total Actions</span>
                                </div>
                            </div>
                            <div class="ml-4 text-gray-500 text-sm">${Math.round(totalActions/visitors*100)}%</div>
                        </div>
                        <div class="flex items-center">
                            <div class="flex-1">
                                <div class="bg-green-500 text-white py-4 px-6 rounded-lg text-center mx-auto" style="width: ${Math.round(bookings/visitors*100)}%;">
                                    <span class="font-bold text-xl">${bookings}</span>
                                    <span class="block text-sm">Booking Clicks</span>
                                </div>
                            </div>
                            <div class="ml-4 text-green-600 font-bold text-sm">${(bookings/visitors*100).toFixed(1)}%</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateAPIStatus() {
            const panel = document.getElementById('apiStatusPanel');
            const apis = [
                {
                    name: 'Google Analytics',
                    status: engagementData?.apiStatus?.googleAnalytics?.connected ? 'connected' : 'not-connected',
                    message: engagementData?.apiStatus?.googleAnalytics?.message || 'API integration required',
                    icon: 'fa-chart-bar'
                },
                {
                    name: 'Boulevard Booking',
                    status: 'not-connected',
                    message: 'Integration for actual booking data',
                    icon: 'fa-calendar-check'
                },
                {
                    name: 'Call Tracking',
                    status: 'not-connected',
                    message: 'CallRail or similar for phone tracking',
                    icon: 'fa-phone'
                }
            ];

            const statusColors = {
                'connected': 'bg-green-100 text-green-800 border-green-200',
                'not-connected': 'bg-gray-100 text-gray-600 border-gray-200'
            };

            panel.innerHTML = apis.map(api => `
                <div class="flex items-center justify-between p-4 rounded-lg border ${statusColors[api.status]}">
                    <div class="flex items-center">
                        <i class="fas ${api.icon} mr-3 text-xl"></i>
                        <div>
                            <div class="font-semibold">${api.name}</div>
                            <div class="text-xs opacity-75">${api.message}</div>
                        </div>
                    </div>
                    <span class="text-xs font-bold">${api.status === 'connected' ? 'Connected' : 'Not Setup'}</span>
                </div>
            `).join('');
        }

        async function refreshData() {
            document.getElementById('lastUpdated').textContent = 'Refreshing...';
            const data = await fetchEngagementData();
            updateUI(data);
            updateAPIStatus();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadVersion();
            await refreshData();
        });
    </script>
</body>
</html>
