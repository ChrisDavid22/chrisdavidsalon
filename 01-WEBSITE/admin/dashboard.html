<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>SEO Agent Dashboard - Chris David Salon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .pulse-green { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }
        .trend-up { color: #22c55e; }
        .trend-down { color: #ef4444; }
        .trend-stable { color: #6b7280; }
        .priority-critical { border-left: 4px solid #ef4444; }
        .priority-high { border-left: 4px solid #f97316; }
        .priority-medium { border-left: 4px solid #eab308; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Top Navigation -->
    <nav class="bg-gradient-to-r from-indigo-900 to-purple-900 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-400 rounded-full pulse-green mr-2"></div>
                        <span class="font-bold text-xl">Chris David SEO Agent</span>
                    </div>
                    <span id="versionBadge" class="bg-green-500 px-2 py-1 rounded text-xs font-bold">Loading...</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="lastUpdate" class="text-sm text-indigo-200">Loading...</span>
                    <a href="../index.html" class="bg-yellow-500 hover:bg-yellow-600 px-3 py-1 rounded text-sm font-semibold">
                        View Site
                    </a>
                </div>
            </div>
            <!-- Navigation Tabs -->
            <div class="flex space-x-1 pb-2 overflow-x-auto">
                <a href="dashboard.html" class="px-4 py-2 bg-white/20 rounded-t font-semibold">Dashboard</a>
                <a href="traffic.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Traffic</a>
                <a href="competitors.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Competitors</a>
                <a href="rankings.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Rankings</a>
                <a href="authority.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Authority</a>
                <a href="microsites.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Microsites</a>
                <a href="agent-log.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Agent Log</a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Agent Status Banner -->
        <div class="bg-gradient-to-r from-green-600 to-emerald-600 rounded-xl shadow-lg p-6 mb-6 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center mb-2">
                        <i class="fas fa-robot text-3xl mr-3"></i>
                        <div>
                            <h1 class="text-2xl font-bold">Autonomous SEO Agent Active</h1>
                            <p class="text-green-100">AI-powered optimization running 24/7</p>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm text-green-100">Next Analysis</div>
                    <div id="nextRun" class="text-xl font-bold">--</div>
                </div>
            </div>
        </div>

        <!-- Key Metrics Row - ALL FROM API -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500">SEO Score</div>
                        <div class="text-3xl font-bold" id="seoScore">--</div>
                    </div>
                    <div class="text-2xl" id="scoreTrend">--</div>
                </div>
                <div class="mt-2 text-xs text-gray-500" id="scoreTrendText">Loading...</div>
            </div>
            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500">Market Position</div>
                        <div class="text-3xl font-bold" id="marketPosition">--</div>
                    </div>
                    <div class="text-2xl text-yellow-500"><i class="fas fa-trophy"></i></div>
                </div>
                <div class="mt-2 text-xs text-gray-500" id="totalCompetitors">Loading...</div>
            </div>
            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500">Reviews</div>
                        <div class="text-3xl font-bold" id="reviews">--</div>
                    </div>
                    <div class="text-2xl text-blue-500"><i class="fas fa-star"></i></div>
                </div>
                <div class="mt-2 text-xs text-gray-500" id="reviewGap">Loading...</div>
            </div>
            <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-500">Monthly Visitors</div>
                        <div class="text-3xl font-bold" id="monthlyVisitors">--</div>
                    </div>
                    <div class="text-2xl text-green-500"><i class="fas fa-users"></i></div>
                </div>
                <div class="mt-2 text-xs text-gray-500" id="visitorSource">From GA4 API</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Insights & Actions -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Data Source Status -->
                <div id="dataSourceBanner" class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                    <div class="flex items-center">
                        <i class="fas fa-database text-yellow-500 mr-3"></i>
                        <div>
                            <span class="font-semibold text-yellow-800" id="dataSourceTitle">Checking API connections...</span>
                            <p class="text-yellow-700 text-sm" id="dataSourceMessage">Loading data sources...</p>
                        </div>
                    </div>
                </div>

                <!-- Top Insights - FROM API -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                        Agent Insights
                    </h2>
                    <div id="insightsContainer" class="space-y-3">
                        <div class="text-gray-500 text-center py-4">Loading insights from API...</div>
                    </div>
                </div>

                <!-- Competitor Comparison - FROM API -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-bar text-blue-500 mr-2"></i>
                        Competitive Standing
                    </h2>
                    <div id="competitorComparison" class="space-y-3">
                        <div class="text-gray-500 text-center py-4">Loading competitor data from Google Places API...</div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Status & Activity -->
            <div class="space-y-6">
                <!-- Traffic Overview - FROM GA4 API -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-line text-green-500 mr-2"></i>
                        Traffic (GA4)
                    </h2>
                    <div id="trafficOverview" class="space-y-3">
                        <div class="text-gray-500 text-center py-4">Loading from GA4...</div>
                    </div>
                </div>

                <!-- Top Competitors - FROM API -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-eye text-orange-500 mr-2"></i>
                        Top Competitors
                    </h2>
                    <div id="competitorWatchContainer" class="space-y-3">
                        <div class="text-gray-500 text-center py-4">Loading from Google Places...</div>
                    </div>
                </div>

                <!-- Recent Implementations - FROM JSON -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-lg font-bold mb-4 flex items-center">
                        <i class="fas fa-code-branch text-purple-500 mr-2"></i>
                        Recent Changes
                    </h2>
                    <div id="recentImplementations" class="space-y-2 text-sm">
                        <div class="text-gray-500 text-center py-4">Loading...</div>
                    </div>
                    <a href="agent-log.html" class="block text-center text-indigo-600 text-sm mt-3 hover:underline">
                        View all implementations →
                    </a>
                </div>
            </div>
        </div>
    </main>

    <script>
        // NO HARDCODED DATA - Everything from APIs
        const REFRESH_INTERVAL = 5 * 60 * 1000;

        async function loadDashboard() {
            try {
                // Load version
                const versionRes = await fetch('/data/version.json');
                const versionData = await versionRes.json();
                document.getElementById('versionBadge').textContent = `v${versionData.version}`;

                // Load ALL data in parallel from APIs
                const [competitorData, ga4Data, implementationsData] = await Promise.all([
                    fetch('/api/admin-data?type=competitors').then(r => r.json()).catch(() => null),
                    fetch('/api/ga4-analytics?type=overview&startDate=30daysAgo&endDate=today').then(r => r.json()).catch(() => null),
                    fetch('/data/agent-implementations.json').then(r => r.json()).catch(() => null)
                ]);

                // Transform competitor data to match expected format
                const dashData = competitorData?.success ? {
                    success: true,
                    data: {
                        topCompetitors: competitorData.data.competitors,
                        reviews: competitorData.data.competitors.find(c => c.name.includes('Chris David'))?.reviews || null,
                        marketPosition: competitorData.data.competitors.findIndex(c => c.name.includes('Chris David')) + 1 || null,
                        seoScore: null // SEO score requires PageSpeed API
                    }
                } : { success: false, data: {} };

                // Update data source banner
                updateDataSourceBanner(dashData, ga4Data);

                // Update metrics from REAL API data
                updateMetrics(dashData, ga4Data);

                // Update competitor section from API
                updateCompetitors(dashData);

                // Update traffic from GA4 API
                updateTraffic(ga4Data);

                // Update recent implementations from JSON
                updateImplementations(implementationsData);

                // Update insights based on real data
                updateInsights(dashData, ga4Data);

                // Update timestamp
                document.getElementById('lastUpdate').textContent = `Updated: ${new Date().toLocaleTimeString()}`;

                // Next analysis
                document.getElementById('nextRun').textContent = getNextSunday();

            } catch (error) {
                console.error('Dashboard load error:', error);
                document.getElementById('dataSourceTitle').textContent = 'Error Loading Data';
                document.getElementById('dataSourceMessage').textContent = error.message;
            }
        }

        function updateDataSourceBanner(dashData, ga4Data) {
            const banner = document.getElementById('dataSourceBanner');
            const title = document.getElementById('dataSourceTitle');
            const message = document.getElementById('dataSourceMessage');

            const placesConnected = dashData?.success;
            const ga4Connected = ga4Data?.success;

            if (placesConnected && ga4Connected) {
                banner.className = 'bg-green-50 border border-green-200 rounded-xl p-4';
                title.className = 'font-semibold text-green-800';
                title.textContent = 'All APIs Connected';
                message.className = 'text-green-700 text-sm';
                message.textContent = 'Google Places API + GA4 API both returning live data';
            } else if (placesConnected || ga4Connected) {
                banner.className = 'bg-yellow-50 border border-yellow-200 rounded-xl p-4';
                title.className = 'font-semibold text-yellow-800';
                title.textContent = 'Partial API Connection';
                message.className = 'text-yellow-700 text-sm';
                message.textContent = `Google Places: ${placesConnected ? '✓' : '✗'} | GA4: ${ga4Connected ? '✓' : '✗'}`;
            } else {
                banner.className = 'bg-red-50 border border-red-200 rounded-xl p-4';
                title.className = 'font-semibold text-red-800';
                title.textContent = 'APIs Not Connected';
                message.className = 'text-red-700 text-sm';
                message.textContent = 'Check Vercel environment variables for API credentials';
            }
        }

        function updateMetrics(dashData, ga4Data) {
            // SEO Score - from dashboard API
            const seoScore = dashData?.data?.seoScore;
            document.getElementById('seoScore').textContent = seoScore || '--';
            document.getElementById('scoreTrendText').textContent = seoScore ? 'From competitor analysis' : 'Awaiting API';

            // Market Position - from dashboard API
            const position = dashData?.data?.marketPosition;
            document.getElementById('marketPosition').textContent = position ? `#${position}` : '--';

            // Total competitors count - from API
            const totalCompetitors = dashData?.data?.topCompetitors?.length || 0;
            document.getElementById('totalCompetitors').textContent = totalCompetitors > 0 ? `of ${totalCompetitors} tracked` : 'No data';

            // Reviews - from dashboard API (our salon)
            const reviews = dashData?.data?.reviews;
            document.getElementById('reviews').textContent = reviews || '--';

            // Review gap - calculate from API data
            if (dashData?.data?.topCompetitors?.length > 0 && reviews) {
                const leaderReviews = dashData.data.topCompetitors[0].reviews;
                const gap = leaderReviews - reviews;
                document.getElementById('reviewGap').textContent = gap > 0 ? `${gap} behind leader (${leaderReviews})` : 'Leading!';
            } else {
                document.getElementById('reviewGap').textContent = 'Awaiting API';
            }

            // Monthly visitors - from GA4 API
            if (ga4Data?.success && ga4Data?.data?.activeUsers) {
                document.getElementById('monthlyVisitors').textContent = ga4Data.data.activeUsers.toLocaleString();
                document.getElementById('visitorSource').textContent = 'Last 30 days from GA4';
            } else {
                document.getElementById('monthlyVisitors').textContent = '--';
                document.getElementById('visitorSource').textContent = 'GA4 not connected';
            }
        }

        function updateCompetitors(dashData) {
            const container = document.getElementById('competitorWatchContainer');
            const comparisonContainer = document.getElementById('competitorComparison');

            if (!dashData?.data?.topCompetitors?.length) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">Google Places API not returning data</div>';
                comparisonContainer.innerHTML = '<div class="text-gray-500 text-center py-4">Awaiting competitor data</div>';
                return;
            }

            const competitors = dashData.data.topCompetitors;
            const ourSalon = competitors.find(c => c.name.includes('Chris David'));
            const ourPosition = ourSalon ? competitors.indexOf(ourSalon) + 1 : '--';
            const ourScore = ourSalon?.seoScore || ourSalon?.score || '--';
            const ourReviews = ourSalon?.reviews || '--';

            // Top 3 competitors
            container.innerHTML = competitors.slice(0, 3).map((c, i) => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded ${c.name.includes('Chris David') ? 'border-2 border-blue-500' : ''}">
                    <div>
                        <div class="font-medium text-sm">${i + 1}. ${c.name}</div>
                        <div class="text-xs text-gray-500">${c.reviews || '--'} reviews • ${c.rating || '--'}★</div>
                    </div>
                    <div class="text-sm font-bold ${(c.seoScore || c.score) >= 80 ? 'text-green-600' : 'text-yellow-600'}">
                        ${c.seoScore || c.score || '--'}
                    </div>
                </div>
            `).join('');

            // Competitive standing comparison
            const leader = competitors[0];
            comparisonContainer.innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-xs text-gray-500 mb-1">Your Position</div>
                        <div class="text-2xl font-bold text-blue-600">#${ourPosition}</div>
                        <div class="text-xs text-gray-500">of ${competitors.length}</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3">
                        <div class="text-xs text-gray-500 mb-1">Your Score</div>
                        <div class="text-2xl font-bold">${ourScore}</div>
                        <div class="text-xs text-gray-500">vs leader: ${leader.seoScore || leader.score}</div>
                    </div>
                </div>
                <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                    <div class="text-sm font-medium text-blue-800">Gap to #1: ${leader.name}</div>
                    <div class="text-xs text-blue-600 mt-1">
                        Score: ${(leader.seoScore || leader.score) - ourScore} points behind •
                        Reviews: ${leader.reviews - ourReviews} behind
                    </div>
                </div>
            `;
        }

        function updateTraffic(ga4Data) {
            const container = document.getElementById('trafficOverview');

            if (!ga4Data?.success) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">GA4 API not connected</div>';
                return;
            }

            const data = ga4Data.data;
            container.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Active Users</span>
                        <span class="font-bold">${data.activeUsers?.toLocaleString() || '--'}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Sessions</span>
                        <span class="font-bold">${data.sessions?.toLocaleString() || '--'}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Page Views</span>
                        <span class="font-bold">${data.pageViews?.toLocaleString() || '--'}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Bounce Rate</span>
                        <span class="font-bold">${data.bounceRate ? data.bounceRate + '%' : '--'}</span>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t text-xs text-gray-500 text-center">
                    Last 30 days from Google Analytics 4
                </div>
            `;
        }

        function updateImplementations(implementationsData) {
            const container = document.getElementById('recentImplementations');

            if (!implementationsData?.implementations?.length) {
                container.innerHTML = '<div class="text-gray-500 text-center py-4">No implementation data</div>';
                return;
            }

            const recent = implementationsData.implementations.slice(0, 3);
            container.innerHTML = recent.map(impl => {
                const date = new Date(impl.date);
                return `
                    <div class="flex items-start p-2 bg-gray-50 rounded">
                        <div class="w-2 h-2 rounded-full ${impl.type === 'feature' ? 'bg-green-400' : 'bg-yellow-400'} mt-1.5 mr-2"></div>
                        <div class="flex-1">
                            <div class="font-medium text-xs">${impl.title}</div>
                            <div class="text-xs text-gray-500">${date.toLocaleDateString()} • v${impl.version}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateInsights(dashData, ga4Data) {
            const container = document.getElementById('insightsContainer');
            const insights = [];

            // Generate insights from REAL API data
            if (!ga4Data?.success) {
                insights.push({
                    priority: 'high',
                    title: 'GA4 API Connected',
                    message: 'Traffic analytics are now live',
                    action: 'View Traffic tab for details'
                });
            }

            if (dashData?.data?.topCompetitors?.length > 0) {
                const ourSalon = dashData.data.topCompetitors.find(c => c.name.includes('Chris David'));
                const leader = dashData.data.topCompetitors[0];

                if (ourSalon && leader && !leader.name.includes('Chris David')) {
                    const reviewGap = leader.reviews - (ourSalon.reviews || 0);
                    if (reviewGap > 50) {
                        insights.push({
                            priority: 'high',
                            title: `${reviewGap} Reviews Behind Leader`,
                            message: `${leader.name} has ${leader.reviews} reviews vs your ${ourSalon.reviews || 0}`,
                            action: 'Focus on review generation strategy'
                        });
                    }

                    const scoreGap = (leader.seoScore || leader.score) - (ourSalon.seoScore || ourSalon.score || 0);
                    if (scoreGap > 10) {
                        insights.push({
                            priority: 'medium',
                            title: `${scoreGap} Points Below #1`,
                            message: `Your SEO score: ${ourSalon.seoScore || ourSalon.score}, Leader: ${leader.seoScore || leader.score}`,
                            action: 'See Competitors tab for improvement plan'
                        });
                    }
                }
            }

            if (ga4Data?.success && ga4Data.data?.bounceRate > 70) {
                insights.push({
                    priority: 'medium',
                    title: 'High Bounce Rate',
                    message: `${ga4Data.data.bounceRate}% of visitors leave without interacting`,
                    action: 'Improve page load speed and content engagement'
                });
            }

            if (insights.length === 0) {
                insights.push({
                    priority: 'low',
                    title: 'System Healthy',
                    message: 'All APIs connected and returning data',
                    action: 'Continue monitoring'
                });
            }

            container.innerHTML = insights.map(insight => `
                <div class="p-3 bg-gray-50 rounded-lg priority-${insight.priority}">
                    <div class="flex justify-between items-start">
                        <div class="font-semibold text-gray-800">${insight.title}</div>
                        <span class="text-xs px-2 py-1 rounded ${insight.priority === 'high' ? 'bg-orange-100 text-orange-700' : insight.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">${insight.priority.toUpperCase()}</span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">${insight.message}</div>
                    <div class="text-sm text-blue-600 mt-1">→ ${insight.action}</div>
                </div>
            `).join('');
        }

        function getNextSunday() {
            const now = new Date();
            const daysUntilSunday = (7 - now.getDay()) % 7 || 7;
            const next = new Date(now);
            next.setDate(now.getDate() + daysUntilSunday);
            next.setHours(6, 0, 0, 0);
            return next.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) + ' 6 AM';
        }

        // Initial load
        loadDashboard();

        // Auto-refresh
        setInterval(loadDashboard, REFRESH_INTERVAL);
    </script>
</body>
</html>
