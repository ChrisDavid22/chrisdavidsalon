<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Competitor Analysis - Chris David Salon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="ai-config.js"></script>
    <style>
        .pulse-green { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Top Navigation -->
    <nav class="bg-gradient-to-r from-indigo-900 to-purple-900 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-400 rounded-full pulse-green mr-2"></div>
                        <span class="font-bold text-xl">Chris David SEO Agent</span>
                    </div>
                    <span id="versionBadge" class="bg-green-500 px-2 py-1 rounded text-xs font-bold">Loading...</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="lastUpdate" class="text-sm text-indigo-200">Loading...</span>
                    <a href="../index.html" class="bg-yellow-500 hover:bg-yellow-600 px-3 py-1 rounded text-sm font-semibold">
                        View Site
                    </a>
                </div>
            </div>
            <!-- Navigation Tabs -->
            <div class="flex space-x-1 pb-2 overflow-x-auto">
                <a href="dashboard.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Dashboard</a>
                <a href="traffic.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Traffic</a>
                <a href="competitors.html" class="px-4 py-2 bg-white/20 rounded-t font-semibold">Competitors</a>
                <a href="rankings.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Rankings</a>
                <a href="authority.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Authority</a>
                <a href="agent-log.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Agent Log</a>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6">
        
        <!-- Market Position Overview -->
        <div class="bg-gradient-to-r from-red-600 to-orange-600 text-white rounded-lg shadow-xl p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <h2 class="text-3xl font-bold mb-2">Your Market Position</h2>
                    <div class="text-5xl font-bold" id="marketPosition">#15</div>
                    <p class="text-orange-100">out of 47 Delray Beach salons</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-2">Your SEO Score</h3>
                    <div class="text-5xl font-bold" id="ourScore">73</div>
                    <p class="text-orange-100">Target: 88+ for Top 3</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-2">Gap to #1</h3>
                    <div class="text-5xl font-bold" id="gapToFirst">-16</div>
                    <p class="text-orange-100">points behind leader</p>
                </div>
            </div>
            
            <button onclick="analyzeAllCompetitors()" class="mt-6 bg-white text-orange-600 px-8 py-4 rounded-lg hover:bg-orange-50 font-bold text-lg">
                <i class="fas fa-chart-line mr-2"></i>Analyze Top 10 Competitors Now
            </button>
        </div>

        <!-- SEO Score Comparison Chart -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-2xl font-bold mb-6">üìä SEO Score Comparison (0-100 Scale)</h3>
            <div id="competitorChart" class="relative">
                <canvas id="seoComparisonChart" height="400"></canvas>
            </div>
            <div id="loadingChart" class="hidden absolute inset-0 bg-white/90 flex items-center justify-center">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-5xl text-blue-600 mb-4"></i>
                    <p class="text-xl">Analyzing competitors with AI...</p>
                </div>
            </div>
        </div>

        <!-- Top 10 Competitors Grid -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-2xl font-bold mb-6">üèÜ Top 10 Competitors - Detailed Analysis</h3>
            <div id="competitorsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Competitive Advantages & Gaps -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- What They Have That We Don't -->
            <div class="bg-red-50 rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4 text-red-800">‚ùå Gaps to Close</h3>
                <ul id="competitiveGaps" class="space-y-3">
                    <li class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-red-500 mt-1 mr-3"></i>
                        <div>
                            <strong>Content Depth:</strong> Rov√© has 47 indexed pages vs our 12
                        </div>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-red-500 mt-1 mr-3"></i>
                        <div>
                            <strong>Schema Markup:</strong> 8 competitors have LocalBusiness schema
                        </div>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-red-500 mt-1 mr-3"></i>
                        <div>
                            <strong>Location Pages:</strong> Bond Street has 5 neighborhood pages
                        </div>
                    </li>
                </ul>
            </div>
            
            <!-- Our Unique Advantages -->
            <div class="bg-green-50 rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4 text-green-800">‚úÖ Our Advantages</h3>
                <ul id="ourAdvantages" class="space-y-3">
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                        <div>
                            <strong>Exclusive Davines:</strong> Only certified salon in Delray
                        </div>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                        <div>
                            <strong>Free Parking:</strong> Major differentiator downtown
                        </div>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                        <div>
                            <strong>20+ Years:</strong> Chris's educator credentials
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Action Plan -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg shadow-lg p-6">
            <h3 class="text-2xl font-bold mb-4">üéØ Action Plan to Beat Competitors</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-lg">
                    <h4 class="font-bold text-blue-800 mb-2">Week 1: Quick Wins</h4>
                    <ul class="text-sm space-y-1">
                        <li>‚Ä¢ Add schema markup (+8 points)</li>
                        <li>‚Ä¢ Fix meta descriptions (+3 points)</li>
                        <li>‚Ä¢ Optimize images (+2 points)</li>
                    </ul>
                    <p class="mt-3 text-green-600 font-bold">+13 points ‚Üí Score: 86</p>
                </div>
                <div class="bg-white p-4 rounded-lg">
                    <h4 class="font-bold text-purple-800 mb-2">Month 1: Content</h4>
                    <ul class="text-sm space-y-1">
                        <li>‚Ä¢ Create service pages (+5 points)</li>
                        <li>‚Ä¢ Add location pages (+4 points)</li>
                        <li>‚Ä¢ Build FAQ section (+2 points)</li>
                    </ul>
                    <p class="mt-3 text-green-600 font-bold">+11 points ‚Üí Score: 97</p>
                </div>
                <div class="bg-white p-4 rounded-lg">
                    <h4 class="font-bold text-indigo-800 mb-2">Quarter 1: Authority</h4>
                    <ul class="text-sm space-y-1">
                        <li>‚Ä¢ Get 30 new reviews (+3 points)</li>
                        <li>‚Ä¢ Build backlinks (+4 points)</li>
                        <li>‚Ä¢ Launch microsites (+3 points)</li>
                    </ul>
                    <p class="mt-3 text-green-600 font-bold">+10 points ‚Üí Score: 107</p>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <a href="../SEO-TODO-LIST.md" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-bold">
                    <i class="fas fa-tasks mr-2"></i>View Full SEO TODO List
                </a>
            </div>
        </div>
    </div>

    <script>
    // Competitor data loaded from API
    let competitorData = [];

    // Load competitors from API on page load
    async function loadCompetitors() {
        try {
            const response = await fetch('/api/admin-data?type=competitors');
            if (!response.ok) throw new Error('API failed');
            const result = await response.json();
            competitorData = result.data.competitors || [];

            // Display the data
            displayCompetitorChart(competitorData);
            displayCompetitorCards(competitorData);

            // Update market position display
            const ourSalon = competitorData.find(c => c.name.includes('Chris David'));
            if (ourSalon) {
                const position = competitorData.indexOf(ourSalon) + 1;
                document.getElementById('marketPosition').textContent = '#' + position;
                document.getElementById('ourScore').textContent = ourSalon.seoScore || ourSalon.score;

                const gap = competitorData[0].seoScore - ourSalon.seoScore;
                document.getElementById('gapToFirst').textContent = '-' + gap;
            }

        } catch (error) {
            console.error('Failed to load competitors:', error);
            document.getElementById('competitorsGrid').innerHTML = '<p class="text-red-500">Failed to load competitor data. Please refresh.</p>';
        }
    }

    // Analyze all competitors (refresh data)
    async function analyzeAllCompetitors() {
        const loadingEl = document.getElementById('loadingChart');
        if (loadingEl) loadingEl.classList.remove('hidden');

        try {
            // Reload from API
            await loadCompetitors();
            alert('Competitor analysis refreshed from API!');
        } catch (error) {
            console.error('Analysis error:', error);
            alert('Failed to refresh competitor data: ' + error.message);
        } finally {
            if (loadingEl) loadingEl.classList.add('hidden');
        }
    }

    // Store chart instance to destroy before recreating
    let competitorChart = null;

    // Display competitor comparison chart
    function displayCompetitorChart(competitors) {
        const canvas = document.getElementById('seoComparisonChart');
        const ctx = canvas.getContext('2d');

        // Destroy existing chart if it exists
        if (competitorChart) {
            competitorChart.destroy();
        }

        // Normalize score property (API uses seoScore, some use score)
        competitors = competitors.map(c => ({
            ...c,
            score: c.seoScore || c.score
        }));

        // Sort by score
        competitors.sort((a, b) => b.score - a.score);

        // Highlight Chris David
        const colors = competitors.map(c =>
            c.name.includes('Chris David') ? 'rgba(59, 130, 246, 0.8)' : 'rgba(239, 68, 68, 0.8)'
        );

        competitorChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: competitors.map(c => c.name),
                datasets: [{
                    label: 'SEO Score',
                    data: competitors.map(c => c.score),
                    backgroundColor: colors,
                    borderColor: colors.map(c => c.replace('0.8', '1')),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const competitor = competitors[context.dataIndex];
                                return `Reviews: ${competitor.reviews}\nGap: ${competitor.score - 73} points`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + ' pts';
                            }
                        }
                    }
                }
            }
        });
        
        // Update position metrics
        const ourPosition = competitors.findIndex(c => c.name.includes('Chris David')) + 1;
        const gap = competitors[0].score - 73;
        
        document.getElementById('marketPosition').textContent = '#' + ourPosition;
        document.getElementById('ourScore').textContent = '73';
        document.getElementById('gapToFirst').textContent = '-' + gap;
    }

    // Display competitor cards
    function displayCompetitorCards(competitors) {
        const grid = document.getElementById('competitorsGrid');
        grid.innerHTML = '';
        
        // Sort by score and take top 10
        competitors.sort((a, b) => b.score - a.score);
        competitors.slice(0, 10).forEach((competitor, index) => {
            const isUs = competitor.name.includes('Chris David');
            const card = document.createElement('div');
            card.className = `p-4 rounded-lg border-2 ${isUs ? 'bg-blue-50 border-blue-500' : 'bg-white border-gray-200'}`;
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h4 class="font-bold text-lg">${index + 1}. ${competitor.name}</h4>
                        <p class="text-sm text-gray-600">${competitor.url}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold ${competitor.score >= 80 ? 'text-green-600' : competitor.score >= 70 ? 'text-yellow-600' : 'text-red-600'}">
                            ${competitor.score}/100
                        </div>
                        <p class="text-xs text-gray-500">${competitor.reviews} reviews</p>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <span>Content Depth</span>
                        <div class="w-24 bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${Math.min(competitor.score * 1.1, 100)}%"></div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <span>Local SEO</span>
                        <div class="w-24 bg-gray-200 rounded-full h-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width: ${Math.min(competitor.score * 0.9, 100)}%"></div>
                        </div>
                    </div>
                </div>
                
                ${isUs ? '<div class="mt-3 text-blue-600 font-semibold text-sm">YOUR SALON</div>' : 
                  `<button onclick="compareWithCompetitor('${competitor.name}', '${competitor.url}')" 
                          class="mt-3 text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded">
                      <i class="fas fa-chart-bar mr-1"></i>Compare
                  </button>`}
            `;
            
            grid.appendChild(card);
        });
    }

    // Compare with specific competitor
    async function compareWithCompetitor(name, url) {
        try {
            const comparison = await window.AIConfig.compareWithCompetitor(name, url);
            
            // Show comparison in modal or alert
            alert(`Comparison with ${name}:\n\n` +
                  `Their advantages:\n${comparison.theirAdvantages.join('\n')}\n\n` +
                  `How to beat them:\n${comparison.actionPlan.join('\n')}`);
        } catch (error) {
            console.error('Comparison error:', error);
        }
    }

    // Update gap analysis
    function updateGapAnalysis(competitors) {
        // This would be populated with real analysis data
        // For now using intelligent defaults based on common SEO gaps
    }

    // Load version
    async function loadVersion() {
        try {
            const response = await fetch('/data/version.json');
            const data = await response.json();
            const versionBadge = document.getElementById('versionBadge');
            if (versionBadge && data.version) {
                versionBadge.textContent = `v${data.version}`;
            }
        } catch (e) {
            const versionBadge = document.getElementById('versionBadge');
            if (versionBadge) versionBadge.textContent = 'v?.?.?';
        }
    }

    // Initialize on page load
    window.addEventListener('load', () => {
        loadVersion();
        loadCompetitors();
    });
    </script>
</body>
</html>