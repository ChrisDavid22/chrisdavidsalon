<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Competitor Analysis - Chris David Salon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        .pulse-green { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Top Navigation -->
    <nav class="bg-gradient-to-r from-indigo-900 to-purple-900 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-400 rounded-full pulse-green mr-2"></div>
                        <span class="font-bold text-xl">Chris David SEO Agent</span>
                    </div>
                    <span id="versionBadge" class="bg-green-500 px-2 py-1 rounded text-xs font-bold">Loading...</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="lastUpdate" class="text-sm text-indigo-200">Loading...</span>
                    <a href="../index.html" class="bg-yellow-500 hover:bg-yellow-600 px-3 py-1 rounded text-sm font-semibold">
                        View Site
                    </a>
                </div>
            </div>
            <!-- Navigation Tabs -->
            <div class="flex space-x-1 pb-2 overflow-x-auto">
                <a href="dashboard.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Dashboard</a>
                <a href="traffic.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Traffic</a>
                <a href="competitors.html" class="px-4 py-2 bg-white/20 rounded-t font-semibold">Competitors</a>
                <a href="rankings.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Rankings</a>
                <a href="authority.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Authority</a>
                <a href="microsites.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Microsites</a>
                <a href="agent-log.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Agent Log</a>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6">

        <!-- Data Source Banner -->
        <div id="dataSourceBanner" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <i class="fas fa-database text-yellow-500 mr-3"></i>
                <div>
                    <span class="font-semibold text-yellow-800" id="dataSourceTitle">Loading competitor data...</span>
                    <p class="text-yellow-700 text-sm" id="dataSourceMessage">Fetching from Google Places API</p>
                </div>
            </div>
        </div>

        <!-- Market Position Overview - ALL FROM API -->
        <div class="bg-gradient-to-r from-red-600 to-orange-600 text-white rounded-lg shadow-xl p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <h2 class="text-3xl font-bold mb-2">Your Market Position</h2>
                    <div class="text-5xl font-bold" id="marketPosition">--</div>
                    <p class="text-orange-100" id="totalCompetitors">Loading...</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-2">Your SEO Score</h3>
                    <div class="text-5xl font-bold" id="ourScore">--</div>
                    <p class="text-orange-100" id="targetScore">From API analysis</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-2">Gap to #1</h3>
                    <div class="text-5xl font-bold" id="gapToFirst">--</div>
                    <p class="text-orange-100" id="leaderName">Loading...</p>
                </div>
            </div>

            <button onclick="analyzeAllCompetitors()" class="mt-6 bg-white text-orange-600 px-8 py-4 rounded-lg hover:bg-orange-50 font-bold text-lg">
                <i class="fas fa-sync-alt mr-2"></i>Refresh Competitor Data
            </button>
        </div>

        <!-- SEO Score Comparison Chart -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-2xl font-bold mb-6">SEO Score Comparison</h3>
            <div id="competitorChart" class="relative" style="height: 400px;">
                <canvas id="seoComparisonChart"></canvas>
            </div>
            <div id="loadingChart" class="hidden absolute inset-0 bg-white/90 flex items-center justify-center">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-5xl text-blue-600 mb-4"></i>
                    <p class="text-xl">Loading from Google Places API...</p>
                </div>
            </div>
        </div>

        <!-- Top Competitors Grid - ALL FROM API -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h3 class="text-2xl font-bold mb-6">Top Competitors - From Google Places API</h3>
            <div id="competitorsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading competitor data...</p>
                </div>
            </div>
        </div>

        <!-- Competitive Analysis - GENERATED FROM API DATA -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-red-50 rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4 text-red-800">Gaps to Close</h3>
                <div id="competitiveGaps" class="space-y-3">
                    <div class="text-gray-500 text-center py-4">Analyzing competitor data...</div>
                </div>
            </div>

            <div class="bg-green-50 rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4 text-green-800">Your Strengths</h3>
                <div id="ourAdvantages" class="space-y-3">
                    <div class="text-gray-500 text-center py-4">Analyzing your position...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // NO HARDCODED DATA - Everything from API
    let competitorData = [];
    let ourSalonData = null;

    async function loadCompetitors() {
        const loadingEl = document.getElementById('loadingChart');
        if (loadingEl) loadingEl.classList.remove('hidden');

        try {
            // Load version
            const versionRes = await fetch('/data/version.json');
            const versionData = await versionRes.json();
            document.getElementById('versionBadge').textContent = `v${versionData.version}`;

            // Load competitor data from API
            const response = await fetch('/api/admin-data?type=competitors');
            if (!response.ok) throw new Error('API request failed');
            const result = await response.json();

            if (!result.success || !result.data?.competitors?.length) {
                throw new Error('No competitor data returned from API');
            }

            competitorData = result.data.competitors;

            // Update data source banner
            updateDataSourceBanner(true, competitorData.length);

            // Find our salon in the data
            ourSalonData = competitorData.find(c => c.name.includes('Chris David'));
            const leader = competitorData[0];

            // Update market position from API
            updateMarketPosition(competitorData, ourSalonData, leader);

            // Display chart with real data
            displayCompetitorChart(competitorData, ourSalonData);

            // Display competitor cards from API
            displayCompetitorCards(competitorData, ourSalonData);

            // Generate gap analysis from API data
            generateGapAnalysis(competitorData, ourSalonData, leader);

            // Update timestamp
            document.getElementById('lastUpdate').textContent = `Updated: ${new Date().toLocaleTimeString()}`;

        } catch (error) {
            console.error('Failed to load competitors:', error);
            updateDataSourceBanner(false, 0, error.message);
            document.getElementById('competitorsGrid').innerHTML = `
                <div class="col-span-2 text-center py-8 text-red-500">
                    <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                    <p>Failed to load competitor data: ${error.message}</p>
                    <p class="text-sm mt-2">Check that Google Places API credentials are configured in Vercel</p>
                </div>
            `;
        } finally {
            if (loadingEl) loadingEl.classList.add('hidden');
        }
    }

    function updateDataSourceBanner(success, count, error = null) {
        const banner = document.getElementById('dataSourceBanner');
        const title = document.getElementById('dataSourceTitle');
        const message = document.getElementById('dataSourceMessage');

        if (success) {
            banner.className = 'bg-green-50 border border-green-200 rounded-lg p-4 mb-6';
            title.className = 'font-semibold text-green-800';
            title.textContent = 'Live Data from Google Places API';
            message.className = 'text-green-700 text-sm';
            message.textContent = `${count} competitors loaded from Google Places`;
        } else {
            banner.className = 'bg-red-50 border border-red-200 rounded-lg p-4 mb-6';
            title.className = 'font-semibold text-red-800';
            title.textContent = 'API Connection Error';
            message.className = 'text-red-700 text-sm';
            message.textContent = error || 'Check Vercel environment variables';
        }
    }

    // Calculate SEO score from Google Places data
    // Formula: (rating * 10) + min(log10(reviews) * 15, 40) + presence bonus
    function calculateSEOScore(competitor) {
        const rating = competitor.rating || 0;
        const reviews = competitor.reviews || 0;

        // Rating contributes up to 50 points (5.0 * 10)
        const ratingScore = rating * 10;

        // Reviews contribute up to 40 points (logarithmic scale)
        // 10 reviews = 15, 100 reviews = 30, 1000 reviews = 45 (capped at 40)
        const reviewScore = reviews > 0 ? Math.min(Math.log10(reviews) * 15, 40) : 0;

        // Presence bonus: 10 points for having a Place ID
        const presenceBonus = competitor.placeId ? 10 : 0;

        return Math.round(ratingScore + reviewScore + presenceBonus);
    }

    function updateMarketPosition(competitors, ourSalon, leader) {
        // Calculate scores for all competitors
        competitors.forEach(c => {
            c.calculatedScore = calculateSEOScore(c);
        });

        // Sort by calculated score
        competitors.sort((a, b) => b.calculatedScore - a.calculatedScore);

        // Re-find positions after sorting
        const ourPosition = ourSalon ? competitors.findIndex(c => c.name.includes('Chris David')) + 1 : '--';
        const actualLeader = competitors[0];

        document.getElementById('marketPosition').textContent = ourPosition !== '--' ? `#${ourPosition}` : '--';
        document.getElementById('totalCompetitors').textContent = `out of ${competitors.length} competitors`;

        // Our score (calculated)
        const ourScore = ourSalon ? calculateSEOScore(ourSalon) : '--';
        document.getElementById('ourScore').textContent = ourScore;
        document.getElementById('targetScore').textContent = ourScore !== '--' ? `Target: ${Math.min(ourScore + 15, 95)}+ for Top 3` : 'Awaiting data';

        // Gap to leader
        if (ourSalon && actualLeader && !actualLeader.name.includes('Chris David')) {
            const leaderScore = calculateSEOScore(actualLeader);
            const gap = leaderScore - ourScore;
            document.getElementById('gapToFirst').textContent = gap > 0 ? `+${gap}` : (gap === 0 ? 'TIE' : gap);
            document.getElementById('leaderName').textContent = `vs ${actualLeader.name}`;
        } else if (actualLeader?.name.includes('Chris David')) {
            document.getElementById('gapToFirst').textContent = '#1';
            document.getElementById('leaderName').textContent = 'You are the leader!';
        } else {
            document.getElementById('gapToFirst').textContent = '--';
            document.getElementById('leaderName').textContent = 'Awaiting data';
        }
    }

    let competitorChart = null;

    function displayCompetitorChart(competitors, ourSalon) {
        const canvas = document.getElementById('seoComparisonChart');
        const ctx = canvas.getContext('2d');

        if (competitorChart) {
            competitorChart.destroy();
        }

        // Calculate and sort by score
        const sorted = competitors.map(c => ({
            ...c,
            score: c.calculatedScore || calculateSEOScore(c)
        })).sort((a, b) => b.score - a.score).slice(0, 10);

        // Get our calculated score
        const ourScore = ourSalon ? calculateSEOScore(ourSalon) : 0;

        // Highlight Chris David
        const colors = sorted.map(c =>
            c.name.includes('Chris David') ? 'rgba(59, 130, 246, 0.8)' : 'rgba(239, 68, 68, 0.8)'
        );

        Chart.register(ChartDataLabels);

        competitorChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sorted.map(c => c.name),
                datasets: [{
                    label: 'SEO Score',
                    data: sorted.map(c => c.score),
                    backgroundColor: colors,
                    borderColor: colors.map(c => c.replace('0.8', '1')),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 30 } },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const competitor = sorted[context.dataIndex];
                                const gap = competitor.score - ourScore;
                                return `Reviews: ${competitor.reviews || '--'}\nGap: ${gap >= 0 ? '+' : ''}${gap} points`;
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        color: '#333',
                        font: { weight: 'bold', size: 12 },
                        formatter: value => value
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { callback: value => value + ' pts' }
                    },
                    x: {
                        ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } }
                    }
                }
            }
        });
    }

    function displayCompetitorCards(competitors, ourSalon) {
        const grid = document.getElementById('competitorsGrid');

        const sorted = competitors.map(c => ({
            ...c,
            score: c.calculatedScore || calculateSEOScore(c)
        })).sort((a, b) => b.score - a.score);

        grid.innerHTML = sorted.slice(0, 10).map((competitor, index) => {
            const isUs = competitor.name.includes('Chris David');
            const scoreColor = competitor.score >= 80 ? 'text-green-600' : competitor.score >= 70 ? 'text-yellow-600' : 'text-red-600';

            return `
                <div class="p-4 rounded-lg border-2 ${isUs ? 'bg-blue-50 border-blue-500' : 'bg-white border-gray-200'}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-lg">${index + 1}. ${competitor.name}</h4>
                            <p class="text-sm text-gray-600">${competitor.url || 'No URL'}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold ${scoreColor}">${competitor.score}/100</div>
                            <p class="text-xs text-gray-500">${competitor.reviews || 0} reviews</p>
                        </div>
                    </div>

                    <div class="space-y-2 text-sm">
                        <div class="flex items-center justify-between">
                            <span>Rating</span>
                            <span class="font-medium">${competitor.rating || '--'}â˜…</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span>Reviews</span>
                            <span class="font-medium">${competitor.reviews || '--'}</span>
                        </div>
                    </div>

                    ${isUs ? '<div class="mt-3 text-blue-600 font-semibold text-sm">YOUR SALON</div>' : ''}
                </div>
            `;
        }).join('');
    }

    function generateGapAnalysis(competitors, ourSalon, leader) {
        const gapsContainer = document.getElementById('competitiveGaps');
        const advantagesContainer = document.getElementById('ourAdvantages');

        if (!ourSalon) {
            gapsContainer.innerHTML = '<div class="text-gray-500">Unable to analyze - salon data not found</div>';
            advantagesContainer.innerHTML = '<div class="text-gray-500">Unable to analyze - salon data not found</div>';
            return;
        }

        // Re-sort to find actual leader by calculated score
        const sortedByScore = competitors.map(c => ({
            ...c,
            calculatedScore: c.calculatedScore || calculateSEOScore(c)
        })).sort((a, b) => b.calculatedScore - a.calculatedScore);

        const actualLeader = sortedByScore.find(c => !c.name.includes('Chris David')) || sortedByScore[0];

        const ourScore = calculateSEOScore(ourSalon);
        const ourReviews = ourSalon.reviews || 0;
        const leaderScore = actualLeader ? calculateSEOScore(actualLeader) : 0;
        const leaderReviews = actualLeader?.reviews || 0;

        // Generate gaps based on REAL API data
        const gaps = [];

        if (leaderReviews > ourReviews) {
            gaps.push({
                title: 'Review Count',
                detail: `${actualLeader.name} has ${leaderReviews} reviews vs your ${ourReviews}`,
                gap: leaderReviews - ourReviews
            });
        }

        if (leaderScore > ourScore) {
            gaps.push({
                title: 'SEO Score',
                detail: `Leader scores ${leaderScore}/100 vs your ${ourScore}/100`,
                gap: leaderScore - ourScore
            });
        }

        // Find competitors with more reviews
        const competitorsWithMoreReviews = competitors.filter(c =>
            !c.name.includes('Chris David') && (c.reviews || 0) > ourReviews
        ).length;

        if (competitorsWithMoreReviews > 0) {
            gaps.push({
                title: 'Review Ranking',
                detail: `${competitorsWithMoreReviews} competitors have more reviews than you`,
                gap: competitorsWithMoreReviews
            });
        }

        gapsContainer.innerHTML = gaps.length > 0 ? gaps.map(gap => `
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-red-500 mt-1 mr-3"></i>
                <div>
                    <strong>${gap.title}:</strong> ${gap.detail}
                </div>
            </div>
        `).join('') : '<div class="text-green-600">No significant gaps identified!</div>';

        // Generate advantages based on REAL API data
        const advantages = [];

        const ourPosition = competitors.indexOf(ourSalon) + 1;
        if (ourPosition <= 5) {
            advantages.push({
                title: 'Top 5 Position',
                detail: `You rank #${ourPosition} out of ${competitors.length} competitors`
            });
        }

        if (ourScore >= 70) {
            advantages.push({
                title: 'Solid SEO Score',
                detail: `Your score of ${ourScore}/100 is competitive`
            });
        }

        const avgReviews = competitors.reduce((sum, c) => sum + (c.reviews || 0), 0) / competitors.length;
        if (ourReviews >= avgReviews) {
            advantages.push({
                title: 'Above Average Reviews',
                detail: `Your ${ourReviews} reviews beats the average of ${Math.round(avgReviews)}`
            });
        }

        advantagesContainer.innerHTML = advantages.length > 0 ? advantages.map(adv => `
            <div class="flex items-start">
                <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                <div>
                    <strong>${adv.title}:</strong> ${adv.detail}
                </div>
            </div>
        `).join('') : '<div class="text-yellow-600">Building competitive advantages...</div>';
    }

    async function analyzeAllCompetitors() {
        await loadCompetitors();
    }

    // Load on page load
    window.addEventListener('load', loadCompetitors);
    </script>
</body>
</html>
