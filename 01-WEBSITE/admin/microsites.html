<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Microsite Analytics - Chris David Salon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .pulse-green { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }
        .health-ring {
            transition: stroke-dashoffset 1s ease-out;
        }
        .trend-up { color: #22c55e; }
        .trend-down { color: #ef4444; }
        .trend-neutral { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Top Navigation -->
    <nav class="bg-gradient-to-r from-indigo-900 to-purple-900 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <div class="w-3 h-3 bg-green-400 rounded-full pulse-green mr-2"></div>
                        <span class="font-bold text-xl">Chris David SEO Agent</span>
                    </div>
                    <span id="versionBadge" class="bg-green-500 px-2 py-1 rounded text-xs font-bold">Loading...</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="lastUpdate" class="text-sm text-indigo-200">Loading...</span>
                    <a href="../index.html" class="bg-yellow-500 hover:bg-yellow-600 px-3 py-1 rounded text-sm font-semibold">
                        View Site
                    </a>
                </div>
            </div>
            <!-- Navigation Tabs -->
            <div class="flex space-x-1 pb-2 overflow-x-auto">
                <a href="index.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Dashboard</a>
                <a href="improvement-planner.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Improvement Plan</a>
                <a href="traffic.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Traffic</a>
                <a href="authority.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Authority</a>
                <a href="microsites.html" class="px-4 py-2 bg-white/20 rounded-t font-semibold">Microsites</a>
                <a href="rankings.html" class="px-4 py-2 hover:bg-white/10 rounded-t">Rankings</a>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6">

        <!-- HERO: THE BIG PICTURE -->
        <div class="bg-gradient-to-r from-purple-600 via-indigo-600 to-blue-600 text-white rounded-2xl shadow-xl p-8 mb-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-3xl font-bold mb-2">Microsite Network Analytics</h1>
                    <p class="text-purple-200">3 satellite sites driving traffic to chrisdavidsalon.com</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-purple-200">Data Quality</div>
                    <div id="dataQualityBadge" class="flex gap-2 mt-1">
                        <span class="bg-white/20 px-2 py-1 rounded text-xs">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- 4 Key Metrics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 text-center">
                    <div class="text-purple-200 text-sm mb-1">Visitors Sent (30d)</div>
                    <div id="totalReferrals" class="text-4xl font-bold">--</div>
                    <div id="referralsTrend" class="text-sm text-purple-200">to main site</div>
                </div>
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 text-center">
                    <div class="text-purple-200 text-sm mb-1">Total Pages Live</div>
                    <div id="totalPages" class="text-4xl font-bold">--</div>
                    <div class="text-sm text-purple-200">across all sites</div>
                </div>
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 text-center">
                    <div class="text-purple-200 text-sm mb-1">Avg PageRank</div>
                    <div id="avgPagerank" class="text-4xl font-bold">--</div>
                    <div class="text-sm text-purple-200">out of 10</div>
                </div>
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 text-center">
                    <div class="text-purple-200 text-sm mb-1">Sites Indexed</div>
                    <div id="indexedCount" class="text-4xl font-bold">--</div>
                    <div class="text-sm text-purple-200">by Google</div>
                </div>
            </div>
        </div>

        <!-- ROI PROJECTION -->
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">
                    <i class="fas fa-chart-line mr-2"></i>
                    ROI Projection
                </h2>
                <span class="bg-white/20 px-3 py-1 rounded text-sm">Based on current performance</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white/10 rounded-lg p-4">
                    <div class="text-green-100 text-sm mb-1">Current Monthly</div>
                    <div class="text-2xl font-bold" id="currentRevenue">$0</div>
                    <div class="text-sm text-green-200" id="currentClients">0 est. clients</div>
                </div>
                <div class="bg-white/10 rounded-lg p-4">
                    <div class="text-green-100 text-sm mb-1">Projected Year-End</div>
                    <div class="text-2xl font-bold" id="projectedRevenue">$0</div>
                    <div class="text-sm text-green-200" id="projectedClients">0 annual clients</div>
                </div>
                <div class="bg-white/10 rounded-lg p-4">
                    <div class="text-green-100 text-sm mb-1">Growth Potential</div>
                    <div class="text-2xl font-bold" id="growthMultiplier">--x</div>
                    <div class="text-sm text-green-200">with 10%/month growth</div>
                </div>
            </div>
            <div class="mt-4 text-xs text-green-200">
                <i class="fas fa-info-circle mr-1"></i>
                Assumptions: $600/client/year avg value, 5% referral-to-booking conversion
            </div>
        </div>

        <!-- INDIVIDUAL SITE CARDS -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Site cards will be dynamically generated -->
            <div id="siteCardsContainer" class="contents">
                <!-- Loading placeholders -->
                <div class="bg-white rounded-xl shadow-lg p-6 animate-pulse">
                    <div class="h-6 bg-gray-200 rounded w-3/4 mb-4"></div>
                    <div class="h-32 bg-gray-200 rounded mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 animate-pulse">
                    <div class="h-6 bg-gray-200 rounded w-3/4 mb-4"></div>
                    <div class="h-32 bg-gray-200 rounded mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 animate-pulse">
                    <div class="h-6 bg-gray-200 rounded w-3/4 mb-4"></div>
                    <div class="h-32 bg-gray-200 rounded mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                </div>
            </div>
        </div>

        <!-- REFERRAL TREND CHART -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">
                    <i class="fas fa-chart-area text-blue-500 mr-2"></i>
                    Referral Traffic Over Time
                </h2>
                <div class="flex gap-2">
                    <button onclick="setChartPeriod(7)" class="px-3 py-1 text-sm rounded bg-gray-100 hover:bg-gray-200" id="btn7d">7D</button>
                    <button onclick="setChartPeriod(30)" class="px-3 py-1 text-sm rounded bg-blue-500 text-white" id="btn30d">30D</button>
                </div>
            </div>
            <div class="h-64">
                <canvas id="referralChart"></canvas>
            </div>
            <div id="noDataMessage" class="hidden text-center py-12 text-gray-500">
                <i class="fas fa-chart-line text-4xl mb-3 text-gray-300"></i>
                <p>No referral data yet. As microsites gain traffic, you'll see the trend here.</p>
            </div>
        </div>

        <!-- CONTENT DEPLOYMENT PROGRESS -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">
                    <i class="fas fa-rocket text-purple-500 mr-2"></i>
                    Content Deployment Progress
                </h2>
                <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded text-sm">
                    Auto-deploys 2 pages/site/week
                </span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div id="deploymentProgress" class="contents">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Content Library Detail -->
            <div class="border-t pt-4">
                <h3 class="font-semibold mb-3">Content Library (30 Pages)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="contentLibrary">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- PAGEMAP COMPARISON -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-sitemap text-indigo-500 mr-2"></i>
                Live Page Inventory
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold">Site</th>
                            <th class="px-4 py-3 text-center font-semibold">Pages</th>
                            <th class="px-4 py-3 text-center font-semibold">PageRank</th>
                            <th class="px-4 py-3 text-center font-semibold">Indexed</th>
                            <th class="px-4 py-3 text-center font-semibold">Referrals</th>
                            <th class="px-4 py-3 text-center font-semibold">Health</th>
                            <th class="px-4 py-3 text-center font-semibold">Action</th>
                        </tr>
                    </thead>
                    <tbody id="siteTableBody">
                        <tr><td colspan="7" class="text-center py-8 text-gray-400">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ACTION ITEMS -->
        <div id="actionItems" class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-6 mb-6 hidden">
            <h2 class="text-xl font-bold text-yellow-800 mb-4">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Action Required
            </h2>
            <div id="actionItemsList" class="space-y-3">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- HOW MICROSITES WORK -->
        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                How This Network Drives Business
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <div class="text-3xl mb-2">1.</div>
                    <h4 class="font-bold text-gray-800 mb-2">Keyword Capture</h4>
                    <p class="text-sm text-gray-600">
                        Each microsite ranks for different searches your main site can't win alone.
                    </p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <div class="text-3xl mb-2">2.</div>
                    <h4 class="font-bold text-gray-800 mb-2">Traffic Funnel</h4>
                    <p class="text-sm text-gray-600">
                        Visitors find these sites, read valuable content, then click through to book.
                    </p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <div class="text-3xl mb-2">3.</div>
                    <h4 class="font-bold text-gray-800 mb-2">Authority Building</h4>
                    <p class="text-sm text-gray-600">
                        Links from these sites boost chrisdavidsalon.com's domain authority over time.
                    </p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <div class="text-3xl mb-2">4.</div>
                    <h4 class="font-bold text-gray-800 mb-2">Compound Growth</h4>
                    <p class="text-sm text-gray-600">
                        As sites age and gain pages, their value compounds. A 2-year-old site >>> new site.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
    const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'https://www.chrisdavidsalon.com'
        : '';

    let referralChart = null;
    let chartData = [];
    let currentPeriod = 30;

    // Content library data
    const CONTENT_LIBRARY = {
        'bestdelraysalon.com': [
            { title: 'Wedding Hair Guide', file: 'wedding-hair-delray-beach.html' },
            { title: "Men's Haircut Guide", file: 'mens-haircut-delray-beach.html' },
            { title: 'Highlights vs Balayage', file: 'highlights-vs-balayage.html' },
            { title: 'Florida Humidity Hair', file: 'florida-humidity-hair-care.html' },
            { title: 'First Salon Visit', file: 'first-salon-visit-tips.html' },
            { title: 'Hair Trends 2025', file: 'hair-trends-2025.html' },
            { title: 'Postpartum Hair Loss', file: 'postpartum-hair-loss.html' },
            { title: 'Pool/Chlorine Protection', file: 'pool-chlorine-hair-protection.html' },
            { title: 'Curly Hair Specialist', file: 'curly-hair-specialist-delray.html' },
            { title: 'Red Hair Color', file: 'red-hair-color-delray-beach.html' }
        ],
        'bestsalondelray.com': [
            { title: 'Wedding Updo Guide', file: 'wedding-updo-guide.html' },
            { title: 'Teen Haircuts', file: 'teen-haircuts-delray.html' },
            { title: 'Senior Hair Services', file: 'senior-hair-services.html' },
            { title: 'Organic Hair Color', file: 'organic-hair-color-guide.html' },
            { title: 'Hair Loss Solutions', file: 'hair-loss-solutions-delray.html' },
            { title: 'Salon Etiquette', file: 'salon-etiquette-guide.html' },
            { title: 'Beach Hair Protection', file: 'beach-hair-protection.html' },
            { title: 'Hair Gloss Treatment', file: 'hair-gloss-treatment-guide.html' },
            { title: 'Root Touch-Up Guide', file: 'root-touch-up-guide.html' },
            { title: 'Dimensional Color', file: 'dimensional-color-explained.html' }
        ],
        'bestsalonpalmbeach.com': [
            { title: 'Lake Worth Salon', file: 'hair-salon-lake-worth.html' },
            { title: 'Lantana Salon', file: 'hair-salon-lantana.html' },
            { title: 'Wellington Salon', file: 'hair-salon-wellington.html' },
            { title: 'Boca Raton Balayage', file: 'balayage-boca-raton.html' },
            { title: 'Color Correction PBC', file: 'color-correction-palm-beach.html' },
            { title: 'Keratin Palm Beach', file: 'keratin-treatment-palm-beach.html' },
            { title: 'Blonde Specialist Boca', file: 'blonde-specialist-boca.html' },
            { title: 'Greenacres Salon', file: 'hair-salon-greenacres.html' },
            { title: 'Royal Palm Beach', file: 'hair-stylist-royal-palm-beach.html' },
            { title: 'Palm Beach Island Luxury', file: 'luxury-salon-palm-beach-island.html' }
        ]
    };

    async function loadPageData() {
        // Load version
        try {
            const versionResp = await fetch(`${API_BASE}/data/version.json`);
            const versionData = await versionResp.json();
            document.getElementById('versionBadge').textContent = 'v' + versionData.version;
        } catch (e) {
            document.getElementById('versionBadge').textContent = 'v?.?.?';
        }

        document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();

        // Fetch microsite analytics
        try {
            const response = await fetch(`${API_BASE}/api/microsite-analytics`);
            const data = await response.json();

            if (data.success) {
                renderDashboard(data);
            } else {
                // Fallback to basic data fetch
                await loadBasicData();
            }
        } catch (e) {
            console.error('Failed to load microsite analytics:', e);
            await loadBasicData();
        }
    }

    async function loadBasicData() {
        // Fallback: Load data from individual endpoints
        try {
            const [referralsRes, pagerankRes] = await Promise.all([
                fetch(`${API_BASE}/api/ga4-analytics?type=microsite-referrals`).then(r => r.json()),
                fetch(`${API_BASE}/api/authority-score?competitors=true`).then(r => r.json())
            ]);

            const microsites = [
                {
                    domain: 'bestsalondelray.com',
                    name: 'Best Salon Delray',
                    target: 'best salon delray beach',
                    color: '#3B82F6',
                    pageCount: 5,
                    contentLibrarySize: 10
                },
                {
                    domain: 'bestdelraysalon.com',
                    name: 'Best Delray Salon',
                    target: 'delray beach salon',
                    color: '#EC4899',
                    pageCount: 5,
                    contentLibrarySize: 10
                },
                {
                    domain: 'bestsalonpalmbeach.com',
                    name: 'Best Salon Palm Beach',
                    target: 'salon palm beach county',
                    color: '#06B6D4',
                    pageCount: 5,
                    contentLibrarySize: 10
                }
            ];

            // Merge data
            microsites.forEach(site => {
                const refData = referralsRes.microsites?.[site.domain] || {};
                site.referrals = {
                    last30Days: refData.totalUsers || 0,
                    sessions: refData.totalSessions || 0,
                    dailyData: refData.dailyData || []
                };

                const prData = pagerankRes.data?.all_results?.find(r => r.domain === site.domain) || {};
                site.pagerank = prData.pagerank_decimal || 0;
                site.indexed = prData.status === 'found';

                site.health = {
                    score: site.indexed ? 50 + (site.referrals.last30Days * 5) : 20,
                    grade: site.indexed ? (site.referrals.last30Days > 5 ? 'B' : 'C') : 'F'
                };

                site.contentLibrary = {
                    total: site.contentLibrarySize,
                    deployed: 0,
                    remaining: site.contentLibrarySize
                };
            });

            const totals = {
                totalPages: microsites.reduce((s, m) => s + m.pageCount, 0),
                totalReferrals: microsites.reduce((s, m) => s + m.referrals.last30Days, 0),
                avgPagerank: (microsites.reduce((s, m) => s + m.pagerank, 0) / 3).toFixed(2),
                indexedSites: microsites.filter(m => m.indexed).length
            };

            renderDashboard({ success: true, microsites, totals, projection: calculateProjection(totals) });

        } catch (e) {
            console.error('Fallback data load failed:', e);
            document.getElementById('siteCardsContainer').innerHTML = `
                <div class="col-span-3 text-center py-12 text-red-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                    <p>Failed to load microsite data. Please refresh.</p>
                </div>
            `;
        }
    }

    function calculateProjection(totals) {
        const clientValue = 600;
        const conversionRate = 0.05;
        const monthlyGrowth = 0.10;

        const currentClients = totals.totalReferrals * conversionRate;
        const projectedYearEnd = totals.totalReferrals * Math.pow(1 + monthlyGrowth, 12);

        return {
            currentMonthly: {
                referrals: totals.totalReferrals,
                estimatedClients: Math.round(currentClients * 10) / 10,
                estimatedRevenue: Math.round(currentClients * clientValue)
            },
            projectedYearEnd: {
                monthlyReferrals: Math.round(projectedYearEnd),
                annualClients: Math.round(projectedYearEnd * conversionRate * 12),
                annualRevenue: Math.round(projectedYearEnd * conversionRate * 12 * clientValue)
            }
        };
    }

    function renderDashboard(data) {
        const { microsites, totals, projection } = data;

        // Update hero metrics
        document.getElementById('totalReferrals').textContent = totals.totalReferrals;
        document.getElementById('totalPages').textContent = totals.totalPages;
        document.getElementById('avgPagerank').textContent = totals.avgPagerank;
        document.getElementById('indexedCount').textContent = `${totals.indexedSites}/3`;

        // Update data quality badges
        const dq = data.dataQuality || { pagerank: 'live', ga4: 'live', sitemaps: 'live' };
        document.getElementById('dataQualityBadge').innerHTML = `
            <span class="bg-${dq.pagerank === 'live' ? 'green' : 'yellow'}-500/30 px-2 py-1 rounded text-xs">
                PageRank: ${dq.pagerank}
            </span>
            <span class="bg-${dq.ga4 === 'live' ? 'green' : 'yellow'}-500/30 px-2 py-1 rounded text-xs">
                GA4: ${dq.ga4}
            </span>
        `;

        // Update ROI projection
        if (projection) {
            document.getElementById('currentRevenue').textContent = '$' + projection.currentMonthly.estimatedRevenue.toLocaleString();
            document.getElementById('currentClients').textContent = projection.currentMonthly.estimatedClients + ' est. clients';
            document.getElementById('projectedRevenue').textContent = '$' + projection.projectedYearEnd.annualRevenue.toLocaleString();
            document.getElementById('projectedClients').textContent = projection.projectedYearEnd.annualClients + ' annual clients';

            const growth = projection.projectedYearEnd.annualRevenue > 0 && projection.currentMonthly.estimatedRevenue > 0
                ? (projection.projectedYearEnd.annualRevenue / (projection.currentMonthly.estimatedRevenue * 12)).toFixed(1)
                : '3.1';
            document.getElementById('growthMultiplier').textContent = growth + 'x';
        }

        // Render site cards
        renderSiteCards(microsites);

        // Render table
        renderSiteTable(microsites);

        // Render chart
        renderReferralChart(microsites);

        // Render content deployment
        renderContentDeployment(microsites);

        // Check for action items
        renderActionItems(microsites);
    }

    function renderSiteCards(microsites) {
        const container = document.getElementById('siteCardsContainer');
        container.innerHTML = microsites.map(site => `
            <div class="bg-white rounded-xl shadow-lg overflow-hidden border-t-4" style="border-color: ${site.color}">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-lg">${site.domain}</h3>
                            <p class="text-sm text-gray-500">Target: "${site.target}"</p>
                        </div>
                        <span class="px-2 py-1 rounded text-xs font-bold ${site.indexed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${site.indexed ? 'INDEXED' : 'NOT INDEXED'}
                        </span>
                    </div>

                    <!-- Health Ring -->
                    <div class="flex items-center gap-4 mb-4">
                        <div class="relative w-20 h-20">
                            <svg class="transform -rotate-90 w-20 h-20">
                                <circle cx="40" cy="40" r="35" stroke="#e5e7eb" stroke-width="6" fill="none"/>
                                <circle cx="40" cy="40" r="35" stroke="${site.color}" stroke-width="6" fill="none"
                                    stroke-dasharray="${2 * Math.PI * 35}"
                                    stroke-dashoffset="${2 * Math.PI * 35 * (1 - (site.health?.score || 0) / 100)}"
                                    class="health-ring"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span class="text-xl font-bold">${site.health?.score || 0}</span>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>
                                    <div class="text-gray-500">PageRank</div>
                                    <div class="font-bold" style="color: ${site.color}">${site.pagerank?.toFixed(2) || '0.00'}/10</div>
                                </div>
                                <div>
                                    <div class="text-gray-500">Pages</div>
                                    <div class="font-bold">${site.pageCount || 0}</div>
                                </div>
                                <div>
                                    <div class="text-gray-500">Referrals</div>
                                    <div class="font-bold">${site.referrals?.last30Days || 0}</div>
                                </div>
                                <div>
                                    <div class="text-gray-500">Grade</div>
                                    <div class="font-bold ${getGradeColor(site.health?.grade)}">${site.health?.grade || 'F'}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <a href="https://${site.domain}" target="_blank"
                       class="block text-center py-2 rounded font-semibold text-white hover:opacity-90"
                       style="background-color: ${site.color}">
                        Visit Site <i class="fas fa-external-link-alt ml-1"></i>
                    </a>
                </div>
            </div>
        `).join('');
    }

    function renderSiteTable(microsites) {
        const tbody = document.getElementById('siteTableBody');
        tbody.innerHTML = microsites.map(site => `
            <tr class="border-b hover:bg-gray-50">
                <td class="px-4 py-3">
                    <div class="font-semibold" style="color: ${site.color}">${site.domain}</div>
                    <div class="text-xs text-gray-500">${site.target}</div>
                </td>
                <td class="px-4 py-3 text-center font-bold">${site.pageCount || 0}</td>
                <td class="px-4 py-3 text-center">
                    <span class="font-bold" style="color: ${site.color}">${site.pagerank?.toFixed(2) || '0.00'}</span>
                </td>
                <td class="px-4 py-3 text-center">
                    ${site.indexed
                        ? '<span class="text-green-500"><i class="fas fa-check-circle"></i></span>'
                        : '<span class="text-red-500"><i class="fas fa-times-circle"></i></span>'}
                </td>
                <td class="px-4 py-3 text-center font-bold">${site.referrals?.last30Days || 0}</td>
                <td class="px-4 py-3 text-center">
                    <span class="px-2 py-1 rounded text-xs font-bold ${getGradeBgColor(site.health?.grade)}">
                        ${site.health?.score || 0} (${site.health?.grade || 'F'})
                    </span>
                </td>
                <td class="px-4 py-3 text-center">
                    <a href="https://search.google.com/search-console?resource_id=sc-domain:${site.domain}"
                       target="_blank" class="text-blue-500 hover:underline text-sm">
                        GSC <i class="fas fa-external-link-alt"></i>
                    </a>
                </td>
            </tr>
        `).join('');
    }

    function renderReferralChart(microsites) {
        const ctx = document.getElementById('referralChart').getContext('2d');

        // Collect daily data
        chartData = [];
        microsites.forEach(site => {
            if (site.referrals?.dailyData) {
                site.referrals.dailyData.forEach(d => {
                    const existing = chartData.find(c => c.date === d.date);
                    if (existing) {
                        existing[site.domain] = d.users || 0;
                    } else {
                        chartData.push({
                            date: d.date,
                            [site.domain]: d.users || 0
                        });
                    }
                });
            }
        });

        // Sort by date
        chartData.sort((a, b) => a.date.localeCompare(b.date));

        if (chartData.length === 0) {
            document.getElementById('referralChart').style.display = 'none';
            document.getElementById('noDataMessage').classList.remove('hidden');
            return;
        }

        document.getElementById('referralChart').style.display = 'block';
        document.getElementById('noDataMessage').classList.add('hidden');

        const labels = chartData.map(d => {
            const year = d.date.substring(0, 4);
            const month = d.date.substring(4, 6);
            const day = d.date.substring(6, 8);
            return `${month}/${day}`;
        });

        const datasets = microsites.map(site => ({
            label: site.domain,
            data: chartData.map(d => d[site.domain] || 0),
            borderColor: site.color,
            backgroundColor: site.color + '20',
            fill: true,
            tension: 0.4
        }));

        if (referralChart) {
            referralChart.destroy();
        }

        referralChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    }

    function renderContentDeployment(microsites) {
        const progressContainer = document.getElementById('deploymentProgress');
        progressContainer.innerHTML = microsites.map(site => {
            const deployed = Math.max(0, (site.pageCount || 5) - 5);
            const total = site.contentLibrarySize || 10;
            const pct = Math.round((deployed / total) * 100);

            return `
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold" style="color: ${site.color}">${site.domain}</span>
                        <span class="text-sm text-gray-500">${deployed}/${total} deployed</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="h-3 rounded-full transition-all duration-500"
                             style="width: ${pct}%; background-color: ${site.color}"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        Est. completion: ${total - deployed > 0 ? Math.ceil((total - deployed) / 2) : 0} weeks
                    </div>
                </div>
            `;
        }).join('');

        // Content library
        const libraryContainer = document.getElementById('contentLibrary');
        libraryContainer.innerHTML = Object.entries(CONTENT_LIBRARY).map(([domain, pages]) => {
            const site = microsites.find(s => s.domain === domain) || {};
            const livePages = site.pages || [];

            return `
                <div>
                    <h4 class="font-semibold mb-2" style="color: ${site.color || '#666'}">${domain}</h4>
                    <ul class="space-y-1 text-xs">
                        ${pages.map(p => {
                            const isLive = livePages.includes(p.file);
                            return `
                                <li class="flex items-center gap-2">
                                    <span class="${isLive ? 'text-green-500' : 'text-gray-300'}">
                                        <i class="fas fa-${isLive ? 'check-circle' : 'clock'}"></i>
                                    </span>
                                    <span class="${isLive ? 'text-gray-800' : 'text-gray-500'}">${p.title}</span>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                </div>
            `;
        }).join('');
    }

    function renderActionItems(microsites) {
        const actions = [];

        // Check for unindexed sites
        microsites.filter(s => !s.indexed).forEach(site => {
            actions.push({
                severity: 'high',
                title: `${site.domain} is NOT indexed by Google`,
                description: 'This site cannot appear in search results until indexed.',
                action: `Go to <a href="https://search.google.com/search-console" target="_blank" class="text-blue-600 underline">Google Search Console</a>, add the property, and submit the sitemap.`
            });
        });

        // Check for low referrals
        if (microsites.every(s => (s.referrals?.last30Days || 0) < 5)) {
            actions.push({
                severity: 'medium',
                title: 'Low referral traffic across all microsites',
                description: 'The microsites are generating minimal traffic to the main site.',
                action: 'This is normal for new sites. Continue adding content and building authority. Results typically appear after 3-6 months.'
            });
        }

        const container = document.getElementById('actionItems');
        const list = document.getElementById('actionItemsList');

        if (actions.length > 0) {
            container.classList.remove('hidden');
            list.innerHTML = actions.map(a => `
                <div class="bg-white rounded-lg p-4 border-l-4 ${a.severity === 'high' ? 'border-red-500' : 'border-yellow-500'}">
                    <h4 class="font-bold ${a.severity === 'high' ? 'text-red-800' : 'text-yellow-800'}">${a.title}</h4>
                    <p class="text-sm text-gray-600 mb-2">${a.description}</p>
                    <p class="text-sm">${a.action}</p>
                </div>
            `).join('');
        } else {
            container.classList.add('hidden');
        }
    }

    function setChartPeriod(days) {
        currentPeriod = days;
        document.getElementById('btn7d').className = days === 7 ? 'px-3 py-1 text-sm rounded bg-blue-500 text-white' : 'px-3 py-1 text-sm rounded bg-gray-100 hover:bg-gray-200';
        document.getElementById('btn30d').className = days === 30 ? 'px-3 py-1 text-sm rounded bg-blue-500 text-white' : 'px-3 py-1 text-sm rounded bg-gray-100 hover:bg-gray-200';
        // Would filter chart data here if needed
    }

    function getGradeColor(grade) {
        const colors = { A: 'text-green-500', B: 'text-blue-500', C: 'text-yellow-500', D: 'text-orange-500', F: 'text-red-500' };
        return colors[grade] || 'text-gray-500';
    }

    function getGradeBgColor(grade) {
        const colors = { A: 'bg-green-100 text-green-800', B: 'bg-blue-100 text-blue-800', C: 'bg-yellow-100 text-yellow-800', D: 'bg-orange-100 text-orange-800', F: 'bg-red-100 text-red-800' };
        return colors[grade] || 'bg-gray-100 text-gray-800';
    }

    // Initialize
    loadPageData();
    // Refresh every 5 minutes
    setInterval(loadPageData, 5 * 60 * 1000);
    </script>
</body>
</html>
