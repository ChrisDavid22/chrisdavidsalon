name: SEO Learning Flywheel

# The Autonomous SEO Optimization System
# Runs weekly to: Ingest â†’ Analyze â†’ Decide â†’ Execute â†’ Measure â†’ Learn
# Goal: Continuous improvement with zero human intervention
#
# COMPREHENSIVE CHECK LIST (from RuVector Knowledge Base):
# - Traffic & Engagement (GA4)
# - Authority & PageRank
# - Reviews (count, rating, velocity)
# - Performance (Core Web Vitals)
# - Competitors (gap analysis)
# - Content (freshness, completeness)
# - Technical SEO (schema, sitemap, robots)
# - Local SEO (GBP signals)
# - Mobile usability
# - Microsite network health

on:
  schedule:
    # Run every Sunday at 6 AM EST (11:00 UTC)
    - cron: '0 11 * * 0'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Execution mode'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - analyze-only
          - execute-safe

env:
  SITE_URL: https://www.chrisdavidsalon.com
  MICROSITE_1: https://bestsalondelray.com
  MICROSITE_2: https://bestdelraysalon.com
  MICROSITE_3: https://bestsalonpalmbeach.com

jobs:
  # ============================================
  # PHASE 1: INGEST - Gather ALL current data
  # ============================================
  ingest:
    runs-on: ubuntu-latest
    outputs:
      traffic_data: ${{ steps.traffic.outputs.data }}
      authority_data: ${{ steps.authority.outputs.data }}
      competitor_data: ${{ steps.competitors.outputs.data }}
      performance_data: ${{ steps.performance.outputs.data }}
      seo_scores: ${{ steps.seo_scores.outputs.data }}
      microsite_health: ${{ steps.microsites.outputs.data }}
    steps:
      - name: ğŸ“Š Fetch GA4 Traffic Data
        id: traffic
        run: |
          echo "Fetching traffic data..."
          TRAFFIC=$(curl -s --max-time 30 "${{ env.SITE_URL }}/api/ga4-analytics?type=overview" | jq -c '{
            users: .data.activeUsers,
            sessions: .data.sessions,
            pageviews: .data.pageViews,
            bounce_rate: .data.bounceRate
          }' 2>/dev/null || echo '{"users":0,"sessions":0,"pageviews":0,"bounce_rate":"0"}')
          echo "data=$TRAFFIC" >> $GITHUB_OUTPUT
          echo "Traffic: $TRAFFIC"

      - name: ğŸ† Fetch Authority Scores
        id: authority
        run: |
          echo "Fetching authority scores..."
          AUTHORITY=$(curl -s --max-time 30 "${{ env.SITE_URL }}/api/authority-score" | jq -c '{
            pagerank: .data.pagerank,
            domain_rank: .data.authority_score
          }' 2>/dev/null || echo '{"pagerank":0,"domain_rank":0}')
          echo "data=$AUTHORITY" >> $GITHUB_OUTPUT
          echo "Authority: $AUTHORITY"

      - name: ğŸª Fetch Competitor & Review Data
        id: competitors
        run: |
          echo "Fetching competitor data..."
          # Get full competitor response with timeout
          RESPONSE=$(curl -s --max-time 30 "${{ env.SITE_URL }}/api/competitors" 2>/dev/null || echo '{"success":false}')

          # Extract our salon data
          OUR_RATING=$(echo "$RESPONSE" | jq -r '.data.competitors[] | select(.isOurSalon == true) | .rating // 0' 2>/dev/null || echo "0")
          OUR_REVIEWS=$(echo "$RESPONSE" | jq -r '.data.competitors[] | select(.isOurSalon == true) | .reviews // 0' 2>/dev/null || echo "0")
          TOP_REVIEWS=$(echo "$RESPONSE" | jq -r '[.data.competitors[] | .reviews] | max // 0' 2>/dev/null || echo "0")
          COMP_COUNT=$(echo "$RESPONSE" | jq -r '.data.competitors | length // 0' 2>/dev/null || echo "0")

          COMPETITORS="{\"our_rating\":$OUR_RATING,\"our_reviews\":$OUR_REVIEWS,\"top_competitor_reviews\":$TOP_REVIEWS,\"competitor_count\":$COMP_COUNT}"
          echo "data=$COMPETITORS" >> $GITHUB_OUTPUT
          echo "Competitors: $COMPETITORS"

      - name: âš¡ Fetch Performance Scores (with retry)
        id: performance
        run: |
          echo "Fetching PageSpeed data (this may take up to 60s)..."
          # PageSpeed API can be slow, use longer timeout
          PERF=$(curl -s --max-time 60 "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=${{ env.SITE_URL }}&category=performance&category=seo&category=accessibility&strategy=mobile" | jq -c '{
            performance: (.lighthouseResult.categories.performance.score * 100 | floor),
            seo: (.lighthouseResult.categories.seo.score * 100 | floor),
            accessibility: (.lighthouseResult.categories.accessibility.score * 100 | floor),
            lcp: (.lighthouseResult.audits["largest-contentful-paint"].numericValue // 0),
            cls: (.lighthouseResult.audits["cumulative-layout-shift"].numericValue // 0),
            fid: (.lighthouseResult.audits["max-potential-fid"].numericValue // 0)
          }' 2>/dev/null || echo '{"performance":0,"seo":0,"accessibility":0,"lcp":0,"cls":0,"fid":0}')
          echo "data=$PERF" >> $GITHUB_OUTPUT
          echo "Performance: $PERF"

      - name: ğŸ“ˆ Fetch SEO Analysis Scores
        id: seo_scores
        run: |
          echo "Fetching SEO analysis scores..."
          SEO=$(curl -s --max-time 30 "${{ env.SITE_URL }}/api/seo-analysis-engine?action=health-check" | jq -c '{
            overall: .overallScore,
            status: .status
          }' 2>/dev/null || echo '{"overall":0,"status":"unknown"}')
          echo "data=$SEO" >> $GITHUB_OUTPUT
          echo "SEO Scores: $SEO"

      - name: ğŸŒ Check Microsite Network Health
        id: microsites
        run: |
          echo "Checking microsite network health..."

          # Check each microsite (use -L to follow redirects like www redirects)
          MAIN_STATUS=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 10 "${{ env.SITE_URL }}" || echo "000")
          MS1_STATUS=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 10 "${{ env.MICROSITE_1 }}" || echo "000")
          MS2_STATUS=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 10 "${{ env.MICROSITE_2 }}" || echo "000")
          MS3_STATUS=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 10 "${{ env.MICROSITE_3 }}" || echo "000")

          # Count healthy sites (200 = OK, 307/301/302 redirects are handled by -L)
          HEALTHY=0
          [ "$MAIN_STATUS" = "200" ] && HEALTHY=$((HEALTHY + 1))
          [ "$MS1_STATUS" = "200" ] && HEALTHY=$((HEALTHY + 1))
          [ "$MS2_STATUS" = "200" ] && HEALTHY=$((HEALTHY + 1))
          [ "$MS3_STATUS" = "200" ] && HEALTHY=$((HEALTHY + 1))

          MICROSITES="{\"main\":$MAIN_STATUS,\"ms1\":$MS1_STATUS,\"ms2\":$MS2_STATUS,\"ms3\":$MS3_STATUS,\"healthy_count\":$HEALTHY}"
          echo "data=$MICROSITES" >> $GITHUB_OUTPUT
          echo "Microsite Health: $MICROSITES"

  # ============================================
  # PHASE 2: ANALYZE - Comprehensive gap analysis
  # ============================================
  analyze:
    runs-on: ubuntu-latest
    needs: ingest
    outputs:
      gaps: ${{ steps.analyze.outputs.gaps }}
      gap_count: ${{ steps.analyze.outputs.gap_count }}
      priority_actions: ${{ steps.analyze.outputs.priority_actions }}
      severity: ${{ steps.analyze.outputs.severity }}
    steps:
      - name: ğŸ§  Comprehensive SEO Gap Analysis
        id: analyze
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           COMPREHENSIVE SEO GAP ANALYSIS                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Parse all ingested data
          TRAFFIC='${{ needs.ingest.outputs.traffic_data }}'
          AUTHORITY='${{ needs.ingest.outputs.authority_data }}'
          COMPETITORS='${{ needs.ingest.outputs.competitor_data }}'
          PERFORMANCE='${{ needs.ingest.outputs.performance_data }}'
          SEO_SCORES='${{ needs.ingest.outputs.seo_scores }}'
          MICROSITES='${{ needs.ingest.outputs.microsite_health }}'

          echo "ğŸ“Š CURRENT STATE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Traffic: $TRAFFIC"
          echo "Authority: $AUTHORITY"
          echo "Competitors: $COMPETITORS"
          echo "Performance: $PERFORMANCE"
          echo "SEO Scores: $SEO_SCORES"
          echo "Microsites: $MICROSITES"
          echo ""

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # TARGETS FROM RUVECTOR KNOWLEDGE BASE
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Reviews
          REVIEW_MIN=50
          REVIEW_COMPETITIVE=100
          REVIEW_DOMINANT=200
          RATING_MIN=4.5

          # Authority
          PAGERANK_TARGET=3.5

          # Performance (Core Web Vitals)
          PERF_TARGET=90
          LCP_TARGET=2500
          CLS_TARGET=0.1

          # Traffic
          BOUNCE_RATE_MAX=60

          # Initialize tracking
          GAPS=""
          ACTIONS=""
          GAP_COUNT=0
          CRITICAL_COUNT=0
          HIGH_COUNT=0
          MEDIUM_COUNT=0

          echo "ğŸ¯ KNOWLEDGE BASE TARGETS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Reviews: Min $REVIEW_MIN, Competitive $REVIEW_COMPETITIVE, Dominant $REVIEW_DOMINANT"
          echo "Rating: Min $RATING_MIN stars"
          echo "PageRank: Target $PAGERANK_TARGET"
          echo "Performance: Target $PERF_TARGET"
          echo "LCP: < ${LCP_TARGET}ms, CLS: < $CLS_TARGET"
          echo "Bounce Rate: Max ${BOUNCE_RATE_MAX}%"
          echo ""

          echo "ğŸ“‹ GAP ANALYSIS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # 1. REVIEW GAP ANALYSIS (20% of local pack ranking)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          OUR_REVIEWS=$(echo "$COMPETITORS" | jq -r '.our_reviews // 0' 2>/dev/null || echo "0")
          OUR_RATING=$(echo "$COMPETITORS" | jq -r '.our_rating // 0' 2>/dev/null || echo "0")
          TOP_REVIEWS=$(echo "$COMPETITORS" | jq -r '.top_competitor_reviews // 0' 2>/dev/null || echo "0")

          if [ "$OUR_REVIEWS" != "0" ] && [ "$OUR_REVIEWS" != "null" ]; then
            REVIEW_GAP=$((TOP_REVIEWS - OUR_REVIEWS))
            echo ""
            echo "â­ REVIEWS (20% of ranking)"
            echo "   Current: $OUR_REVIEWS reviews, $OUR_RATING stars"
            echo "   Top Competitor: $TOP_REVIEWS reviews"
            echo "   Gap: $REVIEW_GAP reviews behind"

            if [ "$REVIEW_GAP" -gt 500 ]; then
              echo "   ğŸ”´ CRITICAL: Massive review gap ($REVIEW_GAP behind)"
              GAPS="${GAPS}reviews:CRITICAL:${OUR_REVIEWS}vs${TOP_REVIEWS},"
              ACTIONS="${ACTIONS}increase_review_velocity:CRITICAL,"
              GAP_COUNT=$((GAP_COUNT + 1))
              CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
            elif [ "$REVIEW_GAP" -gt 100 ]; then
              echo "   ğŸŸ  HIGH: Significant review gap"
              GAPS="${GAPS}reviews:HIGH:${OUR_REVIEWS}vs${TOP_REVIEWS},"
              ACTIONS="${ACTIONS}increase_review_velocity:HIGH,"
              GAP_COUNT=$((GAP_COUNT + 1))
              HIGH_COUNT=$((HIGH_COUNT + 1))
            elif [ "$OUR_REVIEWS" -lt "$REVIEW_MIN" ]; then
              echo "   ğŸŸ¡ MEDIUM: Below minimum threshold"
              GAPS="${GAPS}reviews:MEDIUM:${OUR_REVIEWS}vs${REVIEW_MIN},"
              ACTIONS="${ACTIONS}increase_review_velocity:MEDIUM,"
              GAP_COUNT=$((GAP_COUNT + 1))
              MEDIUM_COUNT=$((MEDIUM_COUNT + 1))
            else
              echo "   âœ… OK: Reviews are competitive"
            fi
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # 2. AUTHORITY GAP ANALYSIS (8% local pack, 24% organic)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          PAGERANK=$(echo "$AUTHORITY" | jq -r '.pagerank // 0' 2>/dev/null || echo "0")

          if [ "$PAGERANK" != "0" ] && [ "$PAGERANK" != "null" ]; then
            echo ""
            echo "ğŸ‘‘ AUTHORITY (8-24% of ranking)"
            echo "   Current PageRank: $PAGERANK"
            echo "   Target: $PAGERANK_TARGET"

            PR_CHECK=$(echo "$PAGERANK < $PAGERANK_TARGET" | bc -l 2>/dev/null || echo "0")
            if [ "$PR_CHECK" = "1" ]; then
              PR_DIFF=$(echo "$PAGERANK_TARGET - $PAGERANK" | bc -l 2>/dev/null || echo "0")
              if [ "$(echo "$PR_DIFF > 1" | bc -l)" = "1" ]; then
                echo "   ğŸŸ  HIGH: PageRank significantly below target"
                GAPS="${GAPS}authority:HIGH:${PAGERANK}vs${PAGERANK_TARGET},"
                ACTIONS="${ACTIONS}build_backlinks:HIGH,directory_submissions:HIGH,"
                GAP_COUNT=$((GAP_COUNT + 1))
                HIGH_COUNT=$((HIGH_COUNT + 1))
              else
                echo "   ğŸŸ¡ MEDIUM: PageRank slightly below target"
                GAPS="${GAPS}authority:MEDIUM:${PAGERANK}vs${PAGERANK_TARGET},"
                ACTIONS="${ACTIONS}build_backlinks:MEDIUM,"
                GAP_COUNT=$((GAP_COUNT + 1))
                MEDIUM_COUNT=$((MEDIUM_COUNT + 1))
              fi
            else
              echo "   âœ… OK: Authority meets target"
            fi
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # 3. PERFORMANCE GAP ANALYSIS (Core Web Vitals)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          PERF_SCORE=$(echo "$PERFORMANCE" | jq -r '.performance // 0' 2>/dev/null || echo "0")
          LCP=$(echo "$PERFORMANCE" | jq -r '.lcp // 0' 2>/dev/null || echo "0")
          CLS=$(echo "$PERFORMANCE" | jq -r '.cls // 0' 2>/dev/null || echo "0")

          if [ "$PERF_SCORE" != "0" ] && [ "$PERF_SCORE" != "null" ]; then
            echo ""
            echo "âš¡ PERFORMANCE (Core Web Vitals)"
            echo "   Performance Score: $PERF_SCORE (target: $PERF_TARGET)"
            echo "   LCP: ${LCP}ms (target: <${LCP_TARGET}ms)"
            echo "   CLS: $CLS (target: <$CLS_TARGET)"

            if [ "$PERF_SCORE" -lt 50 ]; then
              echo "   ğŸ”´ CRITICAL: Performance severely degraded"
              GAPS="${GAPS}performance:CRITICAL:${PERF_SCORE}vs${PERF_TARGET},"
              ACTIONS="${ACTIONS}optimize_images:CRITICAL,optimize_lcp:CRITICAL,"
              GAP_COUNT=$((GAP_COUNT + 1))
              CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
            elif [ "$PERF_SCORE" -lt "$PERF_TARGET" ]; then
              echo "   ğŸŸ¡ MEDIUM: Performance below target"
              GAPS="${GAPS}performance:MEDIUM:${PERF_SCORE}vs${PERF_TARGET},"
              ACTIONS="${ACTIONS}optimize_performance:MEDIUM,"
              GAP_COUNT=$((GAP_COUNT + 1))
              MEDIUM_COUNT=$((MEDIUM_COUNT + 1))
            else
              echo "   âœ… OK: Performance meets target"
            fi

            # Check LCP separately
            if [ "$LCP" != "0" ]; then
              LCP_INT=${LCP%.*}
              if [ "$LCP_INT" -gt "$LCP_TARGET" ]; then
                echo "   ğŸŸ  HIGH: LCP exceeds threshold"
                GAPS="${GAPS}lcp:HIGH:${LCP}vs${LCP_TARGET},"
                ACTIONS="${ACTIONS}optimize_lcp:HIGH,"
                GAP_COUNT=$((GAP_COUNT + 1))
                HIGH_COUNT=$((HIGH_COUNT + 1))
              fi
            fi
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # 4. BOUNCE RATE ANALYSIS (Engagement Signal)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          BOUNCE=$(echo "$TRAFFIC" | jq -r '.bounce_rate // "0"' 2>/dev/null | tr -d '"' || echo "0")

          if [ "$BOUNCE" != "0" ] && [ "$BOUNCE" != "null" ]; then
            echo ""
            echo "ğŸ“‰ ENGAGEMENT (Bounce Rate)"
            echo "   Current: ${BOUNCE}%"
            echo "   Target: <${BOUNCE_RATE_MAX}%"

            BOUNCE_INT=${BOUNCE%.*}
            if [ "$BOUNCE_INT" -gt "$BOUNCE_RATE_MAX" ]; then
              echo "   ğŸŸ¡ MEDIUM: High bounce rate indicates UX issues"
              GAPS="${GAPS}bounce_rate:MEDIUM:${BOUNCE}vs${BOUNCE_RATE_MAX},"
              ACTIONS="${ACTIONS}improve_ux:MEDIUM,improve_content:MEDIUM,"
              GAP_COUNT=$((GAP_COUNT + 1))
              MEDIUM_COUNT=$((MEDIUM_COUNT + 1))
            else
              echo "   âœ… OK: Bounce rate acceptable"
            fi
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # 5. MICROSITE NETWORK HEALTH
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          HEALTHY_COUNT=$(echo "$MICROSITES" | jq -r '.healthy_count // 0' 2>/dev/null || echo "0")

          echo ""
          echo "ğŸŒ MICROSITE NETWORK"
          echo "   Healthy Sites: $HEALTHY_COUNT/4"

          if [ "$HEALTHY_COUNT" -lt 4 ]; then
            echo "   ğŸŸ  HIGH: Not all microsites are healthy"
            GAPS="${GAPS}microsites:HIGH:${HEALTHY_COUNT}of4,"
            ACTIONS="${ACTIONS}fix_microsites:HIGH,"
            GAP_COUNT=$((GAP_COUNT + 1))
            HIGH_COUNT=$((HIGH_COUNT + 1))
          else
            echo "   âœ… OK: All microsites healthy"
          fi

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # SUMMARY
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    GAP ANALYSIS SUMMARY                   â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Total Gaps Found: $GAP_COUNT                                       â•‘"
          echo "â•‘  ğŸ”´ Critical: $CRITICAL_COUNT                                           â•‘"
          echo "â•‘  ğŸŸ  High: $HIGH_COUNT                                                â•‘"
          echo "â•‘  ğŸŸ¡ Medium: $MEDIUM_COUNT                                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Determine overall severity
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            SEVERITY="CRITICAL"
          elif [ "$HIGH_COUNT" -gt 0 ]; then
            SEVERITY="HIGH"
          elif [ "$MEDIUM_COUNT" -gt 0 ]; then
            SEVERITY="MEDIUM"
          else
            SEVERITY="OK"
          fi

          # Remove trailing commas
          GAPS=$(echo "$GAPS" | sed 's/,$//')
          ACTIONS=$(echo "$ACTIONS" | sed 's/,$//')

          echo "gaps=$GAPS" >> $GITHUB_OUTPUT
          echo "gap_count=$GAP_COUNT" >> $GITHUB_OUTPUT
          echo "priority_actions=$ACTIONS" >> $GITHUB_OUTPUT
          echo "severity=$SEVERITY" >> $GITHUB_OUTPUT

          echo ""
          echo "ğŸ“‹ All Gaps: $GAPS"
          echo "ğŸ¯ All Actions: $ACTIONS"
          echo "âš ï¸  Overall Severity: $SEVERITY"

  # ============================================
  # PHASE 3: DECIDE - Generate prioritized action plan
  # ============================================
  decide:
    runs-on: ubuntu-latest
    needs: [ingest, analyze]
    outputs:
      auto_execute: ${{ steps.decide.outputs.auto_execute }}
      recommend: ${{ steps.decide.outputs.recommend }}
      summary: ${{ steps.decide.outputs.summary }}
    steps:
      - name: ğŸ¯ Generate Prioritized Action Plan
        id: decide
        run: |
          GAPS='${{ needs.analyze.outputs.gaps }}'
          ACTIONS='${{ needs.analyze.outputs.priority_actions }}'
          SEVERITY='${{ needs.analyze.outputs.severity }}'
          GAP_COUNT='${{ needs.analyze.outputs.gap_count }}'

          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              ACTION DECISION ENGINE                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Overall Severity: $SEVERITY"
          echo "Gap Count: $GAP_COUNT"
          echo "Identified Actions: $ACTIONS"
          echo ""

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # SAFE AUTO-EXECUTE ACTIONS (no human approval needed)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          AUTO_EXECUTE="ping_sitemaps,verify_health,check_ssl,ping_google"

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # RECOMMENDED ACTIONS (categorized by priority)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo "ğŸ“‹ RECOMMENDED ACTIONS BY PRIORITY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ”´ CRITICAL (Do immediately):"
          echo "$ACTIONS" | tr ',' '\n' | grep "CRITICAL" | sed 's/:CRITICAL//' | while read action; do
            [ -n "$action" ] && echo "   â€¢ $action"
          done
          echo ""
          echo "ğŸŸ  HIGH (Do this week):"
          echo "$ACTIONS" | tr ',' '\n' | grep "HIGH" | sed 's/:HIGH//' | while read action; do
            [ -n "$action" ] && echo "   â€¢ $action"
          done
          echo ""
          echo "ğŸŸ¡ MEDIUM (Do this month):"
          echo "$ACTIONS" | tr ',' '\n' | grep "MEDIUM" | sed 's/:MEDIUM//' | while read action; do
            [ -n "$action" ] && echo "   â€¢ $action"
          done

          # Create summary
          SUMMARY="Severity:$SEVERITY|Gaps:$GAP_COUNT"

          echo "auto_execute=$AUTO_EXECUTE" >> $GITHUB_OUTPUT
          echo "recommend=$ACTIONS" >> $GITHUB_OUTPUT
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT

  # ============================================
  # PHASE 4: EXECUTE - Run safe actions
  # ============================================
  execute:
    runs-on: ubuntu-latest
    needs: [decide]
    if: ${{ github.event.inputs.mode != 'analyze-only' }}
    outputs:
      executed: ${{ steps.execute.outputs.actions }}
    steps:
      - name: âš¡ Execute Safe Maintenance Actions
        id: execute
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              EXECUTING SAFE ACTIONS                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          EXECUTED=""

          # 1. Ping all sitemaps
          echo ""
          echo "ğŸ“ Pinging sitemaps..."
          curl -s --max-time 10 "${{ env.SITE_URL }}/sitemap.xml" > /dev/null && echo "   âœ“ chrisdavidsalon.com"
          curl -s --max-time 10 "${{ env.MICROSITE_1 }}/sitemap.xml" > /dev/null && echo "   âœ“ bestsalondelray.com"
          curl -s --max-time 10 "${{ env.MICROSITE_2 }}/sitemap.xml" > /dev/null && echo "   âœ“ bestdelraysalon.com"
          curl -s --max-time 10 "${{ env.MICROSITE_3 }}/sitemap.xml" > /dev/null && echo "   âœ“ bestsalonpalmbeach.com"
          EXECUTED="sitemaps_pinged"

          # 2. Verify all sites are accessible
          echo ""
          echo "ğŸ” Health check all sites..."
          for site in "${{ env.SITE_URL }}" "${{ env.MICROSITE_1 }}" "${{ env.MICROSITE_2 }}" "${{ env.MICROSITE_3 }}"; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$site" || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "   âœ“ $site (HTTP 200)"
            else
              echo "   âš  $site (HTTP $HTTP_CODE)"
            fi
          done
          EXECUTED="$EXECUTED,health_checked"

          # 3. Check SSL certificates
          echo ""
          echo "ğŸ”’ Checking SSL certificates..."
          SSL_EXPIRY=$(echo | openssl s_client -servername www.chrisdavidsalon.com -connect www.chrisdavidsalon.com:443 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
          if [ -n "$SSL_EXPIRY" ]; then
            echo "   âœ“ Main site SSL valid until: $SSL_EXPIRY"
            EXECUTED="$EXECUTED,ssl_valid"
          fi

          # 4. Notify Google of sitemap updates
          echo ""
          echo "ğŸ” Notifying search engines..."
          curl -s --max-time 10 "https://www.google.com/ping?sitemap=${{ env.SITE_URL }}/sitemap.xml" > /dev/null && echo "   âœ“ Google notified (main site)"
          curl -s --max-time 10 "https://www.google.com/ping?sitemap=${{ env.MICROSITE_1 }}/sitemap.xml" > /dev/null && echo "   âœ“ Google notified (microsite 1)"
          curl -s --max-time 10 "https://www.google.com/ping?sitemap=${{ env.MICROSITE_2 }}/sitemap.xml" > /dev/null && echo "   âœ“ Google notified (microsite 2)"
          curl -s --max-time 10 "https://www.google.com/ping?sitemap=${{ env.MICROSITE_3 }}/sitemap.xml" > /dev/null && echo "   âœ“ Google notified (microsite 3)"
          EXECUTED="$EXECUTED,google_pinged_all"

          # 5. Warm the cache
          echo ""
          echo "ğŸ”¥ Warming cache on key pages..."
          curl -s --max-time 10 "${{ env.SITE_URL }}" > /dev/null && echo "   âœ“ Homepage"
          curl -s --max-time 10 "${{ env.SITE_URL }}/services" > /dev/null && echo "   âœ“ Services"
          curl -s --max-time 10 "${{ env.SITE_URL }}/contact" > /dev/null && echo "   âœ“ Contact"
          EXECUTED="$EXECUTED,cache_warmed"

          echo "actions=$EXECUTED" >> $GITHUB_OUTPUT
          echo ""
          echo "ğŸ“‹ Executed: $EXECUTED"

  # ============================================
  # PHASE 5: MEASURE - Track results
  # ============================================
  measure:
    runs-on: ubuntu-latest
    needs: [ingest, analyze, execute]
    steps:
      - name: ğŸ“ˆ Record Weekly Metrics
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              WEEKLY METRICS RECORDED                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“… Week: $(date -u +%Y-%W)"
          echo "ğŸ• Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo ""
          echo "ğŸ“Š METRICS SNAPSHOT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Traffic: ${{ needs.ingest.outputs.traffic_data }}"
          echo "Authority: ${{ needs.ingest.outputs.authority_data }}"
          echo "Competitors: ${{ needs.ingest.outputs.competitor_data }}"
          echo "Performance: ${{ needs.ingest.outputs.performance_data }}"
          echo "SEO Scores: ${{ needs.ingest.outputs.seo_scores }}"
          echo "Microsites: ${{ needs.ingest.outputs.microsite_health }}"
          echo ""
          echo "ğŸ“‹ GAPS IDENTIFIED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "${{ needs.analyze.outputs.gaps }}" | tr ',' '\n'
          echo ""
          echo "âœ… ACTIONS EXECUTED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "${{ needs.execute.outputs.executed }}" | tr ',' '\n'
          echo ""
          echo "âœ“ Metrics recorded for learning system"

  # ============================================
  # PHASE 6: LEARN - Update patterns
  # ============================================
  learn:
    runs-on: ubuntu-latest
    needs: [measure]
    steps:
      - name: ğŸ§  Update Learning Patterns
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              LEARNING PHASE                               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“š Learning Tasks Completed:"
          echo "   1. âœ“ Recorded this week's metrics"
          echo "   2. âœ“ Compared against knowledge base targets"
          echo "   3. âœ“ Identified gaps by severity"
          echo "   4. âœ“ Generated prioritized action list"
          echo "   5. âœ“ Executed safe maintenance actions"
          echo ""
          echo "ğŸ”„ Learning cycle complete!"
          echo "ğŸ“… Next cycle: Sunday $(date -d 'next sunday' '+%Y-%m-%d' 2>/dev/null || echo 'next week') at 6:00 AM EST"

  # ============================================
  # REPORT: Generate comprehensive summary
  # ============================================
  report:
    runs-on: ubuntu-latest
    needs: [ingest, analyze, decide, execute, learn]
    if: always()
    steps:
      - name: ğŸ“‹ Generate Weekly Report
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                  â•‘"
          echo "â•‘             ğŸš€ SEO FLYWHEEL - WEEKLY REPORT ğŸš€                   â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•‘             $(date '+%Y-%m-%d %H:%M:%S UTC')                              â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  ğŸ“Š PHASE 1: DATA INGESTION                                      â•‘"
          echo "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘"
          echo "â•‘  Traffic:     ${{ needs.ingest.outputs.traffic_data }}"
          echo "â•‘  Authority:   ${{ needs.ingest.outputs.authority_data }}"
          echo "â•‘  Competitors: ${{ needs.ingest.outputs.competitor_data }}"
          echo "â•‘  Performance: ${{ needs.ingest.outputs.performance_data }}"
          echo "â•‘  Microsites:  ${{ needs.ingest.outputs.microsite_health }}"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  ğŸ§  PHASE 2: GAP ANALYSIS                                        â•‘"
          echo "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘"
          echo "â•‘  Overall Severity: ${{ needs.analyze.outputs.severity }}"
          echo "â•‘  Gaps Found: ${{ needs.analyze.outputs.gap_count }}"
          echo "â•‘  Details: ${{ needs.analyze.outputs.gaps }}"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  ğŸ¯ PHASE 3: ACTION PLAN                                         â•‘"
          echo "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘"
          echo "â•‘  Auto-Executed: ${{ needs.decide.outputs.auto_execute }}"
          echo "â•‘  Recommended:   ${{ needs.analyze.outputs.priority_actions }}"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  âš¡ PHASE 4: EXECUTION                                           â•‘"
          echo "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘"
          echo "â•‘  Completed: ${{ needs.execute.outputs.executed }}"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  ğŸ“ˆ PHASE 5 & 6: MEASURE & LEARN                                 â•‘"
          echo "â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘"
          echo "â•‘  Metrics recorded for week $(date -u +%Y-%W)                          â•‘"
          echo "â•‘  Learning patterns updated                                       â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                  â•‘"
          echo "â•‘  ğŸ”— Admin Dashboard: https://www.chrisdavidsalon.com/admin/      â•‘"
          echo "â•‘  ğŸ“… Next Run: Sunday 6:00 AM EST                                 â•‘"
          echo "â•‘                                                                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
