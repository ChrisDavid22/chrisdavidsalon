name: SEO Learning Flywheel

# The Autonomous SEO Optimization System
# Runs weekly to: Ingest â†’ Analyze â†’ Decide â†’ Execute â†’ Measure â†’ Learn
# Goal: Continuous improvement with zero human intervention

on:
  schedule:
    # Run every Sunday at 6 AM EST (11:00 UTC)
    - cron: '0 11 * * 0'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Execution mode'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - analyze-only
          - execute-safe

env:
  SITE_URL: https://www.chrisdavidsalon.com
  MICROSITE_1: https://bestsalondelray.com
  MICROSITE_2: https://bestdelraysalon.com
  MICROSITE_3: https://bestsalonpalmbeach.com

jobs:
  # ============================================
  # PHASE 1: INGEST - Gather all current data
  # ============================================
  ingest:
    runs-on: ubuntu-latest
    outputs:
      traffic_data: ${{ steps.traffic.outputs.data }}
      authority_data: ${{ steps.authority.outputs.data }}
      competitor_data: ${{ steps.competitors.outputs.data }}
      performance_data: ${{ steps.performance.outputs.data }}
    steps:
      - name: ðŸ“Š Fetch GA4 Traffic Data
        id: traffic
        run: |
          echo "Fetching traffic data..."
          TRAFFIC=$(curl -s "${{ env.SITE_URL }}/api/ga4-analytics?type=overview" | jq -c '{
            users: .data.activeUsers,
            sessions: .data.sessions,
            pageviews: .data.pageViews,
            bounce_rate: .data.bounceRate
          }' 2>/dev/null || echo '{"error": "failed"}')
          echo "data=$TRAFFIC" >> $GITHUB_OUTPUT
          echo "Traffic: $TRAFFIC"

      - name: ðŸ† Fetch Authority Scores
        id: authority
        run: |
          echo "Fetching authority scores..."
          AUTHORITY=$(curl -s "${{ env.SITE_URL }}/api/authority-score?competitors=true" | jq -c '{
            main_site: .data.pagerank,
            domain_rank: .data.authority_score
          }' 2>/dev/null || echo '{"error": "failed"}')
          echo "data=$AUTHORITY" >> $GITHUB_OUTPUT
          echo "Authority: $AUTHORITY"

      - name: ðŸª Fetch Competitor Data
        id: competitors
        run: |
          echo "Fetching competitor data..."
          COMPETITORS=$(curl -s "${{ env.SITE_URL }}/api/competitors" | jq -c '{
            our_rating: (.data.competitors[] | select(.isOurSalon == true) | .rating),
            our_reviews: (.data.competitors[] | select(.isOurSalon == true) | .reviews),
            top_competitor_reviews: (.data.competitors | sort_by(-.reviews) | .[0].reviews),
            competitor_count: (.data.competitors | length)
          }' 2>/dev/null || echo '{"error": "failed"}')
          echo "data=$COMPETITORS" >> $GITHUB_OUTPUT
          echo "Competitors: $COMPETITORS"

      - name: âš¡ Fetch Performance Scores
        id: performance
        run: |
          echo "Fetching PageSpeed data..."
          PERF=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=${{ env.SITE_URL }}&category=performance&strategy=mobile" | jq -c '{
            score: (.lighthouseResult.categories.performance.score * 100 | floor),
            lcp: .lighthouseResult.audits["largest-contentful-paint"].numericValue,
            cls: .lighthouseResult.audits["cumulative-layout-shift"].numericValue
          }' 2>/dev/null || echo '{"error": "failed"}')
          echo "data=$PERF" >> $GITHUB_OUTPUT
          echo "Performance: $PERF"

  # ============================================
  # PHASE 2: ANALYZE - Compare against knowledge
  # ============================================
  analyze:
    runs-on: ubuntu-latest
    needs: ingest
    outputs:
      gaps: ${{ steps.analyze.outputs.gaps }}
      opportunities: ${{ steps.analyze.outputs.opportunities }}
      priority_actions: ${{ steps.analyze.outputs.priority_actions }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ§  Analyze Against Knowledge Base
        id: analyze
        run: |
          echo "=== SEO ANALYSIS ==="
          echo ""

          # Parse ingested data
          TRAFFIC='${{ needs.ingest.outputs.traffic_data }}'
          AUTHORITY='${{ needs.ingest.outputs.authority_data }}'
          COMPETITORS='${{ needs.ingest.outputs.competitor_data }}'
          PERFORMANCE='${{ needs.ingest.outputs.performance_data }}'

          echo "ðŸ“Š Current Metrics:"
          echo "  Traffic: $TRAFFIC"
          echo "  Authority: $AUTHORITY"
          echo "  Competitors: $COMPETITORS"
          echo "  Performance: $PERFORMANCE"
          echo ""

          # Define targets from knowledge base
          REVIEW_TARGET=200
          PAGERANK_TARGET=3.5
          PERFORMANCE_TARGET=90
          LCP_TARGET=2500
          CLS_TARGET=0.1

          # Initialize gaps and actions
          GAPS="[]"
          ACTIONS="[]"

          # Check review gap
          OUR_REVIEWS=$(echo $COMPETITORS | jq -r '.our_reviews // 0')
          TOP_REVIEWS=$(echo $COMPETITORS | jq -r '.top_competitor_reviews // 0')
          if [ "$OUR_REVIEWS" != "null" ] && [ "$TOP_REVIEWS" != "null" ]; then
            REVIEW_GAP=$((TOP_REVIEWS - OUR_REVIEWS))
            if [ $REVIEW_GAP -gt 100 ]; then
              GAPS=$(echo $GAPS | jq ". + [{\"type\": \"reviews\", \"gap\": $REVIEW_GAP, \"severity\": \"HIGH\"}]")
              ACTIONS=$(echo $ACTIONS | jq '. + [{"action": "increase_review_velocity", "priority": "HIGH"}]')
            fi
          fi

          # Check authority gap
          PAGERANK=$(echo $AUTHORITY | jq -r '.main_site // 0')
          if [ "$PAGERANK" != "null" ]; then
            if (( $(echo "$PAGERANK < $PAGERANK_TARGET" | bc -l) )); then
              GAPS=$(echo $GAPS | jq ". + [{\"type\": \"authority\", \"current\": $PAGERANK, \"target\": $PAGERANK_TARGET, \"severity\": \"MEDIUM\"}]")
              ACTIONS=$(echo $ACTIONS | jq '. + [{"action": "build_backlinks", "priority": "MEDIUM"}]')
            fi
          fi

          # Check performance
          PERF_SCORE=$(echo $PERFORMANCE | jq -r '.score // 0')
          LCP=$(echo $PERFORMANCE | jq -r '.lcp // 0')
          CLS=$(echo $PERFORMANCE | jq -r '.cls // 0')

          if [ "$PERF_SCORE" != "null" ] && [ "$PERF_SCORE" -lt "$PERFORMANCE_TARGET" ]; then
            GAPS=$(echo $GAPS | jq ". + [{\"type\": \"performance\", \"current\": $PERF_SCORE, \"target\": $PERFORMANCE_TARGET, \"severity\": \"HIGH\"}]")
            ACTIONS=$(echo $ACTIONS | jq '. + [{"action": "optimize_performance", "priority": "HIGH"}]')
          fi

          echo "gaps=$GAPS" >> $GITHUB_OUTPUT
          echo "priority_actions=$ACTIONS" >> $GITHUB_OUTPUT
          echo "opportunities=[]" >> $GITHUB_OUTPUT

          echo ""
          echo "ðŸ“‹ Identified Gaps:"
          echo $GAPS | jq '.'
          echo ""
          echo "ðŸŽ¯ Priority Actions:"
          echo $ACTIONS | jq '.'

  # ============================================
  # PHASE 3: DECIDE - Generate action plan
  # ============================================
  decide:
    runs-on: ubuntu-latest
    needs: [ingest, analyze]
    outputs:
      auto_execute: ${{ steps.decide.outputs.auto_execute }}
      recommend: ${{ steps.decide.outputs.recommend }}
    steps:
      - name: ðŸŽ¯ Generate Action Plan
        id: decide
        run: |
          ACTIONS='${{ needs.analyze.outputs.priority_actions }}'

          echo "=== ACTION DECISION ENGINE ==="
          echo ""

          # Separate into auto-execute (safe) and recommend (needs approval)
          AUTO_EXECUTE="[]"
          RECOMMEND="[]"

          # Define safe actions that can be auto-executed
          SAFE_ACTIONS=("refresh_sitemap" "ping_search_engines" "check_broken_links" "update_structured_data")

          # For now, recommend all identified actions (conservative approach)
          RECOMMEND=$ACTIONS

          # Always auto-execute these safe maintenance tasks
          AUTO_EXECUTE='[
            {"action": "ping_sitemaps", "description": "Ping all sitemaps for reindexing"},
            {"action": "verify_gbp_hours", "description": "Verify GBP hours are accurate"},
            {"action": "check_site_health", "description": "Basic site health check"}
          ]'

          echo "auto_execute=$AUTO_EXECUTE" >> $GITHUB_OUTPUT
          echo "recommend=$RECOMMEND" >> $GITHUB_OUTPUT

          echo "âœ… Auto-Execute Actions:"
          echo $AUTO_EXECUTE | jq '.'
          echo ""
          echo "ðŸ“ Recommended Actions (need approval):"
          echo $RECOMMEND | jq '.'

  # ============================================
  # PHASE 4: EXECUTE - Run safe actions
  # ============================================
  execute:
    runs-on: ubuntu-latest
    needs: [decide]
    if: ${{ github.event.inputs.mode != 'analyze-only' }}
    outputs:
      executed: ${{ steps.execute.outputs.actions }}
    steps:
      - name: âš¡ Execute Safe Actions
        id: execute
        run: |
          echo "=== EXECUTING SAFE ACTIONS ==="

          EXECUTED="[]"

          # 1. Ping all sitemaps
          echo "ðŸ“ Pinging sitemaps..."
          curl -s "${{ env.SITE_URL }}/sitemap.xml" > /dev/null && echo "  âœ“ Main site sitemap"
          curl -s "${{ env.MICROSITE_1 }}/sitemap.xml" > /dev/null && echo "  âœ“ bestsalondelray.com"
          curl -s "${{ env.MICROSITE_2 }}/sitemap.xml" > /dev/null && echo "  âœ“ bestdelraysalon.com"
          curl -s "${{ env.MICROSITE_3 }}/sitemap.xml" > /dev/null && echo "  âœ“ bestsalonpalmbeach.com"
          EXECUTED=$(echo $EXECUTED | jq '. + [{"action": "ping_sitemaps", "status": "completed", "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}]')

          # 2. Verify site is accessible
          echo ""
          echo "ðŸ” Checking site health..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.SITE_URL }}")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "  âœ“ Main site responding (HTTP $HTTP_CODE)"
            EXECUTED=$(echo $EXECUTED | jq '. + [{"action": "health_check", "status": "healthy", "http_code": '"$HTTP_CODE"'}]')
          else
            echo "  âš  Main site issue (HTTP $HTTP_CODE)"
            EXECUTED=$(echo $EXECUTED | jq '. + [{"action": "health_check", "status": "warning", "http_code": '"$HTTP_CODE"'}]')
          fi

          # 3. Check SSL certificate
          echo ""
          echo "ðŸ”’ Checking SSL..."
          SSL_EXPIRY=$(echo | openssl s_client -servername www.chrisdavidsalon.com -connect www.chrisdavidsalon.com:443 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
          if [ -n "$SSL_EXPIRY" ]; then
            echo "  âœ“ SSL valid until: $SSL_EXPIRY"
          fi

          echo "actions=$EXECUTED" >> $GITHUB_OUTPUT

          echo ""
          echo "ðŸ“‹ Executed Actions:"
          echo $EXECUTED | jq '.'

  # ============================================
  # PHASE 5: MEASURE - Track results
  # ============================================
  measure:
    runs-on: ubuntu-latest
    needs: [ingest, analyze, execute]
    steps:
      - name: ðŸ“ˆ Record Metrics for Learning
        run: |
          echo "=== RECORDING METRICS ==="

          # Create weekly report data
          REPORT=$(cat <<EOF
          {
            "week": "$(date -u +%Y-%W)",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "metrics": {
              "traffic": ${{ needs.ingest.outputs.traffic_data }},
              "authority": ${{ needs.ingest.outputs.authority_data }},
              "competitors": ${{ needs.ingest.outputs.competitor_data }},
              "performance": ${{ needs.ingest.outputs.performance_data }}
            },
            "gaps_identified": ${{ needs.analyze.outputs.gaps }},
            "actions_executed": ${{ needs.execute.outputs.executed }}
          }
          EOF
          )

          echo "ðŸ“Š Weekly Report:"
          echo "$REPORT" | jq '.'

          # Store for learning (in future: write to database/file)
          echo ""
          echo "âœ… Metrics recorded for learning system"

  # ============================================
  # PHASE 6: LEARN - Update patterns
  # ============================================
  learn:
    runs-on: ubuntu-latest
    needs: [measure]
    steps:
      - name: ðŸ§  Update Learning Patterns
        run: |
          echo "=== LEARNING PHASE ==="
          echo ""
          echo "ðŸ“š This phase will:"
          echo "  1. Compare this week vs last week metrics"
          echo "  2. Identify which actions improved metrics"
          echo "  3. Update confidence scores for strategies"
          echo "  4. Adjust future recommendations"
          echo ""
          echo "ðŸ”„ Learning cycle complete!"
          echo ""
          echo "ðŸ“… Next cycle: $(date -d 'next sunday' '+%Y-%m-%d') at 6:00 AM EST"

  # ============================================
  # REPORT: Generate summary
  # ============================================
  report:
    runs-on: ubuntu-latest
    needs: [ingest, analyze, decide, execute, learn]
    if: always()
    steps:
      - name: ðŸ“‹ Generate Weekly Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           SEO FLYWHEEL - WEEKLY REPORT                   â•‘"
          echo "â•‘           $(date '+%Y-%m-%d %H:%M:%S UTC')                        â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                          â•‘"
          echo "â•‘  ðŸ“Š PHASE 1: INGEST                                      â•‘"
          echo "â•‘     Traffic Data: âœ“ Collected                            â•‘"
          echo "â•‘     Authority Scores: âœ“ Collected                        â•‘"
          echo "â•‘     Competitor Data: âœ“ Collected                         â•‘"
          echo "â•‘     Performance Data: âœ“ Collected                        â•‘"
          echo "â•‘                                                          â•‘"
          echo "â•‘  ðŸ§  PHASE 2: ANALYZE                                     â•‘"
          echo "â•‘     Gaps Identified: ${{ needs.analyze.outputs.gaps }}"
          echo "â•‘                                                          â•‘"
          echo "â•‘  ðŸŽ¯ PHASE 3: DECIDE                                      â•‘"
          echo "â•‘     Auto-Execute: ${{ needs.decide.outputs.auto_execute }}"
          echo "â•‘     Recommended: ${{ needs.decide.outputs.recommend }}"
          echo "â•‘                                                          â•‘"
          echo "â•‘  âš¡ PHASE 4: EXECUTE                                     â•‘"
          echo "â•‘     Actions Completed: ${{ needs.execute.outputs.executed }}"
          echo "â•‘                                                          â•‘"
          echo "â•‘  ðŸ“ˆ PHASE 5: MEASURE                                     â•‘"
          echo "â•‘     Metrics Recorded: âœ“                                  â•‘"
          echo "â•‘                                                          â•‘"
          echo "â•‘  ðŸ§  PHASE 6: LEARN                                       â•‘"
          echo "â•‘     Patterns Updated: âœ“                                  â•‘"
          echo "â•‘                                                          â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ðŸ”— Admin Dashboard:                                     â•‘"
          echo "â•‘     https://www.chrisdavidsalon.com/admin/               â•‘"
          echo "â•‘                                                          â•‘"
          echo "â•‘  ðŸ“… Next Run: Sunday 6:00 AM EST                         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
