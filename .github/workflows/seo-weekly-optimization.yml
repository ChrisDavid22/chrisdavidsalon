name: Weekly SEO Optimization

on:
  schedule:
    # Run every Sunday at 6:00 AM EST (11:00 UTC)
    - cron: '0 11 * * 0'
  workflow_dispatch:  # Allow manual trigger

jobs:
  analyze-and-optimize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run SEO Analysis
        id: analysis
        run: |
          echo "=== Fetching Current Metrics ==="

          # Get PageSpeed data
          PAGESPEED=$(curl -s "https://pagespeedonline.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://www.chrisdavidsalon.com&strategy=mobile&category=performance")
          PERFORMANCE=$(echo $PAGESPEED | jq '.lighthouseResult.categories.performance.score * 100 | floor')
          LCP=$(echo $PAGESPEED | jq -r '.lighthouseResult.audits["largest-contentful-paint"].numericValue')
          CLS=$(echo $PAGESPEED | jq -r '.lighthouseResult.audits["cumulative-layout-shift"].numericValue')

          echo "Performance: $PERFORMANCE"
          echo "LCP: $LCP ms"
          echo "CLS: $CLS"

          # Get Authority data
          AUTHORITY=$(curl -s "https://www.chrisdavidsalon.com/api/authority")
          AUTH_SCORE=$(echo $AUTHORITY | jq '.data.authority_score')

          echo "Authority: $AUTH_SCORE"

          # Save to outputs
          echo "performance=$PERFORMANCE" >> $GITHUB_OUTPUT
          echo "lcp=$LCP" >> $GITHUB_OUTPUT
          echo "cls=$CLS" >> $GITHUB_OUTPUT
          echo "authority=$AUTH_SCORE" >> $GITHUB_OUTPUT

      - name: Check for Performance Issues
        run: |
          PERF=${{ steps.analysis.outputs.performance }}
          LCP=${{ steps.analysis.outputs.lcp }}
          CLS=${{ steps.analysis.outputs.cls }}

          echo "=== Performance Analysis ==="

          if [ "$PERF" -lt 70 ]; then
            echo "WARNING: Performance score ($PERF) is below 70"
            echo "NEEDS_OPTIMIZATION=true" >> $GITHUB_ENV
          fi

          # LCP should be under 2500ms
          if [ "$LCP" -gt 2500 ]; then
            echo "WARNING: LCP ($LCP ms) exceeds 2.5s threshold"
            echo "NEEDS_LCP_FIX=true" >> $GITHUB_ENV
          fi

          # CLS should be under 0.1
          CLS_INT=$(echo "$CLS * 1000" | bc | cut -d. -f1)
          if [ "$CLS_INT" -gt 100 ]; then
            echo "WARNING: CLS ($CLS) exceeds 0.1 threshold"
            echo "NEEDS_CLS_FIX=true" >> $GITHUB_ENV
          fi

      - name: Generate Weekly Report
        run: |
          DATE=$(date +%Y-%m-%d)

          cat << EOF > seo-report-$DATE.md
          # Weekly SEO Report - $DATE

          ## Current Scores
          - Performance: ${{ steps.analysis.outputs.performance }}/100
          - Authority: ${{ steps.analysis.outputs.authority }}/100
          - LCP: ${{ steps.analysis.outputs.lcp }}ms (target: <2500ms)
          - CLS: ${{ steps.analysis.outputs.cls }} (target: <0.1)

          ## Issues Detected
          $(if [ "$NEEDS_OPTIMIZATION" = "true" ]; then echo "- Performance needs improvement"; fi)
          $(if [ "$NEEDS_LCP_FIX" = "true" ]; then echo "- LCP too slow - check image optimization"; fi)
          $(if [ "$NEEDS_CLS_FIX" = "true" ]; then echo "- CLS too high - add image dimensions"; fi)

          ## Automated Actions Taken
          - Analyzed all metrics
          - Generated this report

          ## Recommended Manual Actions
          - Review and optimize largest images
          - Check for layout shift issues
          - Build backlinks for authority
          EOF

          echo "Report generated: seo-report-$DATE.md"

      - name: Commit Report
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "SEO Bot"

          DATE=$(date +%Y-%m-%d)
          if [ -f "seo-report-$DATE.md" ]; then
            mkdir -p 05-REPORTS/weekly
            mv seo-report-$DATE.md 05-REPORTS/weekly/
            git add 05-REPORTS/weekly/
            git commit -m "Weekly SEO Report - $DATE" || echo "No changes to commit"
            git push || echo "Nothing to push"
          fi

      - name: Trigger Optimization (if needed)
        if: env.NEEDS_OPTIMIZATION == 'true'
        run: |
          echo "=== Optimization Required ==="
          echo "Performance issues detected. Creating optimization issue..."

          # This would create a GitHub issue for manual review
          # In a more advanced setup, this could trigger actual code changes
